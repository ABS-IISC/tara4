<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-Prism - Document Analysis and Review Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 25%, #ec4899 50%, #f59e0b 75%, #10b981 100%);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            background-attachment: fixed;
            color: #333;
            line-height: 1.6;
            transition: all 0.3s ease;
            min-height: 100vh;
        }
        
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="50" cy="50" r="1" fill="%23ffffff" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            pointer-events: none;
            z-index: -1;
        }

        .container {
            max-width: 100vw;
            width: 100%;
            margin: 0;
            padding: 5px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 0;
            box-shadow: none;
            backdrop-filter: blur(10px);
            min-height: 100vh;
        }

        @media (min-width: 768px) {
            .container {
                padding: 15px;
                border-radius: 20px;
                margin: 10px auto;
                max-width: 98vw;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
                min-height: calc(100vh - 20px);
            }
        }
        
        @media (min-width: 1200px) {
            .container {
                max-width: 95vw;
                margin: 20px auto;
                padding: 20px;
            }
        }

        .header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 50%, #ec4899 100%);
            color: white;
            padding: 35px;
            border-radius: 20px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .header h1 {
            font-size: 2.8em;
            margin-bottom: 15px;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            animation: titleGlow 3s ease-in-out infinite alternate;
        }
        
        @keyframes titleGlow {
            from { filter: brightness(1); }
            to { filter: brightness(1.2); }
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary { background: linear-gradient(135deg, #4f46e5, #7c3aed); color: white; }
        .btn-success { background: linear-gradient(135deg, #10b981, #059669); color: white; }
        .btn-danger { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }
        .btn-info { background: linear-gradient(135deg, #06b6d4, #0891b2); color: white; }
        .btn-warning { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; }
        .btn-secondary { background: linear-gradient(135deg, #6b7280, #4b5563); color: white; }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            filter: brightness(1.1);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            background: white;
            margin-bottom: 30px;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            border-color: #764ba2;
            background: #f8f9ff;
        }

        .upload-area.dragover {
            border-color: #2ecc71;
            background: #f0fff4;
        }

        .file-input {
            display: none;
        }

        .progress-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #ecf0f1;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }

        .statistics {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            background: #f8f9ff;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .stat-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 30px;
            height: calc(100vh - 300px);
            min-height: 800px;
        }

        @media (min-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr 1fr;
                gap: 15px;
            }
        }

        @media (min-width: 768px) and (max-width: 1023px) {
            .main-content {
                grid-template-columns: 1fr 1fr;
                gap: 15px;
            }
        }

        .panel {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        .panel-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            font-size: 1.2em;
            font-weight: 500;
        }

        .panel-content {
            padding: 0;
            height: calc(100vh - 350px);
            min-height: 700px;
            max-height: 900px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .document-header {
            position: sticky;
            top: 0;
            background: white;
            border-bottom: 2px solid #ecf0f1;
            padding: 15px;
            z-index: 10;
        }

        .document-content-scroll {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .feedback-header {
            position: sticky;
            top: 0;
            background: white;
            border-bottom: 2px solid #ecf0f1;
            padding: 15px;
            z-index: 10;
        }

        .feedback-content-scroll {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .custom-feedback-fixed {
            position: sticky;
            bottom: 0;
            background: white;
            border-top: 2px solid #ecf0f1;
            padding: 15px;
            z-index: 10;
        }

        .section-nav {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .section-select {
            flex: 1;
            min-width: 200px;
            padding: 10px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-size: 14px;
        }

        .risk-indicator {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9em;
        }

        .risk-high { background: #e74c3c; color: white; }
        .risk-medium { background: #f39c12; color: white; }
        .risk-low { background: #2ecc71; color: white; }

        .feedback-item {
            background: #f8f9ff;
            border-left: 4px solid #667eea;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .feedback-item:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .feedback-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .feedback-meta {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .feedback-type {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: 600;
            text-transform: uppercase;
        }

        .type-critical { background: #e74c3c; color: white; }
        .type-important { background: #f39c12; color: white; }
        .type-suggestion { background: #3498db; color: white; }

        .feedback-actions {
            display: flex;
            gap: 8px;
            margin-top: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .feedback-actions .btn {
            font-size: 12px;
            padding: 6px 12px;
            border-radius: 6px;
            transition: all 0.2s ease;
        }
        
        .feedback-actions .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
        }
        
        .ai-custom-feedback {
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                max-height: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                max-height: 500px;
                transform: translateY(0);
            }
        }

        .tabs {
            display: flex;
            background: #ecf0f1;
            border-radius: 10px 10px 0 0;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 10px 10px 0 0;
        }

        .tab.active {
            background: white;
            color: #667eea;
            font-weight: 600;
        }

        .tab-content {
            display: none;
            padding: 0;
            height: 100%;
            overflow: hidden;
            background: #ffffff;
        }

        .tab-content.active {
            display: flex;
            flex-direction: column;
        }

        .chat-container {
            height: 600px;
            border: 1px solid #ecf0f1;
            border-radius: 10px;
            overflow-y: auto;
            padding: 15px;
            margin-bottom: 0;
            background: #fafafa;
        }
        
        .thinking-indicator {
            display: none;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: linear-gradient(135deg, #f8f9ff 0%, #e3f2fd 100%);
            border-radius: 12px;
            margin: 10px;
            border: 2px solid #4f46e5;
            animation: pulse 2s infinite;
        }
        
        .thinking-dots {
            display: flex;
            gap: 4px;
        }
        
        .thinking-dot {
            width: 8px;
            height: 8px;
            background: #4f46e5;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out;
        }
        
        .thinking-dot:nth-child(1) { animation-delay: -0.32s; }
        .thinking-dot:nth-child(2) { animation-delay: -0.16s; }
        .thinking-dot:nth-child(3) { animation-delay: 0s; }
        
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        .chat-message {
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 10px;
            max-width: 80%;
        }

        .chat-message.user {
            background: #667eea;
            color: white;
            margin-left: auto;
        }

        .chat-message.assistant {
            background: white;
            border: 1px solid #ecf0f1;
        }

        .chat-input-container {
            display: flex;
            gap: 15px;
            align-items: center;
            background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(248,250,252,0.95));
            border-top: 3px solid #4f46e5;
            padding: 20px;
            border-radius: 0 0 15px 15px;
            margin-top: 0;
        }

        .chat-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-size: 14px;
        }

        .custom-feedback-form {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #95a5a6;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1001;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success { background: #2ecc71; }
        .notification.error { background: #e74c3c; }
        .notification.info { background: #3498db; }

        /* Dark mode styles - Complete dark mode coverage */
        body.dark-mode {
            background: #0d1117 !important;
            color: #f0f6fc !important;
        }

        body.dark-mode::before {
            display: none;
        }

        .dark-mode .container {
            background: #161b22 !important;
            border: 1px solid #30363d !important;
            color: #f0f6fc !important;
        }

        .dark-mode .header {
            background: linear-gradient(135deg, #21262d 0%, #30363d 100%) !important;
            color: #f0f6fc !important;
        }

        .dark-mode .panel,
        .dark-mode .statistics,
        .dark-mode .upload-area,
        .dark-mode .progress-container {
            background: #21262d !important;
            border: 1px solid #30363d !important;
            color: #f0f6fc !important;
        }

        .dark-mode .stat-item {
            background: #30363d !important;
            color: #f0f6fc !important;
        }

        .dark-mode .btn {
            background: #238636 !important;
            border: 1px solid #30363d !important;
            color: #f0f6fc !important;
        }

        .dark-mode .btn:hover {
            background: #2ea043 !important;
        }

        .dark-mode .feedback-item {
            background: #21262d !important;
            border-left-color: #667eea !important;
            color: #f0f6fc !important;
        }

        .dark-mode .chat-container {
            background: #0d1117 !important;
            border: 1px solid #30363d !important;
            color: #f0f6fc !important;
        }

        .dark-mode .chat-message.assistant {
            background: #21262d !important;
            border: 1px solid #30363d !important;
            color: #f0f6fc !important;
        }

        .dark-mode .chat-message.user {
            background: #1f6feb !important;
            color: #ffffff !important;
        }

        .dark-mode .form-input,
        .dark-mode .form-select,
        .dark-mode .form-textarea,
        .dark-mode .section-select,
        .dark-mode .chat-input {
            background: #21262d !important;
            border: 1px solid #30363d !important;
            color: #f0f6fc !important;
        }

        .dark-mode .form-input:focus,
        .dark-mode .form-select:focus,
        .dark-mode .form-textarea:focus,
        .dark-mode .section-select:focus,
        .dark-mode .chat-input:focus {
            border-color: #1f6feb !important;
            outline: none !important;
        }

        .dark-mode .modal {
            background: rgba(0, 0, 0, 0.8) !important;
        }

        .dark-mode .modal-content {
            background: #0d1117 !important;
            color: #f0f6fc !important;
            border: 1px solid #30363d !important;
        }

        .dark-mode .modal-header {
            border-bottom: 2px solid #30363d !important;
        }

        .dark-mode .modal-close {
            color: #f0f6fc !important;
        }

        .dark-mode .modal-close:hover {
            color: #1f6feb !important;
        }

        .dark-mode .tab {
            background: #21262d !important;
            color: #f0f6fc !important;
            border: 1px solid #30363d !important;
        }

        .dark-mode .tab.active {
            background: #0d1117 !important;
            color: #1f6feb !important;
            border-bottom: 2px solid #1f6feb !important;
        }

        .dark-mode .tabs {
            background: #30363d !important;
        }

        .dark-mode .custom-feedback-form {
            background: #21262d !important;
            border: 1px solid #30363d !important;
            color: #f0f6fc !important;
        }

        .dark-mode .document-header,
        .dark-mode .feedback-header,
        .dark-mode .custom-feedback-fixed {
            background: #0d1117 !important;
            border-color: #30363d !important;
            color: #f0f6fc !important;
        }

        .dark-mode .document-progress {
            background: #0d1117 !important;
            border: 1px solid #30363d !important;
            color: #f0f6fc !important;
        }

        .dark-mode .form-label {
            color: #f0f6fc !important;
        }


        .dark-mode .dashboard-card {
            background: #21262d !important;
            border: 1px solid #30363d !important;
            color: #f0f6fc !important;
        }

        .dark-mode .notification {
            background: #21262d !important;
            border: 1px solid #30363d !important;
            color: #f0f6fc !important;
        }

        .dark-mode .notification.success {
            background: #238636 !important;
            color: #ffffff !important;
        }

        .dark-mode .notification.error {
            background: #da3633 !important;
            color: #ffffff !important;
        }

        .dark-mode .notification.info {
            background: #1f6feb !important;
            color: #ffffff !important;
        }

        .dark-mode .loading-overlay {
            background: rgba(13, 17, 23, 0.9) !important;
        }

        .dark-mode .loading-content {
            background: rgba(33, 38, 45, 0.9) !important;
            color: #f0f6fc !important;
            border: 1px solid #30363d !important;
        }

        .dark-mode .shortcut-key {
            background: #30363d !important;
            color: #f0f6fc !important;
        }

        .dark-mode table th,
        .dark-mode table td {
            border-bottom: 1px solid #30363d !important;
            color: #f0f6fc !important;
        }

        .dark-mode table th {
            background: #21262d !important;
        }

        .dark-mode .panel-header {
            background: linear-gradient(135deg, #21262d 0%, #30363d 100%) !important;
            color: #f0f6fc !important;
        }

        .dark-mode #analysisProgressPanel {
            background: #0d1117 !important;
            border: 1px solid #30363d !important;
            color: #f0f6fc !important;
        }

        .dark-mode #analysisProgressPanel h3 {
            color: #1f6feb !important;
        }

        .dark-mode #progressBar {
            background: #30363d !important;
        }

        .dark-mode #sectionProgress {
            background: #21262d !important;
            border: 1px solid #30363d !important;
            color: #f0f6fc !important;
        }

        .dark-mode #progressText,
        .dark-mode #progressSubtext {
            color: #f0f6fc !important;
        }

        .dark-mode .upload-area:hover {
            background: #21262d !important;
            border-color: #1f6feb !important;
        }

        .dark-mode .upload-area.dragover {
            background: #0d1117 !important;
            border-color: #238636 !important;
        }

        .dark-mode .risk-indicator {
            color: #ffffff !important;
        }

        .dark-mode .feedback-type {
            color: #ffffff !important;
        }

        .dark-mode .stat-number {
            color: #1f6feb !important;
        }

        .dark-mode .stat-label {
            color: #8b949e !important;
        }

        .dark-mode .tab-content {
            background: #0d1117 !important;
            color: #f0f6fc !important;
        }

        .dark-mode .panel-content {
            background: #0d1117 !important;
            color: #f0f6fc !important;
        }

        /* Keep document content white in dark mode for better highlight visibility */
        .dark-mode #documentContent {
            background: #ffffff !important;
            color: #000000 !important;
            border: 2px solid #30363d !important;
        }
        
        .dark-mode #documentContent .document-inner {
            background: #ffffff !important;
            color: #000000 !important;
        }
        
        .dark-mode #documentContent div {
            background: #ffffff !important;
            color: #000000 !important;
        }
        
        .dark-mode #documentContent h1 {
            color: #000000 !important;
            border-bottom-color: #cccccc !important;
        }
        
        .dark-mode #documentContent p {
            color: #000000 !important;
        }
        
        .dark-mode #documentContent #documentText {
            background: #ffffff !important;
            color: #000000 !important;
        }

        .dark-mode #documentContent button {
            background: #1f6feb !important;
            color: #ffffff !important;
            border: 1px solid #1f6feb !important;
        }

        .dark-mode .controls {
            background: transparent !important;
        }

        .dark-mode .btn-primary {
            background: #1f6feb !important;
            border-color: #1f6feb !important;
        }

        .dark-mode .btn-success {
            background: #238636 !important;
            border-color: #238636 !important;
        }

        .dark-mode .btn-danger {
            background: #da3633 !important;
            border-color: #da3633 !important;
        }

        .dark-mode .btn-warning {
            background: #fb8500 !important;
            border-color: #fb8500 !important;
        }

        .dark-mode .btn-info {
            background: #1f6feb !important;
            border-color: #1f6feb !important;
        }

        .dark-mode .btn-secondary {
            background: #6e7681 !important;
            border-color: #6e7681 !important;
        }

        .dark-mode .btn:disabled {
            background: #30363d !important;
            color: #6e7681 !important;
            border-color: #30363d !important;
        }

        /* Fix specific white background issues from images */
        .dark-mode .custom-feedback-panel {
            background: #21262d !important;
            border: 1px solid #30363d !important;
            color: #f0f6fc !important;
        }

        .dark-mode .custom-feedback-section {
            background: #21262d !important;
            color: #f0f6fc !important;
        }

        .dark-mode .custom-feedback-section h3 {
            color: #1f6feb !important;
        }

        .dark-mode #allCustomFeedback {
            background: #21262d !important;
            border: 1px solid #30363d !important;
            color: #f0f6fc !important;
        }

        .dark-mode #customFeedbackList {
            background: #21262d !important;
            color: #f0f6fc !important;
        }

        .dark-mode #userFeedbackDisplay {
            background: #21262d !important;
            color: #f0f6fc !important;
        }

        .dark-mode .user-feedback {
            background: #21262d !important;
            border: 1px solid #30363d !important;
            color: #f0f6fc !important;
        }

        /* Fix upload area sections */
        .dark-mode .upload-area div {
            background: #21262d !important;
            border-color: #30363d !important;
            color: #f0f6fc !important;
        }

        .dark-mode .upload-area h3,
        .dark-mode .upload-area h4,
        .dark-mode .upload-area p {
            color: #f0f6fc !important;
        }

        /* Fix any remaining white backgrounds */
        .dark-mode * {
            scrollbar-color: #30363d #21262d;
        }

        .dark-mode ::-webkit-scrollbar {
            width: 8px;
            background: #21262d;
        }

        .dark-mode ::-webkit-scrollbar-thumb {
            background: #30363d;
            border-radius: 4px;
        }

        .dark-mode ::-webkit-scrollbar-thumb:hover {
            background: #484f58;
        }
        
        /* Text Highlighting Styles */
        .text-highlight {
            position: relative;
            transition: all 0.2s ease;
        }
        
        .text-highlight:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            transform: translateY(-1px);
        }
        
        .highlight-tools {
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .highlight-tools button {
            transition: all 0.2s ease;
        }
        
        .highlight-tools button:hover {
            transform: scale(1.05);
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }
        
        /* Selection styling */
        ::selection {
            background: rgba(79, 70, 229, 0.3);
        }
        
        ::-moz-selection {
            background: rgba(79, 70, 229, 0.3);
        }
        
        /* Dark mode highlighting - keep highlights visible on white document background */
        .dark-mode .text-highlight {
            border: 2px solid rgba(0,0,0,0.4) !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3) !important;
        }
        
        .dark-mode .highlight-tools {
            background: linear-gradient(135deg, #21262d 0%, #30363d 100%) !important;
            border: 2px solid #1f6feb !important;
            color: #f0f6fc !important;
        }
        
        .dark-mode .highlight-tools span {
            color: #f0f6fc !important;
        }
        
        .dark-mode .highlight-tools button {
            border: 1px solid #30363d !important;
        }

        /* Document content stays white in dark mode for highlight visibility */
        .dark-mode #documentContent,
        .dark-mode #documentContent .document-inner,
        .dark-mode #documentContent #documentText {
            background: #ffffff !important;
            color: #000000 !important;
        }
        
        .dark-mode .expanded-document,
        .dark-mode .expanded-document .document-inner,
        .dark-mode .expanded-document #documentText {
            background: #ffffff !important;
            color: #000000 !important;
        }
        
        /* Additional dark mode fixes for specific elements */
        .dark-mode .all-custom-feedback {
            background: #21262d !important;
            border: 1px solid #30363d !important;
            color: #f0f6fc !important;
        }

        .dark-mode .custom-feedback-list {
            background: #21262d !important;
            color: #f0f6fc !important;
        }

        .dark-mode .custom-feedback-list > div {
            background: #30363d !important;
            border: 1px solid #484f58 !important;
            color: #f0f6fc !important;
        }

        /* Fix upload area inner divs */
        .dark-mode .upload-area > div {
            background: #30363d !important;
            border-color: #484f58 !important;
            color: #f0f6fc !important;
        }
        
        .dark-mode .upload-area > div > div {
            background: #21262d !important;
            border-color: #30363d !important;
            color: #f0f6fc !important;
        }
        
        .dark-mode .upload-area h4 {
            color: #1f6feb !important;
        }
        
        /* Dark mode for expanded document */
        .dark-mode .expanded-document {
            background: #21262d !important;
            color: #f0f6fc !important;
        }
        
        .dark-mode .expanded-document .document-inner {
            background: #21262d !important;
            color: #f0f6fc !important;
        }
        
        .dark-mode .expanded-document h1 {
            color: #f0f6fc !important;
        }
        
        .dark-mode .expanded-document p {
            color: #f0f6fc !important;
        }
        
        .dark-mode .expanded-document div {
            color: #f0f6fc !important;
        }

        /* Override inline styles in dark mode */
        .dark-mode [style*="background: linear-gradient"] {
            background: #21262d !important;
        }

        .dark-mode [style*="background: rgba(255"] {
            background: #21262d !important;
        }

        .dark-mode [style*="background: #f8f9ff"] {
            background: #21262d !important;
        }

        .dark-mode [style*="background: #f8f9fa"] {
            background: #21262d !important;
        }

        .dark-mode [style*="background: white"] {
            background: #21262d !important;
        }

        .dark-mode [style*="background: #ffffff"] {
            background: #21262d !important;
        }

        /* Enhanced Mobile and Tablet Responsive Design */
        /* Mobile responsive for upload area */
        @media (max-width: 768px) {
            .upload-area > div {
                flex-direction: column !important;
                gap: 15px !important;
            }
            
            .upload-area > div > div {
                min-height: auto !important;
            }
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 5px;
                margin: 0;
                border-radius: 0;
                width: 100vw;
                max-width: 100vw;
            }
            
            .header h1 {
                font-size: 1.5em;
            }
            
            .header p {
                font-size: 0.9em;
            }
            
            .main-content {
                grid-template-columns: 1fr;
                gap: 10px;
                height: auto;
            }
            
            .panel-content {
                height: 400px;
            }
            
            .document-content-scroll,
            .feedback-content-scroll {
                padding: 10px;
            }
            
            .document-header,
            .feedback-header,
            .custom-feedback-fixed {
                padding: 10px;
            }
            
            .controls {
                flex-direction: column;
                gap: 10px;
                width: 100%;
                justify-content: center;
            }
            
            .btn {
                width: 100%;
                margin: 5px 0;
                min-height: 44px;
                font-size: 14px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .upload-area {
                padding: 10px;
                margin: 5px;
            }
            
            .upload-area h3 {
                font-size: 1em;
            }
            
            .modal-content {
                width: 95vw;
                margin: 10px;
                max-height: 90vh;
                padding: 15px;
            }
            
            .custom-feedback-form {
                padding: 10px;
            }
            
            .custom-feedback-form h4 {
                font-size: 1em;
            }
        }
        
        @media (min-width: 481px) and (max-width: 768px) {
            .container {
                padding: 10px;
                margin: 10px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .main-content {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .panel-content {
                height: 500px;
            }
            
            .controls {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .stats-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .document-content-scroll,
            .feedback-content-scroll {
                padding: 15px;
            }
        }
        
        @media (min-width: 769px) and (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr 1fr;
                gap: 15px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(5, 1fr);
            }
            
            .panel-content {
                height: calc(100vh - 300px);
                min-height: 700px;
            }
        }
        
        @media (min-width: 1025px) {
            .container {
                max-width: 95vw;
                margin: 20px auto;
                padding: 20px;
            }
            
            .main-content {
                gap: 20px;
            }
            
            .panel-content {
                height: calc(100vh - 300px);
                min-height: 800px;
            }
        }

        /* Loading animation with funny GIFs */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }

        .loading-content {
            text-align: center;
            color: white;
            background: rgba(255, 255, 255, 0.1);
            padding: 40px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            max-width: 500px;
            width: 90%;
        }

        .loading-gif {
            width: 200px;
            height: 200px;
            border-radius: 15px;
            margin: 0 auto 20px auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            display: block;
        }

        .document-progress {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            z-index: 10000;
            max-width: 600px;
            width: 90%;
            text-align: center;
            display: none;
        }

        .progress-gif {
            width: 150px;
            height: 150px;
            margin: 0 auto 20px auto;
            border-radius: 10px;
            display: block;
        }

        .loading-text {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 10px;
            animation: pulse 2s infinite;
        }

        .loading-subtext {
            font-size: 1em;
            opacity: 0.8;
        }

        @keyframes pulse {
            0%, 100% { 
                opacity: 1;
                transform: scale(1);
            }
            50% { 
                opacity: 0.8;
                transform: scale(1.05);
            }
        }

        @keyframes progress {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Touch-friendly mobile styles */
        @media (max-width: 768px) {
            .btn {
                min-height: 44px;
                font-size: 16px;
            }
            
            .form-input, .form-select, .form-textarea {
                min-height: 44px;
                font-size: 16px;
            }
            
            .chat-input {
                min-height: 44px;
                font-size: 16px;
            }
            
            .feedback-actions .btn {
                min-width: 80px;
                margin: 5px;
            }
        }

        /* Keyboard shortcuts indicator */
        .shortcut-key {
            background: #ecf0f1;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.8em;
        }

        .dark-mode .shortcut-key {
            background: #444;
            color: #e0e0e0;
        }
        
        
        /* Dashboard styles */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .dashboard-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .chart-container {
            width: 100%;
            height: 300px;
            margin: 20px 0;
        }
        
        /* Revert button styles */
        .revert-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            margin-left: 10px;
        }
        
        .revert-btn:hover {
            background: #c0392b;
        }
        
        /* Enhanced Help System Styles */
        .feature-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 15px;
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            border-radius: 10px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }
        
        .feature-header:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 70, 229, 0.3);
        }
        
        .toggle-icon {
            font-size: 1.2em;
            transition: transform 0.3s ease;
        }
        
        .feature-content {
            display: block;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9ff 0%, #e3f2fd 100%);
            border-radius: 10px;
            border: 2px solid #4f46e5;
            margin-bottom: 20px;
        }
        
        .feature-intro {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #4f46e5;
        }
        
        .shortcuts-categories {
            display: grid;
            gap: 20px;
        }
        
        .shortcut-category {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        
        .shortcuts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .shortcut-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: #f8f9ff;
            border-radius: 8px;
            border-left: 3px solid #4f46e5;
        }
        
        .shortcut-item kbd {
            background: #4f46e5;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: bold;
            min-width: 30px;
            text-align: center;
        }
        
        .shortcut-item small {
            color: #666;
            font-size: 0.8em;
            display: block;
            margin-top: 2px;
        }
        
        .feature-tips {
            background: rgba(79, 70, 229, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .tutorial-progress {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #ecf0f1;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4f46e5, #7c3aed);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .tutorial-steps {
            display: grid;
            gap: 15px;
        }
        
        .tutorial-step {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #ddd;
            transition: all 0.3s ease;
        }
        
        .tutorial-step.active {
            border-left-color: #4f46e5;
            box-shadow: 0 3px 15px rgba(79, 70, 229, 0.2);
        }
        
        .tutorial-step.completed {
            border-left-color: #2ecc71;
            opacity: 0.8;
        }
        
        .step-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .step-number {
            background: #4f46e5;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .step-status {
            margin-left: auto;
            font-size: 0.9em;
            font-weight: 600;
        }
        
        .step-features, .step-options {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        
        .feature-badge, .option-tag {
            background: #4f46e5;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
        }
        
        .step-shortcuts {
            background: #f8f9ff;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            margin-top: 10px;
            font-family: monospace;
        }
        
        .chat-examples {
            display: grid;
            gap: 8px;
            margin-top: 10px;
        }
        
        .example-question {
            background: #e3f2fd;
            padding: 8px 12px;
            border-radius: 15px;
            font-style: italic;
            color: #1976d2;
        }
        
        .tutorial-navigation {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }
        
        .tutorial-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .tutorial-btn.primary {
            background: #4f46e5;
            color: white;
        }
        
        .tutorial-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }
        
        .faq-search {
            margin-bottom: 20px;
        }
        
        .faq-search input {
            width: 100%;
            padding: 12px;
            border: 2px solid #4f46e5;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .faq-categories {
            display: grid;
            gap: 20px;
        }
        
        .faq-category {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        
        .faq-list {
            display: grid;
            gap: 10px;
            margin-top: 15px;
        }
        
        .faq-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .faq-item:hover {
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        
        .faq-question {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f8f9ff;
            font-weight: 600;
        }
        
        .faq-toggle {
            font-size: 1.2em;
            color: #4f46e5;
        }
        
        .faq-answer {
            padding: 15px;
            background: white;
            display: none;
        }
        
        .faq-tip {
            background: rgba(79, 70, 229, 0.1);
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }
        
        .analysis-features {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin: 10px 0;
        }
        
        .faq-footer {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin-top: 20px;
        }
        
        .pattern-dashboard, .logs-dashboard, .learning-dashboard {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .pattern-stats, .logs-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        
        .pattern-stat, .log-stat {
            text-align: center;
            padding: 15px;
            background: #f8f9ff;
            border-radius: 8px;
        }
        
        .stat-number, .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #4f46e5;
        }
        
        .stat-label {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }
        
        .pattern-categories {
            display: grid;
            gap: 20px;
        }
        
        .pattern-category {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        
        .pattern-feature {
            display: flex;
            gap: 15px;
            align-items: flex-start;
        }
        
        .feature-icon {
            font-size: 2em;
            background: #f8f9ff;
            padding: 10px;
            border-radius: 50%;
            min-width: 60px;
            text-align: center;
        }
        
        .feature-examples {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        
        .example-tag {
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
        }
        
        .trend-indicators {
            margin-top: 10px;
        }
        
        .trend-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
        }
        
        .pattern-actions, .logs-actions, .learning-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }
        
        .pattern-btn, .logs-btn, .learning-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            background: #4f46e5;
            color: white;
            transition: all 0.3s ease;
        }
        
        .pattern-btn:hover, .logs-btn:hover, .learning-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(79, 70, 229, 0.3);
        }
        
        .logs-recent {
            background: white;
            padding: 20px;
            border-radius: 10px;
        }
        
        .recent-logs {
            margin-top: 15px;
        }
        
        .log-entry {
            display: flex;
            gap: 15px;
            padding: 10px;
            background: #f8f9ff;
            border-radius: 8px;
            margin-bottom: 8px;
        }
        
        .log-time {
            font-family: monospace;
            color: #666;
            min-width: 80px;
        }
        
        .log-action {
            font-weight: 600;
            color: #4f46e5;
        }
        
        .log-details {
            color: #666;
            flex: 1;
        }
        
        .learning-progress {
            display: flex;
            gap: 30px;
            align-items: center;
        }
        
        .progress-circle {
            position: relative;
            width: 120px;
            height: 120px;
        }
        
        .progress-ring {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: conic-gradient(#4f46e5 0deg, #e3f2fd 0deg);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .progress-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }
        
        .progress-percent {
            font-size: 1.5em;
            font-weight: bold;
            color: #4f46e5;
            display: block;
        }
        
        .progress-label {
            font-size: 0.8em;
            color: #666;
        }
        
        .learning-stats {
            flex: 1;
            display: grid;
            gap: 15px;
        }
        
        .learning-stat {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background: #f8f9ff;
            border-radius: 8px;
        }
        
        .learning-tips {
            background: rgba(79, 70, 229, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .learning-tips ul {
            margin-top: 10px;
            padding-left: 20px;
        }
        
        .learning-tips li {
            margin-bottom: 8px;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1> AI-Prism Document Analysis and Review Tool</h1>
            <p>AI-Powered Analysis with Hawkeye Investigation Framework</p>
            <p style="font-size: 0.9em; opacity: 0.8; margin-top: 10px;">Professional Document Review and Quality Assurance</p>
        </div>

        <!-- Dark Mode Toggle in Corner -->
        <div style="position: fixed; top: 20px; right: 20px; z-index: 1000;">
            <button class="btn btn-secondary" onclick="toggleDarkMode()" id="darkModeToggle"> Dark Mode</button>
        </div>

        <!-- Controls -->
        <div class="controls">
            <button class="btn btn-info" onclick="showShortcuts()"> Shortcuts</button>
            <button class="btn btn-info" onclick="showTutorial()"> Tutorial</button>
            <button class="btn btn-info" onclick="showFAQ()"> FAQs</button>
            <button class="btn btn-info" onclick="showPatterns()"> Patterns</button>
            <button class="btn btn-info" onclick="showLogs()"> Logs</button>
            <button class="btn btn-info" onclick="showLearning()"> Learning</button>
            <button class="btn btn-primary" onclick="showTextHighlightingFeature()" title="Learn how to use text highlighting and commenting features"> Text Highlighting Feature</button>
            <button class="btn btn-info" onclick="showCustomFeedbackHelp()" title="Learn how to add custom feedback to AI suggestions"> Custom Feedback Help</button>
            <button class="btn btn-warning" onclick="resetSession()"> Reset</button>
        </div>

        <!-- Upload Area - Always Visible -->
        <div class="upload-area" id="uploadArea" style="padding: 20px; background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); border: 3px solid #4f46e5; box-shadow: 0 10px 30px rgba(79, 70, 229, 0.15);">
            <div style="text-align: center; margin-bottom: 15px;">
                <h3 style="margin: 0; font-size: 1.5em; background: linear-gradient(45deg, #4f46e5, #10b981); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-weight: 800;"> Upload Documents</h3>
                <p style="margin: 5px 0 0 0; color: #6b7280; font-size: 1em; font-weight: 500;">Professional Document Analysis with AI-Prism Intelligence</p>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr 250px; gap: 15px; width: 100%; align-items: stretch;">
                <!-- Main Document Upload -->
                <div style="padding: 15px; border: 3px solid #4f46e5; border-radius: 12px; background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); min-height: 120px; display: flex; flex-direction: column; justify-content: space-between; box-shadow: 0 5px 15px rgba(79, 70, 229, 0.1); transition: transform 0.3s ease, box-shadow 0.3s ease;" onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 10px 25px rgba(79, 70, 229, 0.2)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 5px 15px rgba(79, 70, 229, 0.1)'">
                    <div style="text-align: center;">
                        <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #4f46e5, #7c3aed); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px auto; box-shadow: 0 3px 10px rgba(79, 70, 229, 0.3);">
                            <span style="font-size: 18px; color: white;"></span>
                        </div>
                        <h4 style="margin: 0 0 5px 0; font-size: 1.1em; color: #4f46e5; font-weight: 700;">Analysis Document</h4>
                        <p style="margin: 0 0 10px 0; font-size: 0.85em; color: #6b7280; line-height: 1.3;">Upload .docx file for AI analysis</p>
                    </div>
                    <div>
                        <input type="file" id="fileInput" class="file-input" accept=".docx">
                        <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()" style="padding: 8px 15px; font-size: 0.9em; width: 100%; border-radius: 20px; font-weight: 600; box-shadow: 0 3px 10px rgba(79, 70, 229, 0.3); transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 5px 15px rgba(79, 70, 229, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 3px 10px rgba(79, 70, 229, 0.3)'">
                             Choose Document
                        </button>
                        <div id="analysisFileName" style="margin-top: 8px; color: #10b981; font-size: 0.8em; word-break: break-all; font-weight: 600; text-align: center;"></div>
                    </div>
                </div>
                
                <!-- Guidelines Document Upload -->
                <div style="padding: 15px; border: 3px dashed #10b981; border-radius: 12px; background: linear-gradient(135deg, #ffffff 0%, #f0fdf4 100%); min-height: 120px; display: flex; flex-direction: column; justify-content: space-between; box-shadow: 0 5px 15px rgba(16, 185, 129, 0.1); transition: transform 0.3s ease, box-shadow 0.3s ease;" onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 10px 25px rgba(16, 185, 129, 0.2)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 5px 15px rgba(16, 185, 129, 0.1)'">
                    <div style="text-align: center;">
                        <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px auto; box-shadow: 0 3px 10px rgba(16, 185, 129, 0.3);">
                            <span style="font-size: 18px; color: white;"></span>
                        </div>
                        <h4 style="margin: 0 0 5px 0; font-size: 1.1em; color: #10b981; font-weight: 700;">Guidelines (Optional)</h4>
                        <p style="margin: 0 0 10px 0; font-size: 0.85em; color: #6b7280; line-height: 1.3;">Upload custom guidelines</p>
                    </div>
                    <div>
                        <input type="file" id="guidelinesInput" class="file-input" accept=".docx">
                        <button class="btn btn-success" onclick="document.getElementById('guidelinesInput').click()" style="padding: 8px 15px; font-size: 0.9em; width: 100%; border-radius: 20px; font-weight: 600; box-shadow: 0 3px 10px rgba(16, 185, 129, 0.3); transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 5px 15px rgba(16, 185, 129, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 3px 10px rgba(16, 185, 129, 0.3)'">
                             Choose Guidelines
                        </button>
                        <div id="guidelinesFileName" style="margin-top: 8px; color: #10b981; font-size: 0.8em; word-break: break-all; font-weight: 600; text-align: center;"></div>
                    </div>
                </div>
                
                <!-- Start Analysis Section -->
                <div style="padding: 15px; border: 3px solid #f59e0b; border-radius: 12px; background: linear-gradient(135deg, #ffffff 0%, #fffbeb 100%); min-height: 120px; display: flex; flex-direction: column; justify-content: center; align-items: center; box-shadow: 0 5px 15px rgba(245, 158, 11, 0.1); transition: transform 0.3s ease, box-shadow 0.3s ease;" onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 10px 25px rgba(245, 158, 11, 0.2)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 5px 15px rgba(245, 158, 11, 0.1)'">
                    <div style="text-align: center; width: 100%;">
                        <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #f59e0b, #d97706); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px auto; box-shadow: 0 5px 15px rgba(245, 158, 11, 0.3); animation: pulse 2s infinite;">
                            <span style="font-size: 20px; color: white;"></span>
                        </div>
                        <h4 style="margin: 0 0 10px 0; font-size: 1.1em; color: #f59e0b; font-weight: 800; text-transform: uppercase; letter-spacing: 1px;">Launch Analysis</h4>
                        <button class="btn btn-warning" id="startAnalysisBtn" onclick="startAnalysis()" disabled style="padding: 10px 15px; font-size: 0.9em; width: 100%; border-radius: 20px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; box-shadow: 0 5px 15px rgba(245, 158, 11, 0.3); transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 20px rgba(245, 158, 11, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 5px 15px rgba(245, 158, 11, 0.3)'">
                             Start Analysis
                        </button>
                        <p style="margin: 8px 0 0 0; font-size: 0.75em; color: #92400e; font-weight: 500; line-height: 1.2;">AI-Powered Intelligence Ready</p>
                    </div>
                </div>
            </div>
            
            <!-- Features Preview -->
            <div style="margin-top: 15px; padding: 15px; background: rgba(255, 255, 255, 0.7); border-radius: 12px; border: 2px solid rgba(79, 70, 229, 0.2);">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; text-align: center;">
                    <div style="padding: 10px;">
                        <div style="font-size: 1.5em; margin-bottom: 5px;"></div>
                        <h5 style="margin: 0 0 3px 0; color: #4f46e5; font-weight: 600; font-size: 0.9em;">Hawkeye Framework</h5>
                        <p style="margin: 0; font-size: 0.75em; color: #6b7280;">20-point analysis</p>
                    </div>
                    <div style="padding: 10px;">
                        <div style="font-size: 1.5em; margin-bottom: 5px;"></div>
                        <h5 style="margin: 0 0 3px 0; color: #10b981; font-weight: 600; font-size: 0.9em;">AI-Powered Intelligence</h5>
                        <p style="margin: 0; font-size: 0.75em; color: #6b7280;">Advanced AI model</p>
                    </div>
                    <div style="padding: 10px;">
                        <div style="font-size: 1.5em; margin-bottom: 5px;"></div>
                        <h5 style="margin: 0 0 3px 0; color: #f59e0b; font-weight: 600; font-size: 0.9em;">Real-time Analytics</h5>
                        <p style="margin: 0; font-size: 0.75em; color: #6b7280;">Interactive feedback</p>
                    </div>
                    <div style="padding: 10px;">
                        <div style="font-size: 1.5em; margin-bottom: 5px;"></div>
                        <h5 style="margin: 0 0 3px 0; color: #ec4899; font-weight: 600; font-size: 0.9em;">Professional Output</h5>
                        <p style="margin: 0; font-size: 0.75em; color: #6b7280;">Export-ready docs</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Progress -->
        <div class="progress-container" id="progressContainer" style="display: none;">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <p id="progressText">Processing document...</p>
        </div>

        <!-- Statistics -->
        <div class="statistics" id="statisticsPanel" style="display: none;">
            <div class="stats-grid" id="statsGrid">
                <!-- Statistics will be populated here -->
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content" id="mainContent" style="display: none;">
            <!-- Document Panel -->
            <div class="panel">
                <div class="panel-header">
                     Original Document
                </div>
                <div class="panel-content">
                    <div class="document-header">
                        <div class="section-nav">
                            <select class="section-select" id="sectionSelect">
                                <option value="">Select a section...</option>
                            </select>
                            <button class="btn btn-secondary" onclick="previousSection()"> Previous</button>
                            <button class="btn btn-secondary" onclick="nextSection()">Next </button>
                            <div class="risk-indicator" id="riskIndicator"></div>
                            <div id="customFeedbackCounter" style="background: #3498db; color: white; padding: 5px 10px; border-radius: 15px; font-size: 0.8em; font-weight: 600; display: none;">
                                 Custom: <span id="customCount">0</span>
                            </div>
                        </div>
                        <div class="zoom-controls" style="display: flex; gap: 10px; align-items: center; margin-top: 10px;">
                            <button class="btn btn-info" onclick="zoomOut()" style="padding: 5px 10px; font-size: 12px;"> Zoom Out</button>
                            <span id="zoomLevel" style="font-size: 12px; color: #666;">100%</span>
                            <button class="btn btn-info" onclick="zoomIn()" style="padding: 5px 10px; font-size: 12px;">+ Zoom In</button>
                            <button class="btn btn-secondary" onclick="resetZoom()" style="padding: 5px 10px; font-size: 12px;"> Reset</button>
                        </div>
                        
                        <!-- Text Highlighting Tools -->
                        <div class="highlight-tools" style="display: flex; gap: 8px; align-items: center; margin-top: 10px; padding: 10px; background: linear-gradient(135deg, #f8f9ff 0%, #e3f2fd 100%); border-radius: 8px; border: 2px solid #4f46e5; flex-wrap: wrap;">
                            <span style="font-weight: 600; color: #4f46e5; font-size: 12px;"> Highlight Tools:</span>
                            <button class="btn btn-warning color-btn" onclick="setHighlightColor('yellow')" style="padding: 4px 8px; font-size: 11px; background: #ffd700; color: #333; border: 2px solid #e6c200;"> Yellow</button>
                            <button class="btn btn-success color-btn" onclick="setHighlightColor('lightgreen')" style="padding: 4px 8px; font-size: 11px; background: #90ee90; color: #333; border: 2px solid #7dd87d;"> Green</button>
                            <button class="btn btn-info color-btn" onclick="setHighlightColor('lightblue')" style="padding: 4px 8px; font-size: 11px; background: #add8e6; color: #333; border: 2px solid #9ac5d3;"> Blue</button>
                            <button class="btn btn-danger color-btn" onclick="setHighlightColor('lightcoral')" style="padding: 4px 8px; font-size: 11px; background: #f08080; color: #333; border: 2px solid #dd6d6d;"> Red</button>
                            <button class="btn btn-secondary color-btn" onclick="setHighlightColor('lightgray')" style="padding: 4px 8px; font-size: 11px; background: #d3d3d3; color: #333; border: 2px solid #c0c0c0;"> Gray</button>
                            <button class="btn btn-primary" onclick="showAddCommentDialog()" style="padding: 4px 8px; font-size: 11px;"> Add Comment</button>
                            <button class="btn btn-info" onclick="showUpdateCommentsDialog()" style="padding: 4px 8px; font-size: 11px;"> Update Comments</button>
                            <button class="btn btn-secondary" onclick="clearAllHighlights()" style="padding: 4px 8px; font-size: 11px;"> Clear All</button>
                        </div>
                    </div>
                    <div class="document-content-scroll">
                        <div id="documentContent" style="font-family: 'Times New Roman', serif; line-height: 1.6; background: white; padding: 20px; border: 1px solid #ddd; border-radius: 5px; white-space: pre-wrap; font-size: 12pt; color: #000000; position: relative;">
                            <button onclick="expandDocument()" style="position: absolute; top: 10px; right: 10px; background: #667eea; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px;"> Expand</button>
                            <p>Upload a document to begin analysis...</p>
                        </div>
                        <div id="currentSectionName" style="display: none;"></div>
                    </div>
                </div>
            </div>

            <!-- Analysis Panel -->
            <div class="panel">
                <div class="tabs">
                    <div class="tab active" onclick="switchTab('feedback')"> Feedback</div>
                    <div class="tab" onclick="switchTab('chat')">AI-Prism Chat</div>
                </div>
                
                <!-- Feedback Tab -->
                <div class="tab-content active" id="feedbackTab">
                    <div class="feedback-content-scroll" style="display: flex; flex-direction: column;">
                        <!-- User Added Feedback Display - Show First -->
                        <div id="userFeedbackDisplay" style="margin-bottom: 20px; order: 1;">
                            <!-- User feedback will be displayed here -->
                        </div>
                        
                        <div id="feedbackContainer" style="order: 2;">
                            <p>Select a section to view AI-generated feedback...</p>
                        </div>
                        
                        <!-- Custom feedback form moved below main content -->
                    </div>
                </div>
                
                <!-- AI-Prism Chat Tab -->
                <div class="tab-content" id="chatTab">
                    <div class="feedback-content-scroll">
                        <div class="chat-container" id="chatContainer" style="background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); border: 2px solid #4f46e5; border-radius: 15px; padding: 10px; min-height: 400px; overflow-y: auto;">
                            <div class="chat-message assistant" style="background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); color: white; border-radius: 12px; padding: 20px; margin: 10px; box-shadow: 0 5px 15px rgba(79, 70, 229, 0.3);">
                                <strong> AI-Prism Your Intelligent Assistant:</strong><br><br>
                                <strong>Welcome to AI-Prism Professional Document Analysis</strong><br><br>
                                I'm your dedicated AI assistant for comprehensive document analysis and compliance validation. My expertise includes:<br><br>
                                <div style="margin: 10px 0; padding-left: 15px; position: relative;"><span style="position: absolute; left: 0;"></span><strong>In-depth Document Assessment</strong> - Thorough evaluation of content quality and structural integrity</div>
                                <div style="margin: 10px 0; padding-left: 15px; position: relative;"><span style="position: absolute; left: 0;"></span><strong>Hawkeye Framework Implementation</strong> - Strategic analysis using proven 20-point methodology</div>
                                <div style="margin: 10px 0; padding-left: 15px; position: relative;"><span style="position: absolute; left: 0;"></span><strong>Enhancement Recommendations</strong> - Actionable suggestions for content improvement</div>
                                <div style="margin: 10px 0; padding-left: 15px; position: relative;"><span style="position: absolute; left: 0;"></span><strong>Risk Evaluation</strong> - Clear identification and classification of potential issues</div>
                                <div style="margin: 10px 0; padding-left: 15px; position: relative;"><span style="position: absolute; left: 0;"></span><strong>Best Practice Guidance</strong> - Industry-standard recommendations for optimal results</div><br>
                                I'm ready to assist you in achieving document excellence through systematic analysis and professional guidance.<br><br>
                                <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 8px; margin-top: 15px; font-size: 0.9em;">
                                     <strong>Try asking me:</strong><br>
                                     "What does this feedback mean?"<br>
                                     "How can I improve this section?"<br>
                                     "Explain the Hawkeye framework"<br>
                                     "What are the risk levels?"<br>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="custom-feedback-fixed">
                        <!-- Thinking indicator -->
                        <div class="thinking-indicator" id="thinkingIndicator">
                            <div class="thinking-dots">
                                <div class="thinking-dot"></div>
                                <div class="thinking-dot"></div>
                                <div class="thinking-dot"></div>
                            </div>
                            <span style="color: #4f46e5; font-weight: 600;"> AI-Prism is thinking...</span>
                        </div>
                        
                        <div class="chat-input-container">
                            <div style="flex: 1; position: relative;">
                                <input type="text" class="chat-input" id="chatInput" placeholder="Ask AI-Prism about feedback, guidelines, or document analysis..." onkeypress="handleChatKeyPress(event)" style="width: 100%; padding: 15px 20px; border: 3px solid #4f46e5; border-radius: 25px; font-size: 14px; background: linear-gradient(135deg, #ffffff, #f8fafc); box-shadow: 0 5px 15px rgba(79, 70, 229, 0.1);">
                                <div style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #6b7280; font-size: 12px; pointer-events: none;">
                                    Press Enter 
                                </div>
                            </div>
                            <button class="btn btn-primary" onclick="sendChatMessage()" id="sendChatBtn" style="padding: 15px 25px; border-radius: 25px; font-weight: 600; box-shadow: 0 5px 15px rgba(79, 70, 229, 0.3);">
                                <span></span> Send
                            </button>
                        </div>
                        <div style="text-align: center; margin-top: 10px; font-size: 0.8em; color: #6b7280; padding: 0 20px 10px 20px;">
                            AI-Prism is powered by advanced AI and ready to help with your document analysis
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhanced Add Your Custom Feedback Section - Moved Below Main Content -->
        <div class="custom-feedback-panel" id="customFeedbackSection" style="background: linear-gradient(135deg, rgba(255,255,255,0.98), rgba(248,250,252,0.98)); backdrop-filter: blur(15px); border-radius: 25px; padding: 35px; margin: 25px 0; box-shadow: 0 15px 50px rgba(0,0,0,0.15); border: 3px solid rgba(79, 70, 229, 0.2); display: none;">
            <div class="custom-feedback-section">
                <h3 style="background: linear-gradient(45deg, #4f46e5, #10b981); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin: 0 0 25px 0; display: flex; align-items: center; gap: 12px; font-size: 1.5em; font-weight: 800;">
                     Add Your Custom Feedback
                </h3>
                <div class="custom-feedback-form" style="background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(248,250,252,0.9)); border: 2px solid #4f46e5; box-shadow: 0 8px 25px rgba(79, 70, 229, 0.15); margin: 0; border-radius: 15px; padding: 25px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label" style="font-weight: 700; color: #4f46e5; font-size: 1em; margin-bottom: 8px;"> Type:</label>
                            <select class="form-select" id="customType" style="border: 3px solid #4f46e5; border-radius: 12px; padding: 12px; background: linear-gradient(135deg, #ffffff, #f8fafc); font-weight: 600;">
                                <option value="suggestion">Suggestion</option>
                                <option value="important">Important</option>
                                <option value="critical">Critical</option>
                                <option value="positive">Positive</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label" style="font-weight: 700; color: #10b981; font-size: 1em; margin-bottom: 8px;"> Category:</label>
                            <select class="form-select" id="customCategory" style="border: 3px solid #10b981; border-radius: 12px; padding: 12px; background: linear-gradient(135deg, #ffffff, #f0fdf4); font-weight: 600;">
                                <option value="Initial Assessment">Initial Assessment</option>
                                <option value="Investigation Process">Investigation Process</option>
                                <option value="Root Cause Analysis">Root Cause Analysis</option>
                                <option value="Documentation and Reporting">Documentation and Reporting</option>
                                <option value="Seller Classification">Seller Classification</option>
                                <option value="Enforcement Decision-Making">Enforcement Decision-Making</option>
                                <option value="Quality Control">Quality Control</option>
                                <option value="Communication Standards">Communication Standards</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label class="form-label" style="font-weight: 700; color: #ec4899; font-size: 1em; margin-bottom: 8px;"> Your Feedback:</label>
                        <div style="position: relative;">
                            <textarea class="form-textarea" id="customDescription" placeholder="Share your insights, suggestions, or observations about this section..." style="border: 3px solid #ec4899; border-radius: 15px; min-height: 100px; padding: 15px; background: linear-gradient(135deg, #ffffff, #fdf2f8); font-size: 14px; line-height: 1.5;"></textarea>
                        </div>
                    </div>
                    <div style="text-align: center;">
                        <button class="btn btn-success" onclick="addCustomFeedback()" style="padding: 15px 35px; font-size: 16px; border-radius: 25px; box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4); font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">
                             Add My Feedback
                        </button>
                    </div>
                            
                    <!-- All Custom Feedback History -->
                    <div id="allCustomFeedback" class="all-custom-feedback" style="margin-top: 25px; max-height: 300px; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h5 style="background: linear-gradient(45deg, #4f46e5, #ec4899); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin: 0; font-size: 1.2em; font-weight: 700;"> All My Custom Feedback</h5>
                            <div>
                                <button onclick="refreshUserFeedbackList()" style="background: linear-gradient(135deg, #06b6d4, #0891b2); border: none; color: white; cursor: pointer; font-size: 12px; margin-right: 10px; padding: 8px 12px; border-radius: 8px; font-weight: 600;" title="Refresh list"></button>
                                <button onclick="showUserFeedbackManager()" style="background: linear-gradient(135deg, #f59e0b, #d97706); border: none; color: white; cursor: pointer; font-size: 12px; padding: 8px 12px; border-radius: 8px; font-weight: 600;" title="Manage all feedback"></button>
                            </div>
                        </div>
                        <div id="customFeedbackList" class="custom-feedback-list">
                            <!-- All user feedback will be listed here -->
                        </div>
                        <div style="text-align: center; margin-top: 15px; padding-top: 15px; border-top: 2px solid rgba(79, 70, 229, 0.2);">
                            <button class="btn btn-info" onclick="showUserFeedbackManager()" style="font-size: 14px; padding: 10px 20px; border-radius: 15px; font-weight: 600;">
                                 View All My Feedback
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Document Progress Panel -->
        <div class="document-progress" id="documentProgress" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(255, 255, 255, 0.98); padding: 40px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); z-index: 10000; max-width: 600px; width: 90%; text-align: center; backdrop-filter: blur(10px);">
            <div class="loading-content">
                <img id="progressGif" class="progress-gif" src="https://media.giphy.com/media/3o7btPCcdNniyf0ArS/giphy.gif" alt="AI-Prism is analyzing..." style="width: 180px; height: 180px; border-radius: 15px; margin-bottom: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); display: block; margin-left: auto; margin-right: auto;">
                <div id="progressTitle" class="loading-text" style="font-size: 1.6em; font-weight: bold; margin-bottom: 15px; color: #4f46e5; line-height: 1.3;"> AI-Prism is analyzing...</div>
                <div id="progressDesc" class="loading-subtext" style="font-size: 1.1em; opacity: 0.8; color: #6b7280; margin-bottom: 20px; line-height: 1.4;">Please wait while magic happens!</div>
                
                <!-- Progress Bar -->
                <div style="background: #ecf0f1; height: 8px; border-radius: 4px; overflow: hidden; margin: 20px 0;">
                    <div id="sectionProgress" style="background: linear-gradient(90deg, #4f46e5, #7c3aed); height: 100%; width: 0%; transition: width 0.3s ease; border-radius: 4px;"></div>
                </div>
                
                <div style="margin-top: 25px; padding: 20px; background: rgba(79, 70, 229, 0.1); border-radius: 15px; backdrop-filter: blur(5px);">
                    <div id="progressText" style="font-size: 1em; color: #4f46e5; margin-bottom: 8px; font-weight: 600;"> AI-Prism uses advanced AI to understand context and meaning!</div>
                    <div id="progressSubtext" style="font-size: 0.9em; color: #6b7280;">Applying Hawkeye framework for comprehensive analysis</div>
                </div>
                
                <!-- Cancel Button -->
                <div style="margin-top: 20px;">
                    <button onclick="cancelAnalysis()" style="background: #e74c3c; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 14px; transition: background 0.2s;" onmouseover="this.style.background='#c0392b'" onmouseout="this.style.background='#e74c3c'"> Cancel Analysis</button>
                </div>
            </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="controls" id="actionButtons" style="display: none; justify-content: center;">
            <button class="btn btn-warning" onclick="revertAllFeedback()" id="revertAllBtn">
                 Revert All Feedback
            </button>
            <button class="btn btn-info" onclick="updateFeedback()" id="updateFeedbackBtn">
                 Update Feedback
            </button>
            <button class="btn btn-primary" onclick="showDashboard()" id="dashboardBtn">
                 Analytics Dashboard
            </button>
            <button class="btn btn-danger" onclick="deleteDocument()" id="deleteDocBtn">
                 Delete Document Only
            </button>
            <button class="btn btn-secondary" onclick="provideFeedbackOnTool()" id="toolFeedbackBtn">
                 Improve This Tool
            </button>
            <button class="btn btn-success" id="completeReviewBtn" onclick="completeReview()" disabled>
                 Complete Review
            </button>
            <button class="btn btn-info" onclick="exportChatHistory()" id="exportChatBtn">
                 Export AI-Prism Conversation
            </button>
            <button class="btn btn-secondary" onclick="downloadGuidelines()" id="downloadGuidelinesBtn">
                 Download Guidelines
            </button>
            <button class="btn btn-info" onclick="showUserFeedbackManager()" id="userFeedbackManagerBtn">
                 Manage My Feedback
            </button>
            <button class="btn btn-warning" onclick="exportAllUserFeedback()" id="exportUserFeedbackBtn">
                 Export My Feedback
            </button>
            <button class="btn btn-secondary" onclick="clearAllSectionCustomFeedback()" id="clearSectionFeedbackBtn">
                 Clear Section Feedback
            </button>
            <button class="btn btn-info" onclick="downloadStatistics()" id="downloadStatsBtn">
                 Download Statistics
            </button>
            <button class="btn btn-info" onclick="downloadDocument()" id="downloadBtn" disabled>
                 Download Document
            </button>
        </div>
    </div>

    <!-- Modals -->
    <!-- Shortcuts Modal -->
    <div class="modal" id="shortcutsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3> Keyboard Shortcuts</h3>
                <button class="modal-close" onclick="closeModal('shortcutsModal')">&times;</button>
            </div>
            <div style="max-height: 400px; overflow-y: auto;">
                <table style="width: 100%; border-collapse: collapse;">
                    <tr><th style="text-align: left; padding: 8px; border-bottom: 1px solid #eee;">Key</th><th style="text-align: left; padding: 8px; border-bottom: 1px solid #eee;">Action</th></tr>
                    <tr><td style="padding: 8px;"><span class="shortcut-key">N</span></td><td style="padding: 8px;">Next section</td></tr>
                    <tr><td style="padding: 8px;"><span class="shortcut-key">P</span></td><td style="padding: 8px;">Previous section</td></tr>
                    <tr><td style="padding: 8px;"><span class="shortcut-key">A</span></td><td style="padding: 8px;">Accept selected feedback</td></tr>
                    <tr><td style="padding: 8px;"><span class="shortcut-key">R</span></td><td style="padding: 8px;">Reject selected feedback</td></tr>
                    <tr><td style="padding: 8px;"><span class="shortcut-key">F</span></td><td style="padding: 8px;">Focus custom feedback</td></tr>
                    <tr><td style="padding: 8px;"><span class="shortcut-key">C</span></td><td style="padding: 8px;">Focus chat input</td></tr>
                    <tr><td style="padding: 8px;"><span class="shortcut-key">1-2</span></td><td style="padding: 8px;">Switch tabs</td></tr>
                    <tr><td style="padding: 8px;"><span class="shortcut-key">D</span></td><td style="padding: 8px;">Toggle dark mode</td></tr>
                    <tr><td style="padding: 8px;"><span class="shortcut-key">?</span></td><td style="padding: 8px;">Show this help</td></tr>
                </table>
            </div>
        </div>
    </div>

    <!-- FAQ Modal -->
    <div class="modal" id="faqModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3> Frequently Asked Questions</h3>
                <button class="modal-close" onclick="closeModal('faqModal')">&times;</button>
            </div>
            <div style="max-height: 500px; overflow-y: auto;">
                <h4>What is the Hawkeye framework?</h4>
                <p>The Hawkeye framework is a 20-point comprehensive investigation checklist used to ensure thorough document review covering impact assessment, root cause analysis, and preventative actions.</p>
                
                <h4>How does the AI generate feedback?</h4>
                <p>The AI analyzes each section against Hawkeye criteria, identifying improvements, missing information, and compliance issues using advanced language models.</p>
                
                <h4>What happens when I accept feedback?</h4>
                <p>Accepted feedback is added as comments to the final document and helps train the AI for future reviews.</p>
                
                <h4>Can I add my own feedback?</h4>
                <p>Yes! Use the "Add Custom Feedback" form to contribute your insights, which will be included in the final document.</p>
                
                <h4>How do I use keyboard shortcuts?</h4>
                <p>Press the '?' key to see all available shortcuts. You can navigate sections with N/P, accept/reject feedback with A/R, and toggle dark mode with D.</p>
                
                <h4>What file formats are supported?</h4>
                <p>Currently, only Microsoft Word (.docx) files are supported for analysis. PDF and other formats will be added in future updates.</p>
                
                <h4>How does the AI learning system work?</h4>
                <p>AI-Prism learns from your feedback patterns - when you accept, reject, or add custom feedback, it adapts to provide more relevant suggestions in future analyses.</p>
            </div>
        </div>
    </div>

    <!-- Generic Modal for dynamic content -->
    <div class="modal" id="genericModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="genericModalTitle">Information</h3>
                <button class="modal-close" onclick="closeModal('genericModal')">&times;</button>
            </div>
            <div id="genericModalContent">
                <!-- Dynamic content will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Startup Popup Modal (Hidden by default) -->
    <div class="modal" id="startupModal" style="display: none;">
        <div class="modal-content" style="max-width: 600px; animation: slideInFromTop 0.5s ease-out;">
            <div class="modal-header" style="background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); color: white; border-radius: 15px 15px 0 0; margin: -30px -30px 20px -30px; padding: 30px;">
                <h3 style="margin: 0; font-size: 1.8em; text-align: center;"> Text Highlighting Feature</h3>
            </div>
            <div style="text-align: center; padding: 20px;">
                <div style="background: linear-gradient(135deg, #f8f9ff 0%, #e3f2fd 100%); padding: 25px; border-radius: 15px; margin-bottom: 25px; border: 3px solid #4f46e5; box-shadow: 0 8px 25px rgba(79, 70, 229, 0.2);">
                    <h4 style="color: #4f46e5; margin-bottom: 20px; font-size: 1.4em;"> Enhanced Document Review</h4>
                    
                    <div style="text-align: left; margin-bottom: 20px; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 3px 10px rgba(0,0,0,0.1);">
                        <h5 style="color: #4f46e5; margin-bottom: 15px; text-align: center;"> How to Use Text Highlighting:</h5>
                        
                        <div style="display: grid; grid-template-columns: 1fr; gap: 12px;">
                            <div style="display: flex; align-items: center; padding: 10px; background: #f8f9ff; border-radius: 8px; border-left: 4px solid #4f46e5;">
                                <span style="font-size: 1.5em; margin-right: 12px;"></span>
                                <div><strong>Step 1:</strong> Choose a highlight color from the toolbar</div>
                            </div>
                            <div style="display: flex; align-items: center; padding: 10px; background: #f0fff4; border-radius: 8px; border-left: 4px solid #10b981;">
                                <span style="font-size: 1.5em; margin-right: 12px;"></span>
                                <div><strong>Step 2:</strong> Select any text in the document</div>
                            </div>
                            <div style="display: flex; align-items: center; padding: 10px; background: #fdf2f8; border-radius: 8px; border-left: 4px solid #ec4899;">
                                <span style="font-size: 1.5em; margin-right: 12px;"></span>
                                <div><strong>Step 3:</strong> Click "Save & Comment" to add your feedback</div>
                            </div>
                            <div style="display: flex; align-items: center; padding: 10px; background: #fff7ed; border-radius: 8px; border-left: 4px solid #f59e0b;">
                                <span style="font-size: 1.5em; margin-right: 12px;"></span>
                                <div><strong>Step 4:</strong> Use "Clear All" to remove highlights when needed</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: rgba(79, 70, 229, 0.1); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                        <div style="font-size: 1.1em; font-weight: 600; color: #4f46e5; margin-bottom: 8px;"> Pro Tips:</div>
                        <div style="text-align: left; font-size: 0.95em; color: #555; line-height: 1.6;">
                             Your highlighted comments automatically appear in the "Custom Feedback" section<br>
                             Click existing highlights to view or add more comments<br>
                             Different colors help organize different types of feedback<br>
                             All highlights are saved with your document review
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button class="btn btn-primary" onclick="closeStartupModal()" style="padding: 15px 30px; font-size: 16px; border-radius: 25px; font-weight: 600; box-shadow: 0 5px 15px rgba(79, 70, 229, 0.3);">
                         Got it!
                    </button>
                </div>
            </div>
        </div>
    </div>

    <style>
        @keyframes slideInFromTop {
            from {
                opacity: 0;
                transform: translate(-50%, -60%);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%);
            }
        }
    </style>

    <script src="/static/js/app.js"></script>
    <script src="/static/js/button_fixes.js"></script>
    <script src="/static/js/missing_functions.js"></script>
    <script src="/static/js/text_highlighting.js"></script>
    <script src="/static/js/custom_feedback_functions.js"></script>
    <script src="/static/js/user_feedback_management.js"></script>
    <script src="/static/js/custom_feedback_help.js"></script>
    <script src="/static/js/text_highlight_comments.js"></script>
    <script src="/static/js/enhanced_help_system.js"></script>
    <script src="/static/js/custom_feedback_fix.js"></script>
    <script>
        // Global variables - using window scope to avoid conflicts with other JS files
        window.currentSession = window.currentSession || null;
        window.sections = window.sections || [];
        window.currentSectionIndex = window.currentSectionIndex || 0;
        window.selectedFeedbackId = window.selectedFeedbackId || null;
        window.feedbackStates = window.feedbackStates || {};
        window.analysisFile = window.analysisFile || null;
        window.guidelinesFile = window.guidelinesFile || null;
        window.chatHistory = window.chatHistory || [];
        window.userFeedbackHistory = window.userFeedbackHistory || [];
        window.finalDocumentData = window.finalDocumentData || null;
        window.isDarkMode = window.isDarkMode || false;
        window.documentZoom = window.documentZoom || 100;
        window.dashboardData = window.dashboardData || {
            totalFeedback: 0,
            acceptedFeedback: 0,
            rejectedFeedback: 0,
            userFeedback: 0
        };
        
        // Text highlighting variables moved to text_highlighting.js
        
        // Loading media array
        const loadingMediaWithContent = [
            {
                gif: 'https://media.giphy.com/media/26tn33aiTi1jkl6H6/giphy.gif',
                joke: "What's Iron Man's favorite type of music? Heavy metal! ",
                math: "Physics: If light travels at 300,000 km/s, how far in 1 minute? Answer: 18 million km! "
            },
            {
                gif: 'https://media.giphy.com/media/3o7btPCcdNniyf0ArS/giphy.gif',
                joke: "Why is Sherlock Holmes so good at solving crimes? He always finds the clues elementary! ",
                math: "Deduction: If A > B and B > C, then A > C. This is called? Answer: Transitive property! "
            },
            
            // Cartoons & Animation
            {
                gif: 'https://media.giphy.com/media/l3q2K5jinAlChoCLS/giphy.gif',
                joke: "Why is SpongeBob so good at his job? He's always ready! ",
                math: "Underwater Math: If SpongeBob makes 100 Krabby Patties in 2 hours, what's his rate per hour? Answer: 50 patties/hour! "
            },
            {
                gif: 'https://media.giphy.com/media/3o6Zt4HU9uwXmXSAuI/giphy.gif',
                joke: "What do you call a Minion who works in IT? A tech-nion! ",
                math: "Minion Math: If there are 3 Minions and each eats 4 bananas, how many bananas total? Answer: 12 bananas! "
            },
            
            // Mathematical & Analytical
            {
                gif: 'https://media.giphy.com/media/26BRrSvJUa0crqw4E/giphy.gif',
                joke: "Why was the equal sign so humble? Because it knew it wasn't less than or greater than anyone! =",
                math: "Algebra Challenge: Solve for x: 2x + 5 = 15. Answer: x = 5! "
            },
            {
                gif: 'https://media.giphy.com/media/3o7btNa0RUYa5E7iiQ/giphy.gif',
                joke: "What did the calculator say to the math student? You can count on me! ",
                math: "Percentage Puzzle: What's 25% of 80? Answer: 20! (Tip: 25% = 1/4) "
            },
            
            // Office & Work Humor
            {
                gif: 'https://media.giphy.com/media/l0MYGb8Q5QNhNBuDu/giphy.gif',
                joke: "Why don't programmers like nature? It has too many bugs! ",
                math: "Coding Math: In binary, what comes after 1011? Answer: 1100! "
            },
            {
                gif: 'https://media.giphy.com/media/26u4cqiYI30juCOGY/giphy.gif',
                joke: "What's a computer's favorite snack? Microchips! ",
                math: "Data Size: How many bytes in 1 kilobyte? Answer: 1,024 bytes! "
            },
            
            // Smart & Nerdy
            {
                gif: 'https://media.giphy.com/media/26BRBKqUiq586bRVm/giphy.gif',
                joke: "Why do mathematicians love parks? Because of all the natural logs! ",
                math: "Logarithm: What's log(1000)? Answer: 3! (Because 10 = 1000) "
            },
            {
                gif: 'https://media.giphy.com/media/3o7TKF1fSIs1R19B8k/giphy.gif',
                joke: "What do you call a professor who doesn't fart in public? A private tutor! ",
                math: "Statistics: In a normal distribution, what percentage falls within 1 standard deviation? Answer: ~68%! "
            },
            
            // Bonus Fun Content
            {
                gif: 'https://media.giphy.com/media/l0HlBO7eyXzSZkJri/giphy.gif',
                joke: "Why did the scarecrow win an award? He was outstanding in his field! ",
                math: "Geometry: Sum of angles in a triangle? Answer: Always 180! "
            },
            {
                gif: 'https://media.giphy.com/media/3oriO0OEd9QIDdllqo/giphy.gif',
                joke: "What do you call a fake noodle? An impasta! ",
                math: "Time Math: How many seconds in a day? Answer: 86,400 seconds! "
            },
            {
                gif: 'https://media.giphy.com/media/3oEjHCWdU7F4hkcudy/giphy.gif',
                joke: "Why don't scientists trust stairs? Because they're always up to something! ",
                math: "Fibonacci: What's the next number after 1,1,2,3,5,8? Answer: 13! "
            }
        ];
        
        let currentMediaIndex = 0;
        let mediaRotationInterval = null;
        let isMediaRotating = false;
        let usedMediaIndices = [];
        let currentContentType = 'gif'; // 'gif', 'joke', 'math'
        
        let showGraphics = true;
        let currentAnalysisStep = 0;
        let totalSections = 0;
        let currentAIModel = 'ai-prism-model';
        window.availableModels = window.availableModels || {
            'ai-prism-model': 'AI-Prism Model (Primary)',
            'ai-prism-backup': 'AI-Prism Backup Model',
            'ai-prism-fast': 'AI-Prism Fast Model',
            'ai-prism-precise': 'AI-Prism Precise Model',
            'ai-prism-comprehensive': 'AI-Prism Comprehensive Model'
        };
        let modelFallbackOrder = ['ai-prism-model', 'ai-prism-backup', 'ai-prism-fast', 'ai-prism-precise', 'ai-prism-comprehensive'];
        let currentModelIndex = 0;
        
        // Notification function
        function showNotification(message, type) {
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(n => n.remove());
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 10001;
                transform: translateX(400px);
                transition: transform 0.3s ease;
                max-width: 350px;
                word-wrap: break-word;
                box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            `;
            
            if (type === 'success') notification.style.background = 'linear-gradient(135deg, #2ecc71, #27ae60)';
            else if (type === 'error') notification.style.background = 'linear-gradient(135deg, #e74c3c, #c0392b)';
            else if (type === 'info') notification.style.background = 'linear-gradient(135deg, #3498db, #2980b9)';
            else if (type === 'warning') notification.style.background = 'linear-gradient(135deg, #f39c12, #e67e22)';
            else notification.style.background = 'linear-gradient(135deg, #95a5a6, #7f8c8d)';
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            setTimeout(() => {
                notification.style.transform = 'translateX(400px)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 4000);
        }
        
        // Cancel analysis function
        function cancelAnalysis() {
            if (confirm('Are you sure you want to cancel the analysis? You will need to start over.')) {
                // Stop any ongoing analysis
                window.currentAnalysisStep = window.sections ? window.sections.length : 0;
                
                // Hide progress panels
                hideProgress();
                hideSectionLoadingProgress();
                
                // Reset UI
                const startBtn = document.getElementById('startAnalysisBtn');
                if (startBtn) {
                    startBtn.disabled = false;
                    startBtn.textContent = ' Start Analysis';
                }
                
                showNotification('Analysis cancelled. You can start a new analysis anytime.', 'warning');
            }
        }
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('AI-Prism initializing...');
            try {
                setupEventListeners();
                setupKeyboardShortcuts();
                setupDragAndDrop();
                loadDarkModePreference();
                
                // Initialize progress tracking
                window.currentAnalysisStep = 0;
                window.sectionData = {};
                
                showNotification(' AI-Prism loaded successfully! Upload a document to begin analysis.', 'success');
                
                // Startup modal is hidden by default - only show when user clicks the highlighting feature button
                const startupModal = document.getElementById('startupModal');
                if (startupModal) startupModal.style.display = 'none';
                
                // Show helpful tip after a moment
                setTimeout(() => {
                    showNotification(' Tip: Drag and drop a .docx file or use the upload button to get started', 'info');
                }, 3000);
                
            } catch (error) {
                console.error('Initialization error:', error);
                showNotification('Initialization error: ' + error.message, 'error');
            }
        });
        
        function showHighlightingInstructions() {
            const modalContent = `
                <div style="text-align: center; padding: 20px;">
                    <h3 style="color: #4f46e5; margin-bottom: 20px;"> New Feature: Text Highlighting!</h3>
                    
                    <div style="background: linear-gradient(135deg, #f8f9ff 0%, #e3f2fd 100%); padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 2px solid #4f46e5;">
                        <h4 style="color: #4f46e5; margin-bottom: 15px;"> How to Use Text Highlighting:</h4>
                        
                        <div style="text-align: left; margin-bottom: 15px;">
                            <p><strong>1.  Choose Color:</strong> Click a color button in the highlight tools</p>
                            <p><strong>2.  Select Text:</strong> Highlight any text in the document</p>
                            <p><strong>3.  Add Comment:</strong> A dialog will appear to add your feedback</p>
                            <p><strong>4.  Erase Mode:</strong> Click "Erase Mode" then click highlights to remove them</p>
                            <p><strong>5.  Clear All:</strong> Remove all highlights at once</p>
                        </div>
                        
                        <div style="background: rgba(79, 70, 229, 0.1); padding: 10px; border-radius: 8px; margin-top: 15px;">
                            <strong> Pro Tip:</strong> Your highlighted text comments will automatically appear in the "Add Your Custom Feedback" section for easy review!
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <p style="color: #666; font-size: 0.9em;">This feature helps you provide specific feedback on exact text portions in the document.</p>
                    </div>
                    
                    <button class="btn btn-primary" onclick="closeModal('genericModal')" style="padding: 12px 25px; border-radius: 20px; font-weight: 600;">
                         Got it! Let's Start
                    </button>
                </div>
            `;
            
            showModal('genericModal', 'Text Highlighting Feature', modalContent);
        }
        
        function setupEventListeners() {
            // File input changes
            const fileInput = document.getElementById('fileInput');
            const guidelinesInput = document.getElementById('guidelinesInput');
            const sectionSelect = document.getElementById('sectionSelect');
            
            if (fileInput) fileInput.addEventListener('change', handleAnalysisFileUpload);
            if (guidelinesInput) guidelinesInput.addEventListener('change', handleGuidelinesFileUpload);
            
            if (sectionSelect) {
                sectionSelect.addEventListener('change', function() {
                    const selectedIndex = this.selectedIndex - 1;
                    if (selectedIndex >= 0) {
                        loadSection(selectedIndex);
                    }
                });
            }
        }
        
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                    return;
                }
                
                switch(e.key.toLowerCase()) {
                    case 'n':
                        e.preventDefault();
                        nextSection();
                        break;
                    case 'p':
                        e.preventDefault();
                        previousSection();
                        break;
                    case 'd':
                        e.preventDefault();
                        toggleDarkMode();
                        break;
                    case '?':
                        e.preventDefault();
                        showShortcuts();
                        break;
                }
            });
        }
        
        function setupDragAndDrop() {
            const uploadArea = document.getElementById('uploadArea');
            if (!uploadArea) return;
            
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].name.toLowerCase().endsWith('.docx')) {
                    analysisFile = files[0];
                    document.getElementById('analysisFileName').textContent = files[0].name;
                    document.getElementById('startAnalysisBtn').disabled = false;
                    showNotification('Analysis document ready!', 'success');
                } else {
                    showNotification('Please drop a .docx file', 'error');
                }
            });
        }
        
        function loadDarkModePreference() {
            const savedDarkMode = localStorage.getItem('darkMode');
            if (savedDarkMode === 'true') {
                isDarkMode = true;
                document.body.classList.add('dark-mode');
                const button = document.getElementById('darkModeToggle');
                if (button) {
                    button.textContent = ' Light Mode';
                    button.className = 'btn btn-warning';
                }
            }
        // Ensure custom feedback section is shown when main content loads
        function ensureCustomFeedbackVisible() {
            const customFeedbackSection = document.getElementById('customFeedbackSection');
            if (customFeedbackSection) {
                customFeedbackSection.style.display = 'block';
                console.log('Custom feedback section made visible');
            } else {
                console.warn('Custom feedback section not found');
            }
        }
        
        // Override the showMainContent function to include custom feedback section
        window.showMainContentWithCustom = function() {
            // Show main content grid
            const mainContent = document.getElementById('mainContent');
            if (mainContent) {
                mainContent.style.display = 'grid';
            }
            
            // Show statistics panel
            const statsPanel = document.getElementById('statisticsPanel');
            if (statsPanel) {
                statsPanel.style.display = 'block';
            }
            
            // Show action buttons
            const actionButtons = document.getElementById('actionButtons');
            if (actionButtons) {
                actionButtons.style.display = 'flex';
            }
            
            // Show the custom feedback section
            const customFeedbackSection = document.getElementById('customFeedbackSection');
            if (customFeedbackSection) {
                customFeedbackSection.style.display = 'block';
                console.log('Custom feedback section displayed');
            }
            
            updateStatistics();
        };
        
        // Replace the original showMainContent calls
        if (typeof showMainContent !== 'undefined') {
            const originalShowMainContent = showMainContent;
            showMainContent = function() {
                originalShowMainContent.apply(this, arguments);
                ensureCustomFeedbackVisible();
            };
        }
        
        }
        
        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('dark-mode', isDarkMode);
            
            const button = document.getElementById('darkModeToggle');
            if (button) {
                button.textContent = isDarkMode ? ' Light Mode' : ' Dark Mode';
                button.className = isDarkMode ? 'btn btn-warning' : 'btn btn-secondary';
            }
            
            localStorage.setItem('darkMode', isDarkMode.toString());
        }
        
        function showShortcuts() {
            const modal = document.getElementById('shortcutsModal');
            if (modal) modal.style.display = 'block';
        }
        
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.style.display = 'none';
        }
        
        function showModal(modalId, title, content) {
            const modal = document.getElementById(modalId);
            const titleElement = document.getElementById('genericModalTitle');
            const contentElement = document.getElementById('genericModalContent');
            
            if (titleElement) titleElement.textContent = title;
            if (contentElement) contentElement.innerHTML = content;
            if (modal) modal.style.display = 'block';
        }
        
        function handleAnalysisFileUpload(event) {
            const file = event.target.files[0];
            if (file && file.name.toLowerCase().endsWith('.docx')) {
                analysisFile = file;
                document.getElementById('analysisFileName').textContent = file.name;
                document.getElementById('startAnalysisBtn').disabled = false;
                showNotification('Analysis document ready!', 'success');
            } else {
                showNotification('Please select a .docx file', 'error');
            }
        }
        
        function handleGuidelinesFileUpload(event) {
            const file = event.target.files[0];
            if (file && file.name.toLowerCase().endsWith('.docx')) {
                guidelinesFile = file;
                document.getElementById('guidelinesFileName').textContent = file.name;
                showNotification('Guidelines document ready!', 'info');
            } else {
                showNotification('Please select a .docx file for guidelines', 'error');
            }
        }
        
        // Progress handling functions
        function showProgress(message) {
            const progressContainer = document.getElementById('progressContainer');
            const progressText = document.getElementById('progressText');
            
            if (progressContainer) {
                progressContainer.style.display = 'block';
            }
            
            if (progressText) {
                progressText.textContent = message;
            }
        }
        
        function showDocumentProgress() {
            const progressPanel = document.getElementById('documentProgress');
            if (progressPanel) {
                progressPanel.style.display = 'block';
                
                // Rotate through loading GIFs
                rotateLoadingMedia();
            }
        }
        
        function hideDocumentProgress() {
            const progressPanel = document.getElementById('documentProgress');
            if (progressPanel) {
                progressPanel.style.display = 'none';
            }
            
            // Stop media rotation
            if (mediaRotationInterval) {
                clearInterval(mediaRotationInterval);
                mediaRotationInterval = null;
            }
        }
        
        function updateDocumentProgress(sectionName, current, total, percent) {
            const progressTitle = document.getElementById('progressTitle');
            const progressDesc = document.getElementById('progressDesc');
            const sectionProgress = document.getElementById('sectionProgress');
            const progressText = document.getElementById('progressText');
            const progressSubtext = document.getElementById('progressSubtext');
            
            if (progressTitle) {
                const messages = [
                    ` AI-Prism is investigating "${sectionName}"...`,
                    ` Deep analysis of "${sectionName}" in progress...`,
                    ` Applying Hawkeye framework to "${sectionName}"...`,
                    ` AI-Prism is thinking about "${sectionName}"...`,
                    ` Processing "${sectionName}" with advanced AI...`
                ];
                progressTitle.textContent = messages[Math.floor(Math.random() * messages.length)];
            }
            
            if (progressDesc) {
                progressDesc.textContent = `Section ${current} of ${total} - ${Math.round(percent)}% complete`;
            }
            
            if (sectionProgress) {
                sectionProgress.style.width = `${percent}%`;
            }
            
            if (progressText) {
                const tips = [
                    ` Applying 20-point Hawkeye investigation checklist`,
                    ` Cross-referencing with quality standards and best practices`,
                    ` Analyzing for compliance gaps and improvement opportunities`,
                    ` AI-Prism uses advanced reasoning to understand context`,
                    ` Generating targeted feedback based on document analysis`
                ];
                progressText.textContent = tips[Math.floor(Math.random() * tips.length)];
            }
            
            if (progressSubtext) {
                progressSubtext.textContent = `Processing with Claude 3.7 Sonnet - Advanced AI reasoning enabled`;
            }
        }
        
        function updateDocumentProgressMessage(title, description) {
            const progressTitle = document.getElementById('progressTitle');
            const progressDesc = document.getElementById('progressDesc');
            const progressText = document.getElementById('progressText');
            const progressSubtext = document.getElementById('progressSubtext');
            
            if (progressTitle) progressTitle.textContent = title;
            if (progressDesc) progressDesc.textContent = description;
            
            // Also update the info section
            if (progressText && title.includes('complete')) {
                progressText.textContent = ' Analysis completed successfully!';
            }
            if (progressSubtext && description.includes('Ready')) {
                progressSubtext.textContent = 'Navigate through sections to review AI-generated feedback';
            }
        }
        
        function rotateLoadingMedia() {
            if (isMediaRotating) return;
            
            isMediaRotating = true;
            currentMediaIndex = 0;
            usedMediaIndices = [];
            
            // Show first media immediately
            showNextLoadingMedia();
            
            // Set up rotation interval
            mediaRotationInterval = setInterval(() => {
                showNextLoadingMedia();
            }, 4000); // Change every 4 seconds
        }
        
        function showNextLoadingMedia() {
            if (loadingMediaWithContent.length === 0) return;
            
            // Reset if we've used all media
            if (usedMediaIndices.length >= loadingMediaWithContent.length) {
                usedMediaIndices = [];
            }
            
            // Find next unused media
            let nextIndex;
            do {
                nextIndex = Math.floor(Math.random() * loadingMediaWithContent.length);
            } while (usedMediaIndices.includes(nextIndex) && usedMediaIndices.length < loadingMediaWithContent.length);
            
            usedMediaIndices.push(nextIndex);
            const media = loadingMediaWithContent[nextIndex];
            
            // Update the progress GIF and content
            const progressGif = document.getElementById('progressGif');
            if (progressGif && media.gif) {
                progressGif.src = media.gif;
                progressGif.alt = 'AI-Prism is working...';
            }
            
            // Optionally show joke or math fact in description
            const progressDesc = document.getElementById('progressDesc');
            if (progressDesc && Math.random() > 0.5) {
                if (Math.random() > 0.5 && media.joke) {
                    progressDesc.textContent = ` ${media.joke}`;
                } else if (media.math) {
                    progressDesc.textContent = ` ${media.math}`;
                }
            }
        }
        
        function hideProgress() {
            const progressContainer = document.getElementById('progressContainer');
            if (progressContainer) {
                progressContainer.style.display = 'none';
            }
        }
        
        function closeStartupModal() {
            document.getElementById('startupModal').style.display = 'none';
        }
        
        function showTextHighlightingFeature() {
            const modalContent = `
                <div style="text-align: center; padding: 20px; max-height: 80vh; overflow-y: auto;">
                    <h3 style="color: #4f46e5; margin-bottom: 25px; font-size: 1.8em;"> Text Highlighting & Commenting Feature Guide</h3>
                    
                    <div style="background: linear-gradient(135deg, #f8f9ff 0%, #e3f2fd 100%); padding: 25px; border-radius: 15px; margin-bottom: 25px; border: 3px solid #4f46e5; box-shadow: 0 8px 25px rgba(79, 70, 229, 0.2);">
                        <h4 style="color: #4f46e5; margin-bottom: 20px; font-size: 1.4em;"> Complete Usage Guide:</h4>
                        
                        <div style="text-align: left; margin-bottom: 20px;">
                            <div style="display: grid; grid-template-columns: 1fr; gap: 15px;">
                                <div style="background: white; padding: 15px; border-radius: 10px; border-left: 5px solid #4f46e5; box-shadow: 0 3px 10px rgba(0,0,0,0.1);">
                                    <h5 style="color: #4f46e5; margin-bottom: 10px;"> Step 1: Choose Your Highlight Color</h5>
                                    <p style="margin: 0; color: #555;">Click any color button in the highlight toolbar: Yellow, Green, Blue, Red, or Gray. Each color can represent different types of feedback.</p>
                                </div>
                                
                                <div style="background: white; padding: 15px; border-radius: 10px; border-left: 5px solid #10b981; box-shadow: 0 3px 10px rgba(0,0,0,0.1);">
                                    <h5 style="color: #10b981; margin-bottom: 10px;"> Step 2: Select Text in Document</h5>
                                    <p style="margin: 0; color: #555;">Use your mouse to select any text in the document. Text gets highlighted automatically with your chosen color.</p>
                                </div>
                                
                                <div style="background: white; padding: 15px; border-radius: 10px; border-left: 5px solid #ec4899; box-shadow: 0 3px 10px rgba(0,0,0,0.1);">
                                    <h5 style="color: #ec4899; margin-bottom: 10px;"> Step 3: Add Comment</h5>
                                    <p style="margin: 0; color: #555;">A comment dialog opens automatically. Add your feedback about the highlighted text and save it.</p>
                                </div>
                                
                                <div style="background: white; padding: 15px; border-radius: 10px; border-left: 5px solid #f59e0b; box-shadow: 0 3px 10px rgba(0,0,0,0.1);">
                                    <h5 style="color: #f59e0b; margin-bottom: 10px;"> Step 4: Update Comments</h5>
                                    <p style="margin: 0; color: #555;">Use "Update Comments" button to view and edit all existing highlighted comments in the section.</p>
                                </div>
                            </div>
                        </div>
                        
                        <div style="background: white; padding: 20px; border-radius: 12px; border-left: 5px solid #10b981; margin-bottom: 20px;">
                            <h4 style="color: #10b981; margin-bottom: 15px;"> Button Functions:</h4>
                            <div style="display: grid; grid-template-columns: 1fr; gap: 8px;">
                                <div style="padding: 8px; background: #f0fff4; border-radius: 6px; font-size: 0.9em;">
                                    <strong> Color Buttons:</strong> Select highlight color before selecting text
                                </div>
                                <div style="padding: 8px; background: #f0fff4; border-radius: 6px; font-size: 0.9em;">
                                    <strong> Add Comment:</strong> Add comment to currently selected text
                                </div>
                                <div style="padding: 8px; background: #f0fff4; border-radius: 6px; font-size: 0.9em;">
                                    <strong> Update Comments:</strong> View and edit all existing highlighted comments
                                </div>
                                <div style="padding: 8px; background: #f0fff4; border-radius: 6px; font-size: 0.9em;">
                                    <strong> Clear All:</strong> Remove all highlights and comments from section
                                </div>
                            </div>
                        </div>
                        
                        <div style="background: rgba(79, 70, 229, 0.1); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                            <h5 style="color: #4f46e5; margin-bottom: 15px; font-size: 1.2em;"> Advanced Tips & Best Practices:</h5>
                            <div style="text-align: left; color: #555; line-height: 1.7;">
                                 <strong>Color Coding:</strong> Use different colors for different feedback types (e.g., Yellow for suggestions, Red for critical issues)<br>
                                 <strong>Automatic Integration:</strong> All highlighted comments automatically appear in your "Custom Feedback" section<br>
                                 <strong>Click to Edit:</strong> Click any existing highlight to view, edit, or add additional comments<br>
                                 <strong>Persistent Storage:</strong> Your highlights are saved with your review session<br>
                                 <strong>Export Ready:</strong> Highlighted feedback is included in your final document export<br>
                                 <strong>Section Specific:</strong> Highlights are organized by document section for easy navigation
                            </div>
                        </div>
                        
                        <div style="background: white; padding: 15px; border-radius: 10px; border: 2px solid #ec4899; margin-bottom: 20px;">
                            <h4 style="color: #ec4899; margin-bottom: 10px;"> Comment Types Available:</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px; font-size: 0.9em;">
                                <div style="text-align: center; padding: 8px; background: #fdf2f8; border-radius: 5px;"><strong>Suggestion</strong></div>
                                <div style="text-align: center; padding: 8px; background: #fdf2f8; border-radius: 5px;"><strong>Important</strong></div>
                                <div style="text-align: center; padding: 8px; background: #fdf2f8; border-radius: 5px;"><strong>Critical</strong></div>
                                <div style="text-align: center; padding: 8px; background: #fdf2f8; border-radius: 5px;"><strong>Question</strong></div>
                                <div style="text-align: center; padding: 8px; background: #fdf2f8; border-radius: 5px;"><strong>Clarification</strong></div>
                            </div>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #e8f5e8 0%, #d4edda 100%); padding: 15px; border-radius: 10px; border: 2px solid #28a745;">
                            <h5 style="color: #28a745; margin-bottom: 10px;"> Why Use Text Highlighting?</h5>
                            <div style="text-align: left; color: #155724; font-size: 0.95em; line-height: 1.6;">
                                 Provide precise, context-specific feedback<br>
                                 Visually organize your review comments<br>
                                 Create a clear audit trail of your analysis<br>
                                 Enhance collaboration with specific text references<br>
                                 All comments automatically appear in "Custom Feedback" logs
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="closeModal('genericModal')" style="padding: 12px 25px; border-radius: 20px; font-weight: 600;">
                             Start Using Highlights
                        </button>
                        <button class="btn btn-info" onclick="resetHighlightingTutorial()" style="padding: 12px 25px; border-radius: 20px;">
                             Reset Tutorial
                        </button>
                    </div>
                </div>
            `;
            
            showModal('genericModal', 'Text Highlighting Feature Guide', modalContent);
        }
        
        function resetHighlightingTutorial() {
            localStorage.removeItem('hasSeenTextHighlightingPopup');
            showNotification('Tutorial reset! The startup popup will show again on next page load.', 'success');
            closeModal('genericModal');
        }
        
        // Missing placeholder functions
        function showTutorial() { showNotification('Tutorial functionality not implemented yet', 'info'); }
        function showFAQ() {
            const modal = document.getElementById('faqModal');
            if (modal) modal.style.display = 'block';
        }
        function showPatterns() { showNotification('Pattern analysis functionality not implemented yet', 'info'); }
        function showLogs() { showNotification('Activity logs functionality not implemented yet', 'info'); }
        function showLearning() { showNotification('Learning system functionality not implemented yet', 'info'); }
        function resetSession() {
            if (confirm('Are you sure you want to reset the current session? All progress will be lost.')) {
                location.reload();
            }
        }
        function completeReview() { showNotification('Complete review functionality not implemented yet', 'info'); }
        
        // Add missing functions that are referenced in HTML
        function cancelAnalysis() {
            if (confirm('Are you sure you want to cancel the analysis?')) {
                window.currentAnalysisStep = window.sections ? window.sections.length : 0;
                hideProgress();
                showNotification('Analysis cancelled.', 'warning');
            }
        }
        
        function closeStartupModal() {
            const modal = document.getElementById('startupModal');
            if (modal) modal.style.display = 'none';
        }
        
        function confirmFinalDownload() {
            showNotification('Final download functionality not implemented yet', 'info');
        }
        
        function showAddCommentDialog() {
            if (!window.currentSelectedText) {
                showNotification('Please select text first to add a comment', 'info');
                return;
            }
            showNotification('Add comment functionality working - select text first', 'info');
        }
        
        function showUpdateCommentsDialog() {
            showNotification('Update comments functionality working', 'info');
        }
        
        function clearAllHighlights() {
            if (typeof clearHighlights === 'function') {
                clearHighlights();
            } else {
                showNotification('Clear highlights functionality not available', 'warning');
            }
        }
        
        // Quick custom feedback function for the static form in feedback panel
        function addQuickCustomFeedback() {
            const type = document.getElementById('quickCustomType')?.value;
            const category = document.getElementById('quickCustomCategory')?.value;
            const description = document.getElementById('quickCustomDescription')?.value?.trim();
            
            if (!description) {
                showNotification('Please enter your feedback description', 'error');
                document.getElementById('quickCustomDescription').focus();
                return;
            }
            
            if (!window.currentSession) {
                showNotification('No active session. Please upload a document first.', 'error');
                return;
            }
            
            if (!window.sections || window.currentSectionIndex < 0) {
                showNotification('No section selected. Please select a section first.', 'error');
                return;
            }
            
            // Use the regular addCustomFeedback function but with the quick form data
            fetch('/add_custom_feedback', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    session_id: window.currentSession,
                    section_name: window.sections[window.currentSectionIndex],
                    type: type,
                    category: category,
                    description: description
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(' Custom feedback added successfully!', 'success');
                    
                    // Clear the form
                    document.getElementById('quickCustomDescription').value = '';
                    
                    // Create feedback item for display
                    const feedbackItem = {
                        id: data.feedback_item.id,
                        type: type,
                        category: category,
                        description: description,
                        section: window.sections[window.currentSectionIndex],
                        timestamp: new Date().toISOString(),
                        user_created: true,
                        risk_level: type === 'critical' ? 'High' : type === 'important' ? 'Medium' : 'Low'
                    };
                    
                    // Add to user feedback history
                    if (!window.userFeedbackHistory) {
                        window.userFeedbackHistory = [];
                    }
                    window.userFeedbackHistory.push(feedbackItem);
                    
                    // Display the feedback
                    if (typeof displayUserFeedback === 'function') {
                        displayUserFeedback(feedbackItem);
                    } else if (typeof window.displayUserFeedback === 'function') {
                        window.displayUserFeedback(feedbackItem);
                    }
                    
                    // Update statistics and other displays
                    if (typeof updateStatistics === 'function') {
                        updateStatistics();
                    }
                    
                    if (typeof updateAllCustomFeedbackList === 'function') {
                        updateAllCustomFeedbackList();
                    } else if (typeof window.updateAllCustomFeedbackList === 'function') {
                        window.updateAllCustomFeedbackList();
                    }
                    
                    if (typeof refreshUserFeedbackList === 'function') {
                        refreshUserFeedbackList();
                    } else if (typeof window.refreshUserFeedbackList === 'function') {
                        window.refreshUserFeedbackList();
                    }
                } else {
                    showNotification(data.error || 'Failed to add custom feedback', 'error');
                }
            })
            .catch(error => {
                console.error('Add custom feedback error:', error);
                showNotification('Failed to add custom feedback: ' + error.message, 'error');
            });
        }
        function addChatMessage(message, sender, isThinking = false) {
            const container = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}${isThinking ? ' thinking' : ''}`;
            
            const timestamp = new Date().toLocaleTimeString();
            
            if (sender === 'user') {
                messageDiv.innerHTML = `<strong> You:</strong> <small style="opacity: 0.7;">${timestamp}</small><br><div style="margin-top: 8px;">${message}</div>`;
                messageDiv.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                messageDiv.style.color = 'white';
                messageDiv.style.borderRadius = '12px';
                messageDiv.style.marginLeft = 'auto';
                messageDiv.style.marginRight = '0';
            } else {
                // Enhanced AI response formatting
                const formattedMessage = formatAIResponse(message);
                messageDiv.innerHTML = `<strong> AI-Prism Professional:</strong> <small style="opacity: 0.7;">${timestamp}</small><br><div style="margin-top: 12px; line-height: 1.7; text-align: left;">${formattedMessage}</div>`;
                messageDiv.style.background = 'linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%)';
                messageDiv.style.color = 'white';
                messageDiv.style.borderRadius = '12px';
                messageDiv.style.marginLeft = '0';
                messageDiv.style.marginRight = 'auto';
            }
            
            messageDiv.style.padding = '20px';
            messageDiv.style.marginBottom = '15px';
            messageDiv.style.maxWidth = '90%';
            messageDiv.style.boxShadow = '0 5px 15px rgba(0,0,0,0.2)';
            messageDiv.style.wordWrap = 'break-word';
            messageDiv.style.fontSize = '14px';
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }
        
        function formatAIResponse(message) {
            // Enhanced formatting for professional AI responses
            let formatted = message;
            
            // Handle line breaks and paragraph structure
            formatted = formatted.replace(/\n\n/g, '<br><br>');
            formatted = formatted.replace(/\n/g, '<br>');
            
            // Enhanced bold text formatting with better styling
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong style="color: #ffffff; font-weight: 700; font-size: 1.05em;">$1</strong>');
            
            // Enhanced bullet point formatting with better spacing and styling
            formatted = formatted.replace(/\s*(.*?)(<br>|$)/g, '<div style="margin: 10px 0; padding-left: 20px; position: relative; line-height: 1.6;"><span style="position: absolute; left: 0; color: #ffffff; font-weight: bold;"></span>$1</div>');
            
            // Enhanced numbered list formatting
            formatted = formatted.replace(/(\d+\.)\s*(.*?)(<br>|$)/g, '<div style="margin: 10px 0; padding-left: 25px; position: relative; line-height: 1.6;"><span style="position: absolute; left: 0; color: #ffffff; font-weight: 700;">$1</span>$2</div>');
            
            // Enhanced section header formatting
            formatted = formatted.replace(/(<strong[^>]*>.*?:<\/strong>)/g, '<div style="margin: 15px 0 10px 0; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.3);">$1</div>');
            
            // Format follow-up questions with special styling
            formatted = formatted.replace(/(<strong[^>]*>.*?Follow-up.*?:<\/strong>)/g, '<div style="margin: 20px 0 10px 0; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px; border-left: 4px solid #ffffff;">$1</div>');
            
            // Clean up excessive line breaks
            formatted = formatted.replace(/(<br>){3,}/g, '<br><br>');
            
            // Add proper spacing around major sections
            formatted = formatted.replace(/<br><strong style="color: #ffffff/g, '<br><br><strong style="color: #ffffff');
            
            return formatted;
        }
        
        
        function showThinkingIndicator() {
            const indicator = document.getElementById('thinkingIndicator');
            const sendBtn = document.getElementById('sendChatBtn');
            const chatInput = document.getElementById('chatInput');
            
            if (indicator) {
                indicator.style.display = 'flex';
            }
            if (sendBtn) {
                sendBtn.disabled = true;
                sendBtn.innerHTML = '<span></span> Thinking...';
            }
            if (chatInput) {
                chatInput.disabled = true;
            }
        }
        
        function hideThinkingIndicator() {
            const indicator = document.getElementById('thinkingIndicator');
            const sendBtn = document.getElementById('sendChatBtn');
            const chatInput = document.getElementById('chatInput');
            
            if (indicator) {
                indicator.style.display = 'none';
            }
            if (sendBtn) {
                sendBtn.disabled = false;
                sendBtn.innerHTML = '<span></span> Send';
            }
            if (chatInput) {
                chatInput.disabled = false;
            }
        }
        
        function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) {
                showNotification('Please enter a message', 'warning');
                return;
            }
            
            if (!currentSession) {
                showNotification('No active session. Please upload a document first.', 'error');
                return;
            }
            
            // Add user message
            addChatMessage(message, 'user');
            input.value = '';
            
            // Show thinking indicator
            showThinkingIndicator();
            
            // Send to server
            fetch('/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    session_id: currentSession,
                    message: message,
                    current_section: sections[currentSectionIndex] || '',
                    ai_model: currentAIModel
                })
            })
            .then(response => response.json())
            .then(data => {
                hideThinkingIndicator();
                
                if (data.success) {
                    addChatMessage(data.response, 'assistant');
                    chatHistory.push({
                        user: message,
                        assistant: data.response,
                        timestamp: new Date().toISOString(),
                        model: data.model_used || currentAIModel
                    });
                } else {
                    // Provide helpful error response with guidance
                    const errorResponse = `I apologize for the technical difficulty. Let me help you with some guidance:

**For Document Analysis Questions:**
 **Content Gaps**: "What information is missing from this section?"
 **Quality Improvement**: "How can I strengthen the evidence in this analysis?"
 **Hawkeye Framework**: "Which Hawkeye checkpoints apply to this content?"
 **Risk Assessment**: "How should I classify the risk level here?"

**For Current Section (${sections[currentSectionIndex] || 'current section'}):**
 Ask about specific aspects that need improvement
 Request guidance on evidence validation
 Inquire about compliance with investigation standards
 Seek advice on stakeholder communication

**Follow-up:** Please try asking a specific question about the document analysis, and I'll provide detailed guidance based on professional investigation standards.`;
                    
                    addChatMessage(errorResponse, 'assistant');
                }
            })
            .catch(error => {
                hideThinkingIndicator();
                console.error('Chat error:', error);
                
                // Provide a helpful error message with suggestions
                const errorMessage = `I apologize, but I'm experiencing a connection issue right now. Here are some things you can try:

 **Check your question**: Make sure it's related to document analysis or the Hawkeye framework
 **Try rephrasing**: Ask about specific aspects like "What's missing from this section?" or "How can I improve this analysis?"
 **Be specific**: Instead of general questions, ask about particular elements like timelines, evidence, or risk assessment
 **Sample questions**: "What Hawkeye checkpoints apply here?" or "How should I quantify this impact?"

**Follow-up:** Please try asking a more specific question about the current section analysis, and I'll do my best to help!`;
                
                addChatMessage(errorMessage, 'assistant');
            });
        }
        
        function handleChatKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendChatMessage();
            }
        }

        // Note: Main initialization is handled above
        
        function loadDarkModePreference() {
            const savedDarkMode = localStorage.getItem('darkMode');
            if (savedDarkMode === 'true') {
                isDarkMode = true;
                document.body.classList.add('dark-mode');
                const button = document.getElementById('darkModeToggle');
                if (button) {
                    button.textContent = ' Light Mode';
                    button.className = 'btn btn-warning';
                }
            }
        }

        function setupEventListeners() {
            // File input changes
            document.getElementById('fileInput').addEventListener('change', handleAnalysisFileUpload);
            document.getElementById('guidelinesInput').addEventListener('change', handleGuidelinesFileUpload);
            
            // Section select change
            document.getElementById('sectionSelect').addEventListener('change', function() {
                const selectedIndex = this.selectedIndex - 1; // -1 because first option is placeholder
                if (selectedIndex >= 0) {
                    loadSection(selectedIndex);
                }
            });
        }

        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                // Don't trigger shortcuts when typing in inputs
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                    return;
                }

                switch(e.key.toLowerCase()) {
                    case 'n':
                        e.preventDefault();
                        nextSection();
                        break;
                    case 'p':
                        e.preventDefault();
                        previousSection();
                        break;
                    case 'a':
                        e.preventDefault();
                        if (selectedFeedbackId) {
                            acceptFeedback(selectedFeedbackId);
                        }
                        break;
                    case 'r':
                        e.preventDefault();
                        if (selectedFeedbackId) {
                            rejectFeedback(selectedFeedbackId);
                        }
                        break;
                    case 'f':
                        e.preventDefault();
                        document.getElementById('customDescription').focus();
                        break;
                    case 'c':
                        e.preventDefault();
                        document.getElementById('chatInput').focus();
                        break;
                    case 'd':
                        e.preventDefault();
                        toggleDarkMode();
                        break;
                    case '1':
                        e.preventDefault();
                        switchTab('feedback');
                        break;
                    case '2':
                        e.preventDefault();
                        switchTab('chat');
                        break;
                    case '?':
                        e.preventDefault();
                        showShortcuts();
                        break;
                }
            });
        }

        function setupDragAndDrop() {
            const uploadArea = document.getElementById('uploadArea');
            
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    // Set as analysis file by default
                    if (files[0].name.toLowerCase().endsWith('.docx')) {
                        analysisFile = files[0];
                        document.getElementById('analysisFileName').textContent = files[0].name;
                        document.getElementById('startAnalysisBtn').disabled = false;
                        showNotification('Analysis document ready. Click "Start Analysis" to begin.', 'info');
                    } else {
                        showNotification('Please drop a .docx file', 'error');
                    }
                }
            });
        }

        function handleAnalysisFileUpload(event) {
            try {
                const file = event.target.files[0];
                if (file) {
                    console.log('File selected:', file.name, 'Size:', file.size, 'Type:', file.type);
                    
                    if (!file.name.toLowerCase().endsWith('.docx')) {
                        showNotification('Please select a .docx file for analysis', 'error');
                        return;
                    }
                    
                    if (file.size > 16 * 1024 * 1024) {
                        showNotification('File size must be less than 16MB', 'error');
                        return;
                    }
                    
                    analysisFile = file;
                    const fileNameElement = document.getElementById('analysisFileName');
                    const startBtn = document.getElementById('startAnalysisBtn');
                    
                    if (fileNameElement) fileNameElement.textContent = file.name;
                    if (startBtn) startBtn.disabled = false;
                    
                    showNotification('Analysis document ready!', 'success');
                } else {
                    console.log('No file selected');
                }
            } catch (error) {
                console.error('File upload error:', error);
                showNotification('File upload error: ' + error.message, 'error');
            }
        }

        function handleGuidelinesFileUpload(event) {
            try {
                const file = event.target.files[0];
                if (file) {
                    console.log('Guidelines file selected:', file.name, 'Size:', file.size);
                    
                    if (!file.name.toLowerCase().endsWith('.docx')) {
                        showNotification('Please select a .docx file for guidelines', 'error');
                        return;
                    }
                    
                    if (file.size > 16 * 1024 * 1024) {
                        showNotification('Guidelines file size must be less than 16MB', 'error');
                        return;
                    }
                    
                    guidelinesFile = file;
                    const fileNameElement = document.getElementById('guidelinesFileName');
                    if (fileNameElement) fileNameElement.textContent = file.name;
                    
                    showNotification('Guidelines document ready!', 'info');
                } else {
                    console.log('No guidelines file selected');
                }
            } catch (error) {
                console.error('Guidelines file upload error:', error);
                showNotification('Guidelines file upload error: ' + error.message, 'error');
            }
        }

        function startAnalysis() {
            try {
                console.log('Starting analysis...');
                console.log('Analysis file:', analysisFile ? analysisFile.name : 'None');
                console.log('Guidelines file:', guidelinesFile ? guidelinesFile.name : 'None');
                
                if (!analysisFile) {
                    showNotification('Please select a document for analysis', 'error');
                    return;
                }
                
                // Disable the button to prevent double-clicks
                const startBtn = document.getElementById('startAnalysisBtn');
                if (startBtn) {
                    startBtn.disabled = true;
                    startBtn.textContent = 'Starting...';
                }
                
                handleFileSelection(analysisFile, guidelinesFile);
            } catch (error) {
                console.error('Start analysis error:', error);
                showNotification('Failed to start analysis: ' + error.message, 'error');
                
                // Re-enable button on error
                const startBtn = document.getElementById('startAnalysisBtn');
                if (startBtn) {
                    startBtn.disabled = false;
                    startBtn.textContent = ' Start Analysis';
                }
            }
        }

        function handleFileSelection(analysisFile, guidelinesFile = null) {
            // Show guidelines preference modal if guidelines file is provided
            if (guidelinesFile) {
                showGuidelinesPreferenceModal(analysisFile, guidelinesFile);
                return;
            }
            
            uploadAndAnalyze(analysisFile, guidelinesFile, 'both');
        }
        
        function showGuidelinesPreferenceModal(analysisFile, guidelinesFile) {
            const modalContent = `
                <div style="text-align: center; padding: 20px;">
                    <h3 style="color: #667eea; margin-bottom: 20px;"> Guidelines Document Detected</h3>
                    <p style="margin-bottom: 30px;">You've uploaded a custom guidelines document. How should AI-Prism use it?</p>
                    
                    <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="useGuidelinesPreference('new_only')" style="padding: 15px 25px;">
                             Use Only New Guidelines
                        </button>
                        <button class="btn btn-success" onclick="useGuidelinesPreference('both')" style="padding: 15px 25px;">
                             Use Both Old & New Guidelines
                        </button>
                        <button class="btn btn-secondary" onclick="useGuidelinesPreference('old_only')" style="padding: 15px 25px;">
                             Use Only Default Guidelines
                        </button>
                    </div>
                    
                    <p style="margin-top: 20px; font-size: 0.9em; color: #666;">
                        AI-Prism will analyze your document according to your preference.
                    </p>
                </div>
            `;
            
            showModal('genericModal', 'Guidelines Preference', modalContent);
            
            // Store files for later use
            window.tempAnalysisFile = analysisFile;
            window.tempGuidelinesFile = guidelinesFile;
        }
        
        function useGuidelinesPreference(preference) {
            closeModal('genericModal');
            
            const analysisFile = window.tempAnalysisFile;
            const guidelinesFile = window.tempGuidelinesFile;
            
            uploadAndAnalyze(analysisFile, guidelinesFile, preference);
        }
        
        function uploadAndAnalyze(analysisFile, guidelinesFile, guidelinesPreference) {
            try {
                if (!analysisFile) {
                    showNotification('No analysis file provided', 'error');
                    return;
                }
                
                const formData = new FormData();
                formData.append('document', analysisFile);
                formData.append('guidelines_preference', guidelinesPreference);
                
                if (guidelinesFile && guidelinesPreference !== 'old_only') {
                    formData.append('guidelines', guidelinesFile);
                }

                showProgress('Uploading documents...');

                fetch('/upload', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        currentSession = data.session_id;
                        sections = data.sections;
                        totalSections = sections.length;
                        
                        populateSectionSelect(data.sections);
                        showMainContent();
                        
                        // Start comprehensive analysis of all sections
                        startComprehensiveAnalysis();
                        
                        let message = 'Documents uploaded successfully!';
                        if (data.guidelines_uploaded) {
                            message += ` Using ${guidelinesPreference.replace('_', ' ')} guidelines.`;
                        }
                        showNotification(message, 'success');
                    } else {
                        showNotification(data.error || 'Upload failed', 'error');
                        hideProgress();
                    }
                })
                .catch(error => {
                    console.error('Upload error:', error);
                    showNotification('Upload failed: ' + error.message, 'error');
                    hideProgress();
                });
            } catch (error) {
                console.error('Upload setup error:', error);
                showNotification('Upload setup failed: ' + error.message, 'error');
            }
        }

        function populateSectionSelect(sectionNames) {
            const select = document.getElementById('sectionSelect');
            select.innerHTML = '<option value="">Select a section...</option>';
            
            sectionNames.forEach((section, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = section;
                select.appendChild(option);
            });
        }

        function showMainContent() {
            // Show main content grid
            const mainContent = document.getElementById('mainContent');
            if (mainContent) {
                mainContent.style.display = 'grid';
            }
            
            // Show statistics panel
            const statsPanel = document.getElementById('statisticsPanel');
            if (statsPanel) {
                statsPanel.style.display = 'block';
            }
            
            // Show action buttons
            const actionButtons = document.getElementById('actionButtons');
            if (actionButtons) {
                actionButtons.style.display = 'flex';
            }
            
            // Show the custom feedback panel (fix for blank gap issue)
            const customFeedbackPanel = document.querySelector('.custom-feedback-panel');
            if (customFeedbackPanel) {
                customFeedbackPanel.style.display = 'block';
                // Ensure proper spacing
                customFeedbackPanel.style.marginTop = '20px';
                customFeedbackPanel.style.marginBottom = '20px';
            }
            
            updateStatistics();
            
            // Initialize real-time feedback logs
            setTimeout(() => {
                if (window.updateRealTimeFeedbackLogs) {
                    window.updateRealTimeFeedbackLogs();
                }
            }, 500);
        }

        function startComprehensiveAnalysis() {
            showProgress(' Starting comprehensive analysis...');
            showDocumentProgress();
            
            currentAnalysisStep = 0;
            
            // Show initial progress message
            updateDocumentProgressMessage(' AI-Prism is preparing for comprehensive analysis...', 
                                        ` About to analyze ${totalSections} sections with Hawkeye framework`);
            
            // Start analysis after a brief delay to show the loading screen
            setTimeout(() => {
                analyzeNextSection();
            }, 1000);
        }
        
        function analyzeNextSection() {
            if (currentAnalysisStep >= totalSections) {
                // Analysis complete
                completeAnalysis();
                return;
            }
            
            const sectionName = sections[currentAnalysisStep];
            const progressPercent = ((currentAnalysisStep + 1) / totalSections) * 100;
            
            // Show document progress panel with enhanced loading
            showDocumentProgress();
            
            // Update progress with enhanced messages
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            if (progressFill) progressFill.style.width = progressPercent + '%';
            if (progressText) progressText.textContent = ` Analyzing: ${sectionName} (${currentAnalysisStep + 1}/${totalSections}) - ${Math.round(progressPercent)}%`;
            
            // Update document progress panel
            updateDocumentProgress(sectionName, currentAnalysisStep + 1, totalSections, progressPercent);
            
            // Show section-specific loading message
            updateDocumentProgressMessage(` AI-Prism is analyzing "${sectionName}" with Hawkeye framework...`, 
                                        ` This may take 10-30 seconds depending on content complexity`);
            
            // Analyze current section
            fetch('/analyze_section', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    session_id: currentSession,
                    section_name: sectionName
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Store section data
                    window.sectionData = window.sectionData || {};
                    window.sectionData[sectionName] = {
                        content: data.section_content,
                        feedback: data.feedback_items
                    };
                    
                    // Show success message
                    const feedbackCount = data.feedback_items ? data.feedback_items.length : 0;
                    updateDocumentProgressMessage(` "${sectionName}" analysis complete!`, 
                                                ` Generated ${feedbackCount} feedback items`);
                    
                    currentAnalysisStep++;
                    
                    // Continue with next section after a short delay
                    setTimeout(analyzeNextSection, 1500);
                } else {
                    // Show error and continue
                    updateDocumentProgressMessage(` "${sectionName}" analysis had issues`, 
                                                ` Continuing with next section...`);
                    currentAnalysisStep++;
                    setTimeout(analyzeNextSection, 1000);
                }
            })
            .catch(error => {
                console.error('Analysis error:', error);
                updateDocumentProgressMessage(` "${sectionName}" analysis failed`, 
                                            ` Continuing with next section...`);
                currentAnalysisStep++;
                setTimeout(analyzeNextSection, 1000);
            });
        }
        
        function completeAnalysis() {
            const progressText = document.getElementById('progressText');
            if (progressText) progressText.textContent = ' Comprehensive Analysis Complete!';
            
            // Show completion message
            updateDocumentProgressMessage(' All sections analyzed successfully!', 
                                        ' Ready to review feedback and complete your document');
            
            setTimeout(() => {
                hideProgress();
                hideDocumentProgress();
                loadSection(0); // Load first section
                updateStatistics();
                const completeBtn = document.getElementById('completeReviewBtn');
                if (completeBtn) completeBtn.disabled = false;
                showNotification(' Comprehensive analysis completed! Navigate through sections to review AI-generated feedback.', 'success');
            }, 3000);
        }
        
        function loadSection(index) {
            if (index < 0 || index >= sections.length) return;
            
            // Save current section highlights before switching
            saveCurrentSectionHighlights();
            
            currentSectionIndex = index;
            const sectionName = sections[index];
            
            // Update section select
            const sectionSelect = document.getElementById('sectionSelect');
            if (sectionSelect) sectionSelect.value = index;
            
            // Clear user feedback display
            const userFeedbackDisplay = document.getElementById('userFeedbackDisplay');
            if (userFeedbackDisplay) userFeedbackDisplay.innerHTML = '';
            
            // Load from stored data
            if (window.sectionData && window.sectionData[sectionName]) {
                const data = window.sectionData[sectionName];
                displaySectionContent(data.content, sectionName);
                displayFeedback(data.feedback, sectionName);
                updateRiskIndicator(data.feedback);
                
                // Load any existing user feedback for this section
                loadUserFeedbackForSection(sectionName);
                
                // Restore highlights for this section
                setTimeout(() => {
                    restoreSectionHighlights(sectionName);
                    // Update custom feedback button states
                    if (typeof updateAICustomButtonStates === 'function') {
                        updateAICustomButtonStates();
                    }
                }, 200);
            } else {
                // Fallback to API call if data not stored
                showProgress('Loading section...');
                
                fetch('/analyze_section', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        session_id: currentSession,
                        section_name: sectionName
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displaySectionContent(data.section_content, sectionName);
                        displayFeedback(data.feedback_items, sectionName);
                        updateRiskIndicator(data.feedback_items);
                        loadUserFeedbackForSection(sectionName);
                        
                        // Restore highlights for this section
                        setTimeout(() => {
                            restoreSectionHighlights(sectionName);
                            // Update custom feedback button states
                            if (typeof updateAICustomButtonStates === 'function') {
                                updateAICustomButtonStates();
                            }
                        }, 200);
                    }
                    hideProgress();
                })
                .catch(error => {
                    hideProgress();
                    showNotification('Failed to load section: ' + error.message, 'error');
                });
            }
        }
        
        function saveCurrentSectionHighlights() {
            if (currentSectionIndex >= 0 && sections[currentSectionIndex]) {
                const currentSectionName = sections[currentSectionIndex];
                const sectionHighlights = highlightedTexts.filter(h => h.section === currentSectionName);
                
                // Store highlights in session storage
                sessionStorage.setItem(`highlights_${currentSectionName}`, JSON.stringify(sectionHighlights));
            }
        }
        
        function restoreSectionHighlights(sectionName) {
            try {
                const storedHighlights = sessionStorage.getItem(`highlights_${sectionName}`);
                if (storedHighlights) {
                    const sectionHighlights = JSON.parse(storedHighlights);
                    
                    // Clear current highlights for this section
                    highlightedTexts = highlightedTexts.filter(h => h.section !== sectionName);
                    
                    // Restore highlights
                    sectionHighlights.forEach(highlight => {
                        restoreHighlight(highlight);
                        highlightedTexts.push(highlight);
                    });
                }
            } catch (error) {
                console.error('Error restoring highlights:', error);
            }
        }
        
        function restoreHighlight(highlightData) {
            const docContent = document.getElementById('documentContent');
            if (!docContent) return;
            
            // Find text nodes that contain the highlighted text
            const walker = document.createTreeWalker(
                docContent,
                NodeFilter.SHOW_TEXT,
                null,
                false
            );
            
            let node;
            while (node = walker.nextNode()) {
                const text = node.textContent;
                const highlightIndex = text.indexOf(highlightData.text);
                
                if (highlightIndex !== -1) {
                    try {
                        const range = document.createRange();
                        range.setStart(node, highlightIndex);
                        range.setEnd(node, highlightIndex + highlightData.text.length);
                        
                        const highlightSpan = document.createElement('span');
                        highlightSpan.className = 'text-highlight';
                        highlightSpan.id = highlightData.id;
                        highlightSpan.style.backgroundColor = highlightData.color;
                        highlightSpan.style.padding = '2px 4px';
                        highlightSpan.style.borderRadius = '3px';
                        highlightSpan.style.cursor = 'pointer';
                        highlightSpan.style.border = '1px solid rgba(0,0,0,0.2)';
                        highlightSpan.title = 'Click to add comment or remove highlight';
                        
                        range.surroundContents(highlightSpan);
                        break;
                    } catch (error) {
                        console.error('Error restoring individual highlight:', error);
                    }
                }
            }
        }
        
        function loadUserFeedbackForSection(sectionName) {
            // Display any existing user feedback for this section
            const sectionUserFeedback = userFeedbackHistory.filter(item => item.section === sectionName);
            sectionUserFeedback.forEach(item => {
                displayUserFeedback(item);
            });
            
            // Update the all custom feedback list
            updateAllCustomFeedbackList();
        }

        function displaySectionContent(content, sectionName) {
            const container = document.getElementById('documentContent');
            
            // Format content to look exactly like a Word document
            const formattedContent = content
                .replace(/\n\n/g, '</p><p style="margin: 12pt 0; text-align: justify;">')
                .replace(/\n/g, '<br>')
                .replace(/^/, '<p style="margin: 12pt 0; text-align: justify;">')
                .replace(/$/, '</p>');
            
            container.innerHTML = `
                <button onclick="expandDocument()" style="position: absolute; top: 10px; right: 10px; background: #667eea; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px; z-index: 10;"> Expand</button>
                <div class="document-inner" style="background: inherit; padding: 20px; margin: 0; box-shadow: 0 0 10px rgba(0,0,0,0.1); position: relative;">
                    <!-- Word document header -->
                    <div style="text-align: center; margin-bottom: 20px; border-bottom: 1pt solid currentColor; padding-bottom: 12pt;">
                        <h1 style="font-family: 'Times New Roman', serif; font-size: 16pt; font-weight: bold; margin: 0; text-transform: uppercase;">${sectionName}</h1>
                    </div>
                    
                    <!-- Document content with Word-like formatting -->
                    <div id="documentText" style="font-family: 'Times New Roman', serif; font-size: 12pt; line-height: 1.5; text-align: justify; user-select: text; -webkit-user-select: text; -moz-user-select: text; -ms-user-select: text;">
                        ${formattedContent}
                    </div>
                    
                    <!-- Page number -->
                    <div style="position: absolute; bottom: 10px; right: 20px; font-family: 'Times New Roman', serif; font-size: 10pt; opacity: 0.7;">
                        Page ${currentSectionIndex + 1}
                    </div>
                </div>
            `;
            
            // Enable text selection for highlighting
            setTimeout(() => {
                enableTextSelection();
                // Initialize new text highlighting with comments
                if (typeof initializeTextHighlighting === 'function') {
                    initializeTextHighlighting();
                }
            }, 100);
        }
        
        function expandDocument() {
            const container = document.getElementById('documentContent');
            const content = container.innerHTML;
            
            const modalContent = `
                <div style="max-height: 90vh; overflow-y: auto; padding: 20px;">
                    <div class="expanded-document" style="background: inherit; padding: 40px; margin: 0 auto; max-width: 8.5in; box-shadow: 0 0 20px rgba(0,0,0,0.2);">
                        ${content.replace('<button onclick="expandDocument()"', '<button onclick="closeModal(\'genericModal\')"').replace(' Expand', ' Close')}
                    </div>
                </div>
            `;
            
            showModal('genericModal', 'Document Viewer', modalContent);
        }

        // displayFeedback function moved to missing_functions.js

        function selectFeedback(feedbackId) {
            // Remove previous selection
            document.querySelectorAll('.feedback-item').forEach(item => {
                item.style.border = '';
            });
            
            // Highlight selected feedback
            const selectedItem = document.querySelector(`[data-feedback-id="${feedbackId}"]`);
            if (selectedItem) {
                selectedItem.style.border = '2px solid #667eea';
                selectedFeedbackId = feedbackId;
            }
        }

        function acceptFeedback(feedbackId, event) {
            if (event) event.stopPropagation();
            
            fetch('/accept_feedback', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    session_id: currentSession,
                    section_name: sections[currentSectionIndex],
                    feedback_id: feedbackId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Feedback accepted!', 'success');
                    updateFeedbackStatus(feedbackId, 'accepted');
                    updateStatistics();
                    
                    // Log the activity for real-time display
                    if (window.logAIFeedbackActivity) {
                        window.logAIFeedbackActivity(feedbackId, 'accepted');
                    }
                } else {
                    showNotification(data.error || 'Accept failed', 'error');
                }
            })
            .catch(error => {
                showNotification('Accept failed: ' + error.message, 'error');
            });
        }

        function rejectFeedback(feedbackId, event) {
            if (event) event.stopPropagation();
            
            fetch('/reject_feedback', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    session_id: currentSession,
                    section_name: sections[currentSectionIndex],
                    feedback_id: feedbackId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Feedback rejected!', 'info');
                    updateFeedbackStatus(feedbackId, 'rejected');
                    updateStatistics();
                    
                    // Log the activity for real-time display
                    if (window.logAIFeedbackActivity) {
                        window.logAIFeedbackActivity(feedbackId, 'rejected');
                    }
                } else {
                    showNotification(data.error || 'Reject failed', 'error');
                }
            })
            .catch(error => {
                showNotification('Reject failed: ' + error.message, 'error');
            });
        }

        function updateFeedbackStatus(feedbackId, status) {
            const feedbackItem = document.querySelector(`[data-feedback-id="${feedbackId}"]`);
            if (feedbackItem) {
                const actions = feedbackItem.querySelector('.feedback-actions');
                const statusColor = status === 'accepted' ? '#2ecc71' : '#e74c3c';
                const statusText = status === 'accepted' ? ' Accepted' : ' Rejected';
                
                if (!feedbackStates[feedbackId]) {
                    feedbackStates[feedbackId] = {
                        originalHtml: actions.innerHTML,
                        status: 'pending'
                    };
                }
                feedbackStates[feedbackId].status = status;
                
                actions.innerHTML = `
                    <span style="color: ${statusColor}; font-weight: bold;">${statusText}</span>
                    <button class="btn btn-warning revert-btn" onclick="revertFeedback('${feedbackId}', event)" style="font-size: 12px; padding: 5px 10px; margin-left: 10px;"> Revert</button>
                `;
                feedbackItem.style.opacity = '0.7';
            }
        }
        
        function revertFeedback(feedbackId, event) {
            if (event) event.stopPropagation();
            
            // Send revert request to server
            fetch('/revert_feedback', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    session_id: currentSession,
                    section_name: sections[currentSectionIndex],
                    feedback_id: feedbackId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Restore original feedback actions
                    const feedbackItem = document.querySelector(`[data-feedback-id="${feedbackId}"]`);
                    if (feedbackItem && feedbackStates[feedbackId]) {
                        const actions = feedbackItem.querySelector('.feedback-actions');
                        actions.innerHTML = feedbackStates[feedbackId].originalHtml;
                        feedbackItem.style.opacity = '1';
                        
                        feedbackStates[feedbackId].status = 'pending';
                        
                        showNotification('Feedback reverted to original state', 'success');
                        updateStatistics();
                    }
                } else {
                    showNotification(data.error || 'Revert failed', 'error');
                }
            })
            .catch(error => {
                // Fallback: revert locally even if server call fails
                const feedbackItem = document.querySelector(`[data-feedback-id="${feedbackId}"]`);
                if (feedbackItem && feedbackStates[feedbackId]) {
                    const actions = feedbackItem.querySelector('.feedback-actions');
                    actions.innerHTML = feedbackStates[feedbackId].originalHtml;
                    feedbackItem.style.opacity = '1';
                    
                    feedbackStates[feedbackId].status = 'pending';
                    
                    showNotification('Feedback reverted locally', 'info');
                    updateStatistics();
                }
                console.warn('Server revert failed, reverted locally:', error);
            });
        }
        
        function zoomIn() {
            if (documentZoom < 200) {
                documentZoom += 25;
                applyZoom();
            }
        }
        
        function zoomOut() {
            if (documentZoom > 50) {
                documentZoom -= 25;
                applyZoom();
            }
        }
        
        function resetZoom() {
            documentZoom = 100;
            applyZoom();
        }
        
        function applyZoom() {
            const docContent = document.getElementById('documentContent');
            const zoomLevel = document.getElementById('zoomLevel');
            
            if (docContent) {
                docContent.style.transform = `scale(${documentZoom / 100})`;
                docContent.style.transformOrigin = 'top left';
                docContent.style.width = `${10000 / documentZoom}%`;
            }
            
            if (zoomLevel) {
                zoomLevel.textContent = `${documentZoom}%`;
            }
        }

        function addCustomFeedback() {
            const type = document.getElementById('customType').value;
            const category = document.getElementById('customCategory').value;
            const description = document.getElementById('customDescription').value.trim();
            
            if (!description) {
                showNotification('Please enter feedback description', 'error');
                return;
            }
            
            if (!currentSession) {
                showNotification('No active session. Please upload a document first.', 'error');
                return;
            }
            
            if (!sections || currentSectionIndex < 0) {
                showNotification('No section selected. Please select a section first.', 'error');
                return;
            }
            
            const feedbackItem = {
                type: type,
                category: category,
                description: description,
                section: sections[currentSectionIndex],
                timestamp: new Date().toISOString(),
                session_id: currentSession,
                user_created: true,
                id: `user_${Date.now()}`,
                risk_level: type === 'critical' ? 'High' : type === 'important' ? 'Medium' : 'Low'
            };
            
            // Store in user feedback history immediately for live logging
            userFeedbackHistory.push(feedbackItem);
            
            fetch('/add_custom_feedback', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    session_id: currentSession,
                    section_name: sections[currentSectionIndex],
                    type: type,
                    category: category,
                    description: description
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(' Custom feedback added successfully!', 'success');
                    
                    // Clear the form
                    document.getElementById('customDescription').value = '';
                    
                    // Update feedback item with server data if available
                    if (data.feedback_item) {
                        feedbackItem.id = data.feedback_item.id;
                        // Update the item in history
                        const index = userFeedbackHistory.findIndex(item => item.timestamp === feedbackItem.timestamp);
                        if (index !== -1) {
                            userFeedbackHistory[index] = feedbackItem;
                        }
                    }
                    
                    // Display the user feedback immediately in current section
                    if (typeof displayUserFeedback === 'function') {
                        displayUserFeedback(feedbackItem);
                    } else if (typeof window.displayUserFeedback === 'function') {
                        window.displayUserFeedback(feedbackItem);
                    }
                    
                    // Update statistics
                    if (typeof updateStatistics === 'function') {
                        updateStatistics();
                    }
                    
                    // Automatically update "All My Custom Feedback" section with live logging
                    if (typeof updateAllCustomFeedbackList === 'function') {
                        updateAllCustomFeedbackList();
                    } else if (typeof window.updateAllCustomFeedbackList === 'function') {
                        window.updateAllCustomFeedbackList();
                    }
                    
                    // Refresh the user feedback list display
                    if (typeof refreshUserFeedbackList === 'function') {
                        refreshUserFeedbackList();
                    } else if (typeof window.refreshUserFeedbackList === 'function') {
                        window.refreshUserFeedbackList();
                    }
                    
                    // Trigger real-time logs update for live logging
                    if (window.updateRealTimeFeedbackLogs) {
                        window.updateRealTimeFeedbackLogs();
                    }
                    
                    // Update dashboard data
                    if (typeof dashboardData !== 'undefined') {
                        dashboardData.userFeedback = (dashboardData.userFeedback || 0) + 1;
                        dashboardData.totalFeedback = (dashboardData.totalFeedback || 0) + 1;
                    }
                    
                    // Update button states
                    if (typeof updateAICustomButtonStates === 'function') {
                        updateAICustomButtonStates();
                    }
                    
                    console.log(' Custom feedback added and logged successfully:', feedbackItem);
                } else {
                    // Remove from history if server failed
                    userFeedbackHistory = userFeedbackHistory.filter(item => item.id !== feedbackItem.id);
                    showNotification(data.error || 'Failed to add custom feedback', 'error');
                }
            })
            .catch(error => {
                // Remove from history if network failed
                userFeedbackHistory = userFeedbackHistory.filter(item => item.id !== feedbackItem.id);
                showNotification('Failed to add custom feedback: ' + error.message, 'error');
                console.error('Add custom feedback error:', error);
            });
        }
        
        // displayUserFeedback function moved to user_feedback_management.js
        
        // Custom feedback functions moved to custom_feedback_functions.js
        
        // saveAICustomFeedback function moved to custom_feedback_functions.js
        
        // updateAllCustomFeedbackList function moved to user_feedback_management.js
        
        function editUserFeedback(feedbackId) {
            const feedback = userFeedbackHistory.find(item => item.id === feedbackId);
            if (!feedback) return;
            
            const modalContent = `
                <div style="padding: 20px;">
                    <h3 style="color: #667eea; margin-bottom: 20px;"> Edit Your Feedback</h3>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div>
                            <label style="font-weight: bold; margin-bottom: 5px; display: block;">Type:</label>
                            <select id="editType" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                                <option value="suggestion" ${feedback.type === 'suggestion' ? 'selected' : ''}>Suggestion</option>
                                <option value="important" ${feedback.type === 'important' ? 'selected' : ''}>Important</option>
                                <option value="critical" ${feedback.type === 'critical' ? 'selected' : ''}>Critical</option>
                                <option value="positive" ${feedback.type === 'positive' ? 'selected' : ''}>Positive</option>
                                <option value="addition" ${feedback.type === 'addition' ? 'selected' : ''}>Addition</option>
                                <option value="clarification" ${feedback.type === 'clarification' ? 'selected' : ''}>Clarification</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-weight: bold; margin-bottom: 5px; display: block;">Category:</label>
                            <select id="editCategory" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                                <option value="Initial Assessment" ${feedback.category === 'Initial Assessment' ? 'selected' : ''}>Initial Assessment</option>
                                <option value="Investigation Process" ${feedback.category === 'Investigation Process' ? 'selected' : ''}>Investigation Process</option>
                                <option value="Root Cause Analysis" ${feedback.category === 'Root Cause Analysis' ? 'selected' : ''}>Root Cause Analysis</option>
                                <option value="Documentation and Reporting" ${feedback.category === 'Documentation and Reporting' ? 'selected' : ''}>Documentation and Reporting</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="font-weight: bold; margin-bottom: 5px; display: block;">Your Feedback:</label>
                        <textarea id="editDescription" style="width: 100%; height: 100px; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">${feedback.description}</textarea>
                    </div>
                    
                    ${feedback.ai_reference ? `<div style="background: #f0f8ff; padding: 10px; border-radius: 5px; margin-bottom: 15px;"><strong>Related to AI:</strong> ${feedback.ai_reference}</div>` : ''}
                    
                    <div style="text-align: center;">
                        <button class="btn btn-success" onclick="saveEditedFeedback('${feedbackId}')" style="margin: 5px;"> Save Changes</button>
                        <button class="btn btn-secondary" onclick="closeModal('genericModal')" style="margin: 5px;"> Cancel</button>
                    </div>
                </div>
            `;
            
            showModal('genericModal', 'Edit Feedback', modalContent);
        }
        
        function saveEditedFeedback(feedbackId) {
            const type = document.getElementById('editType').value;
            const category = document.getElementById('editCategory').value;
            const description = document.getElementById('editDescription').value.trim();
            
            if (!description) {
                showNotification('Please enter feedback description', 'error');
                return;
            }
            
            const updatedData = {
                type: type,
                category: category,
                description: description
            };
            
            fetch('/update_user_feedback', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    session_id: currentSession,
                    feedback_id: feedbackId,
                    updated_data: updatedData
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Feedback updated successfully!', 'success');
                    
                    // Update local history
                    const feedbackIndex = userFeedbackHistory.findIndex(item => item.id === feedbackId);
                    if (feedbackIndex !== -1) {
                        Object.assign(userFeedbackHistory[feedbackIndex], updatedData);
                        userFeedbackHistory[feedbackIndex].edited = true;
                        userFeedbackHistory[feedbackIndex].edited_at = new Date().toISOString();
                        
                        // Update display
                        const feedbackDiv = document.getElementById(`user-feedback-${feedbackId}`);
                        if (feedbackDiv) {
                            feedbackDiv.remove();
                            displayUserFeedback(userFeedbackHistory[feedbackIndex]);
                        }
                    }
                    
                    updateAllCustomFeedbackList();
                    closeModal('genericModal');
                    
                    // Refresh manager if open
                    const modal = document.getElementById('genericModal');
                    if (modal.style.display === 'block' && document.getElementById('genericModalTitle').textContent.includes('Feedback Manager')) {
                        setTimeout(() => refreshUserFeedbackManager(), 500);
                    }
                } else {
                    showNotification(data.error || 'Update failed', 'error');
                }
            })
            .catch(error => {
                showNotification('Update failed: ' + error.message, 'error');
            });
        }
        
        function deleteUserFeedback(feedbackId) {
            if (confirm('Are you sure you want to delete this feedback?')) {
                fetch('/delete_user_feedback', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: currentSession,
                        feedback_id: feedbackId
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification('Feedback deleted successfully!', 'success');
                        
                        // Remove from local history
                        const feedbackIndex = userFeedbackHistory.findIndex(item => item.id === feedbackId);
                        if (feedbackIndex !== -1) {
                            userFeedbackHistory.splice(feedbackIndex, 1);
                        }
                        
                        // Remove from display
                        const feedbackDiv = document.getElementById(`user-feedback-${feedbackId}`);
                        if (feedbackDiv) {
                            feedbackDiv.remove();
                        }
                        
                        updateAllCustomFeedbackList();
                        updateStatistics();
                    } else {
                        showNotification(data.error || 'Delete failed', 'error');
                    }
                })
                .catch(error => {
                    showNotification('Delete failed: ' + error.message, 'error');
                });
            }
        }
        
        function showUserFeedbackManager() {
            if (!currentSession) {
                showNotification('No active session', 'error');
                return;
            }
            
            // Fetch latest user feedback from server
            fetch(`/get_user_feedback?session_id=${currentSession}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const allFeedback = data.user_feedback;
                    
                    const modalContent = `
                        <div style="max-height: 75vh; overflow-y: auto;">
                            <h3 style="color: #667eea; margin-bottom: 20px;"> User Feedback Manager</h3>
                            
                            <div style="background: linear-gradient(135deg, #f8f9ff 0%, #e3f2fd 100%); padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 2px solid #667eea;">
                                <h4 style="color: #667eea; margin-bottom: 15px;"> Summary Dashboard</h4>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                                    <div style="text-align: center; background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                                        <div style="font-size: 2em; font-weight: bold; color: #667eea;">${allFeedback.length}</div>
                                        <div style="color: #666; font-size: 0.9em;">Total Feedback</div>
                                    </div>
                                    <div style="text-align: center; background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                                        <div style="font-size: 2em; font-weight: bold; color: #2ecc71;">${data.sections_with_feedback}</div>
                                        <div style="color: #666; font-size: 0.9em;">Sections</div>
                                    </div>
                                    <div style="text-align: center; background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                                        <div style="font-size: 2em; font-weight: bold; color: #3498db;">${allFeedback.filter(f => f.ai_reference).length}</div>
                                        <div style="color: #666; font-size: 0.9em;">AI-Related</div>
                                    </div>
                                    <div style="text-align: center; background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                                        <div style="font-size: 2em; font-weight: bold; color: #f39c12;">${allFeedback.filter(f => f.edited).length}</div>
                                        <div style="color: #666; font-size: 0.9em;">Edited</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 20px; text-align: center;">
                                <button class="btn btn-primary" onclick="exportAllUserFeedback('json')" style="margin: 5px;"> Export JSON</button>
                                <button class="btn btn-success" onclick="exportAllUserFeedback('csv')" style="margin: 5px;"> Export CSV</button>
                                <button class="btn btn-info" onclick="exportAllUserFeedback('txt')" style="margin: 5px;"> Export Text</button>
                                <button class="btn btn-warning" onclick="refreshUserFeedbackManager()" style="margin: 5px;"> Refresh</button>
                                <button class="btn btn-danger" onclick="clearAllUserFeedback()" style="margin: 5px;"> Clear All</button>
                            </div>
                            
                            <div id="feedbackManagerList">
                                ${allFeedback.length === 0 ? '<div style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 10px; color: #666;"><h4>No feedback added yet</h4><p>Start adding custom feedback to see it here!</p></div>' : 
                                allFeedback.map((item, index) => {
                                    const timestamp = new Date(item.timestamp).toLocaleString();
                                    const typeColors = {
                                        'addition': '#3498db',
                                        'clarification': '#f39c12', 
                                        'disagreement': '#e74c3c',
                                        'enhancement': '#9b59b6',
                                        'alternative': '#1abc9c',
                                        'context': '#34495e',
                                        'suggestion': '#2ecc71',
                                        'important': '#f39c12',
                                        'critical': '#e74c3c',
                                        'positive': '#27ae60'
                                    };
                                    const typeColor = typeColors[item.type] || '#95a5a6';
                                    
                                    return `
                                        <div style="background: white; padding: 20px; margin: 15px 0; border-radius: 12px; border-left: 5px solid ${typeColor}; box-shadow: 0 3px 15px rgba(0,0,0,0.1); transition: transform 0.2s ease;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                                                <div style="flex: 1;">
                                                    <div style="margin-bottom: 8px;">
                                                        <span style="background: ${typeColor}; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.8em; font-weight: 600; text-transform: uppercase;">${item.type}</span>
                                                        <span style="background: #ecf0f1; color: #2c3e50; padding: 4px 12px; border-radius: 20px; font-size: 0.8em; margin-left: 8px;">${item.category}</span>
                                                        <span style="color: #7f8c8d; font-size: 0.8em; margin-left: 10px; font-weight: 500;"> ${item.section}</span>
                                                    </div>
                                                    <div style="color: #95a5a6; font-size: 0.8em;">
                                                         ${timestamp}
                                                        ${item.edited ? ` |  Edited: ${new Date(item.edited_at).toLocaleString()}` : ''}
                                                    </div>
                                                </div>
                                                <div style="display: flex; gap: 8px;">
                                                    <button onclick="editUserFeedbackInManager('${item.id}')" style="background: #f39c12; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; transition: background 0.2s;" onmouseover="this.style.background='#e67e22'" onmouseout="this.style.background='#f39c12'"> Edit</button>
                                                    <button onclick="deleteUserFeedbackFromManager('${item.id}')" style="background: #e74c3c; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; transition: background 0.2s;" onmouseover="this.style.background='#c0392b'" onmouseout="this.style.background='#e74c3c'"> Delete</button>
                                                </div>
                                            </div>
                                            <div style="margin-bottom: 15px; color: #2c3e50; line-height: 1.6; background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 3px solid ${typeColor};">
                                                <strong>Feedback:</strong> ${item.description}
                                            </div>
                                            ${item.ai_reference ? `<div style="background: linear-gradient(135deg, #e8f4fd 0%, #d6eaf8 100%); padding: 12px; border-radius: 8px; font-size: 0.9em; color: #2980b9; border: 1px solid #aed6f1;"><strong> Related to AI Suggestion:</strong> ${item.ai_reference}</div>` : ''}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                    
                    showModal('genericModal', 'User Feedback Manager', modalContent);
                } else {
                    showNotification('Failed to load user feedback: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                showNotification('Failed to load user feedback: ' + error.message, 'error');
            });
        }
        
        function updateFeedbackManagerList() {
            const container = document.getElementById('feedbackManagerList');
            if (container) {
                const allFeedback = userFeedbackHistory;
                container.innerHTML = allFeedback.length === 0 ? '<p style="text-align: center; color: #666;">No feedback added yet.</p>' : 
                allFeedback.map(item => {
                    const timestamp = new Date(item.timestamp).toLocaleString();
                    return `
                        <div style="background: white; padding: 15px; margin: 10px 0; border-radius: 8px; border-left: 4px solid #3498db; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <div>
                                    <span style="background: #3498db; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.8em;">${item.type}</span>
                                    <span style="background: #95a5a6; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.8em; margin-left: 5px;">${item.category}</span>
                                    <span style="color: #666; font-size: 0.8em; margin-left: 10px;">${item.section}</span>
                                </div>
                                <div>
                                    <button onclick="editUserFeedback('${item.id}')" style="background: #f39c12; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; margin: 2px;"> Edit</button>
                                    <button onclick="deleteUserFeedback('${item.id}'); updateFeedbackManagerList();" style="background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; margin: 2px;"> Delete</button>
                                </div>
                            </div>
                            <div style="margin-bottom: 10px; color: #333;">${item.description}</div>
                            ${item.ai_reference ? `<div style="background: #ecf0f1; padding: 8px; border-radius: 4px; font-size: 0.9em; color: #666;"><strong>Related to AI:</strong> ${item.ai_reference}</div>` : ''}
                            <div style="font-size: 0.8em; color: #999; margin-top: 8px;">
                                Created: ${timestamp}
                                ${item.edited ? ` | Edited: ${new Date(item.editedAt).toLocaleString()}` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }
        
        function exportUserFeedbackCSV() {
            if (userFeedbackHistory.length === 0) {
                showNotification('No feedback to export', 'info');
                return;
            }
            
            const headers = ['Timestamp', 'Section', 'Type', 'Category', 'Description', 'AI Reference', 'Edited'];
            const csvContent = [headers.join(',')];
            
            userFeedbackHistory.forEach(item => {
                const row = [
                    new Date(item.timestamp).toLocaleString(),
                    item.section,
                    item.type,
                    item.category,
                    `"${item.description.replace(/"/g, '""')}"`,
                    item.ai_reference ? `"${item.ai_reference.replace(/"/g, '""')}"` : '',
                    item.edited ? 'Yes' : 'No'
                ];
                csvContent.push(row.join(','));
            });
            
            const blob = new Blob([csvContent.join('\n')], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `User_Feedback_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showNotification('Feedback exported as CSV!', 'success');
        }
        
        function clearAllUserFeedback() {
            if (confirm('Are you sure you want to delete ALL your feedback? This cannot be undone.')) {
                userFeedbackHistory.length = 0;
                document.getElementById('userFeedbackDisplay').innerHTML = '';
                updateAllCustomFeedbackList();
                showNotification('All feedback cleared!', 'success');
                
                // Refresh manager if open
                const modal = document.getElementById('genericModal');
                if (modal.style.display === 'block' && document.getElementById('genericModalTitle').textContent.includes('Feedback Manager')) {
                    refreshUserFeedbackManager();
                }
            }
        }
        
        function refreshUserFeedbackManager() {
            closeModal('genericModal');
            setTimeout(() => showUserFeedbackManager(), 100);
        }
        
        function editUserFeedbackInManager(feedbackId) {
            editUserFeedback(feedbackId);
        }
        
        function deleteUserFeedbackFromManager(feedbackId) {
            if (confirm('Are you sure you want to delete this feedback?')) {
                fetch('/delete_user_feedback', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: currentSession,
                        feedback_id: feedbackId
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification('Feedback deleted successfully!', 'success');
                        
                        // Remove from local history
                        const index = userFeedbackHistory.findIndex(item => item.id === feedbackId);
                        if (index !== -1) {
                            userFeedbackHistory.splice(index, 1);
                        }
                        
                        // Remove from display
                        const feedbackDiv = document.getElementById(`user-feedback-${feedbackId}`);
                        if (feedbackDiv) {
                            feedbackDiv.remove();
                        }
                        
                        updateAllCustomFeedbackList();
                        refreshUserFeedbackManager();
                    } else {
                        showNotification(data.error || 'Delete failed', 'error');
                    }
                })
                .catch(error => {
                    showNotification('Delete failed: ' + error.message, 'error');
                });
            }
        }
        
        function exportAllUserFeedback(format = 'json') {
            if (!currentSession) {
                showNotification('No active session', 'error');
                return;
            }
            
            window.location.href = `/export_user_feedback?session_id=${currentSession}&format=${format}`;
            showNotification(`Exporting feedback as ${format.toUpperCase()}...`, 'info');
        }
        
        // refreshUserFeedbackList function moved to user_feedback_management.js
        
        // Text Highlighting Functions moved to text_highlight_comments.js
        
        // Variables already declared in window scope in text_highlighting.js
        
        function saveHighlightedText() {
            if (!window.currentSelectedText || !window.currentSelectedRange) {
                showNotification('No text selected. Please select text first.', 'error');
                return;
            }
            
            // Create highlight
            const highlightId = `highlight_${++window.highlightCounter}_${Date.now()}`;
            
            try {
                // Create highlight span
                const highlightSpan = document.createElement('span');
                highlightSpan.className = 'text-highlight';
                highlightSpan.id = highlightId;
                highlightSpan.style.backgroundColor = window.currentHighlightColor;
                highlightSpan.style.padding = '2px 4px';
                highlightSpan.style.borderRadius = '3px';
                highlightSpan.style.cursor = 'pointer';
                highlightSpan.style.border = '1px solid rgba(0,0,0,0.2)';
                highlightSpan.title = 'Click to view or edit comment';
                
                // Wrap the selected text
                currentSelectedRange.surroundContents(highlightSpan);
                
                // Store highlight data
                const highlightData = {
                    id: highlightId,
                    text: currentSelectedText,
                    color: currentHighlightColor,
                    section: sections[currentSectionIndex],
                    timestamp: new Date().toISOString(),
                    comments: []
                };
                
                window.highlightedTexts.push(highlightData);
                
                // Clear selection
                window.getSelection().removeAllRanges();
                window.currentSelectedText = '';
                window.currentSelectedRange = null;
                
                // Hide save button
                document.getElementById('saveHighlightBtn').style.display = 'none';
                
                // Show comment dialog
                showHighlightCommentDialog(highlightId, highlightData.text);
                
            } catch (error) {
                console.error('Highlighting error:', error);
                showNotification('Could not highlight this text. Try selecting simpler text.', 'error');
            }
        }
        
        // clearHighlights function moved to text_highlight_comments.js
        
        function enableTextSelection() {
            const docContent = document.getElementById('documentContent');
            
            // Remove existing event listeners
            docContent.removeEventListener('mouseup', handleTextSelection);
            docContent.removeEventListener('click', handleHighlightClick);
            
            // Add new event listeners
            docContent.addEventListener('mouseup', handleTextSelection);
            docContent.addEventListener('click', handleHighlightClick);
        }
        
        function handleTextSelection(event) {
            const selection = window.getSelection();
            const selectedText = selection.toString().trim();
            
            if (selection.rangeCount === 0 || selectedText === '') {
                // Hide save button if no selection
                document.getElementById('saveHighlightBtn').style.display = 'none';
                currentSelectedText = '';
                currentSelectedRange = null;
                return;
            }
            
            if (selectedText.length < 3) {
                showNotification('Please select at least 3 characters to highlight.', 'error');
                return;
            }
            
            // Store current selection
            currentSelectedText = selectedText;
            currentSelectedRange = selection.getRangeAt(0).cloneRange();
            
            // Show save button
            const saveBtn = document.getElementById('saveHighlightBtn');
            saveBtn.style.display = 'inline-block';
            
            showNotification(`Text selected: "${selectedText.substring(0, 30)}${selectedText.length > 30 ? '...' : ''}". Click "Save & Comment" to add feedback.`, 'info');
        }
        
        function handleHighlightClick(event) {
            if (!event.target.classList.contains('text-highlight')) return;
            
            event.preventDefault();
            event.stopPropagation();
            
            const highlightId = event.target.id;
            const highlightData = highlightedTexts.find(h => h.id === highlightId);
            
            // Show options dialog for existing highlight
            showHighlightOptionsDialog(highlightId, highlightData ? highlightData.text : event.target.textContent);
        }
        
        function showHighlightOptionsDialog(highlightId, selectedText) {
            const highlightData = highlightedTexts.find(h => h.id === highlightId);
            const existingComments = highlightData ? highlightData.comments : [];
            
            const modalContent = `
                <div style="max-height: 70vh; overflow-y: auto; padding: 20px;">
                    <h3 style="color: #4f46e5; margin-bottom: 20px;"> Highlighted Text Options</h3>
                    
                    <div style="background: linear-gradient(135deg, #f8f9ff 0%, #e3f2fd 100%); padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 5px solid ${highlightData ? highlightData.color : 'yellow'};">
                        <h4 style="color: #4f46e5; margin-bottom: 10px;"> Highlighted Text:</h4>
                        <div style="background: white; padding: 10px; border-radius: 5px; font-style: italic; color: #333; border: 1px solid #ddd;">
                            "${selectedText.length > 200 ? selectedText.substring(0, 200) + '...' : selectedText}"
                        </div>
                    </div>
                    
                    ${existingComments.length > 0 ? `
                        <div style="margin-bottom: 20px;">
                            <h4 style="color: #2ecc71; margin-bottom: 10px;"> Existing Comments (${existingComments.length}):</h4>
                            ${existingComments.map((comment, index) => `
                                <div style="background: #e8f5e8; padding: 10px; margin: 5px 0; border-radius: 5px; border-left: 3px solid #2ecc71;">
                                    <div style="font-size: 0.9em; color: #27ae60; margin-bottom: 5px;">
                                        <strong>${comment.type.toUpperCase()}</strong> - ${comment.category}
                                    </div>
                                    <div>${comment.description}</div>
                                    <div style="font-size: 0.8em; color: #666; margin-top: 5px;">
                                        ${new Date(comment.timestamp).toLocaleString()}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                    
                    <div style="text-align: center; margin-bottom: 20px;">
                        <button class="btn btn-primary" onclick="closeModal('genericModal'); showHighlightCommentDialog('${highlightId}', '${selectedText.replace(/'/g, "\\'")}')">\u2795 Add New Comment</button>
                        <button class="btn btn-warning" onclick="removeHighlight('${highlightId}'); closeModal('genericModal');"> Remove Highlight</button>
                        <button class="btn btn-secondary" onclick="closeModal('genericModal')"> Close</button>
                    </div>
                </div>
            `;
            
            showModal('genericModal', 'Highlight Options', modalContent);
        }
        
        function removeHighlight(highlightId) {
            const highlightElement = document.getElementById(highlightId);
            if (highlightElement) {
                const parent = highlightElement.parentNode;
                parent.replaceChild(document.createTextNode(highlightElement.textContent), highlightElement);
                parent.normalize();
                
                // Remove from data
                highlightedTexts = highlightedTexts.filter(h => h.id !== highlightId);
                
                // Remove related feedback
                if (userFeedbackHistory) {
                    userFeedbackHistory = userFeedbackHistory.filter(item => item.highlight_id !== highlightId);
                }
                
                updateAllCustomFeedbackList();
                showNotification('Highlight removed!', 'success');
            }
        }
        
        function showHighlightCommentDialog(highlightId, selectedText) {
            const highlightData = highlightedTexts.find(h => h.id === highlightId);
            const existingComments = highlightData ? highlightData.comments : [];
            
            const modalContent = `
                <div style="max-height: 70vh; overflow-y: auto; padding: 20px;">
                    <h3 style="color: #4f46e5; margin-bottom: 20px;"> Add Comment to Highlighted Text</h3>
                    
                    <div style="background: linear-gradient(135deg, #f8f9ff 0%, #e3f2fd 100%); padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 5px solid ${currentHighlightColor};">
                        <h4 style="color: #4f46e5; margin-bottom: 10px;"> Selected Text:</h4>
                        <div style="background: white; padding: 10px; border-radius: 5px; font-style: italic; color: #333; border: 1px solid #ddd;">
                            "${selectedText.length > 200 ? selectedText.substring(0, 200) + '...' : selectedText}"
                        </div>
                    </div>
                    
                    ${existingComments.length > 0 ? `
                        <div style="margin-bottom: 20px;">
                            <h4 style="color: #2ecc71; margin-bottom: 10px;"> Existing Comments:</h4>
                            ${existingComments.map((comment, index) => `
                                <div style="background: #e8f5e8; padding: 10px; margin: 5px 0; border-radius: 5px; border-left: 3px solid #2ecc71;">
                                    <div style="font-size: 0.9em; color: #27ae60; margin-bottom: 5px;">
                                        <strong>${comment.type.toUpperCase()}</strong> - ${comment.category}
                                    </div>
                                    <div>${comment.description}</div>
                                    <div style="font-size: 0.8em; color: #666; margin-top: 5px;">
                                        ${new Date(comment.timestamp).toLocaleString()}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                    
                    <div style="background: white; padding: 20px; border-radius: 10px; border: 2px solid #4f46e5;">
                        <h4 style="color: #4f46e5; margin-bottom: 15px;"> Add New Comment</h4>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label style="font-weight: 600; color: #555; margin-bottom: 5px; display: block;"> Type:</label>
                                <select id="highlightCommentType" style="width: 100%; padding: 10px; border: 2px solid #4f46e5; border-radius: 8px;">
                                    <option value="suggestion">Suggestion</option>
                                    <option value="important">Important</option>
                                    <option value="critical">Critical</option>
                                    <option value="positive">Positive</option>
                                    <option value="question">Question</option>
                                    <option value="clarification">Clarification</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-weight: 600; color: #555; margin-bottom: 5px; display: block;"> Category:</label>
                                <select id="highlightCommentCategory" style="width: 100%; padding: 10px; border: 2px solid #4f46e5; border-radius: 8px;">
                                    <option value="Initial Assessment">Initial Assessment</option>
                                    <option value="Investigation Process">Investigation Process</option>
                                    <option value="Root Cause Analysis">Root Cause Analysis</option>
                                    <option value="Documentation and Reporting">Documentation and Reporting</option>
                                    <option value="Seller Classification">Seller Classification</option>
                                    <option value="Enforcement Decision-Making">Enforcement Decision-Making</option>
                                    <option value="Quality Control">Quality Control</option>
                                    <option value="Communication Standards">Communication Standards</option>
                                </select>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="font-weight: 600; color: #555; margin-bottom: 5px; display: block;"> Your Comment:</label>
                            <textarea id="highlightCommentText" placeholder="Add your comment about this highlighted text..." style="width: 100%; height: 100px; padding: 12px; border: 2px solid #4f46e5; border-radius: 8px; resize: vertical;"></textarea>
                        </div>
                        
                        <div style="text-align: center;">
                            <button class="btn btn-success" onclick="saveHighlightComment('${highlightId}')" style="padding: 12px 25px; margin: 5px; border-radius: 20px; font-weight: 600;"> Save Comment</button>
                            <button class="btn btn-warning" onclick="removeHighlight('${highlightId}'); closeModal('genericModal');" style="padding: 12px 25px; margin: 5px; border-radius: 20px;"> Remove Highlight</button>
                            <button class="btn btn-secondary" onclick="closeModal('genericModal')" style="padding: 12px 25px; margin: 5px; border-radius: 20px;"> Cancel</button>
                        </div>
                    </div>
                </div>
            `;
            
            showModal('genericModal', 'Highlight Comment', modalContent);
        }
        
        function saveHighlightComment(highlightId) {
            const type = document.getElementById('highlightCommentType').value;
            const category = document.getElementById('highlightCommentCategory').value;
            const description = document.getElementById('highlightCommentText').value.trim();
            
            if (!description) {
                showNotification('Please enter a comment description.', 'error');
                return;
            }
            
            const highlightData = highlightedTexts.find(h => h.id === highlightId);
            if (!highlightData) {
                showNotification('Highlight data not found.', 'error');
                return;
            }
            
            // Create comment data
            const commentData = {
                type: type,
                category: category,
                description: description,
                timestamp: new Date().toISOString(),
                highlight_id: highlightId,
                highlighted_text: highlightData.text
            };
            
            // Add to highlight data
            highlightData.comments.push(commentData);
            
            // Create feedback item for the custom feedback section
            const feedbackItem = {
                id: `highlight_feedback_${Date.now()}`,
                type: type,
                category: category,
                description: `[Highlighted Text: "${highlightData.text.substring(0, 50)}${highlightData.text.length > 50 ? '...' : ''}"] ${description}`,
                section: sections[currentSectionIndex],
                timestamp: new Date().toISOString(),
                user_created: true,
                highlight_id: highlightId,
                highlighted_text: highlightData.text,
                risk_level: type === 'critical' ? 'High' : type === 'important' ? 'Medium' : 'Low'
            };
            
            // Add to user feedback history
            userFeedbackHistory.push(feedbackItem);
            
            // Send to backend
            fetch('/add_custom_feedback', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    session_id: currentSession,
                    section_name: sections[currentSectionIndex],
                    type: type,
                    category: category,
                    description: feedbackItem.description,
                    highlight_id: highlightId,
                    highlighted_text: highlightData.text
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Comment added to highlighted text!', 'success');
                    displayUserFeedback(feedbackItem);
                    updateAllCustomFeedbackList();
                    updateStatistics();
                    
                    // Trigger real-time logs update
                    if (window.updateRealTimeFeedbackLogs) {
                        window.updateRealTimeFeedbackLogs();
                    }
                    
                    closeModal('genericModal');
                } else {
                    showNotification(data.error || 'Failed to save comment', 'error');
                }
            })
            .catch(error => {
                showNotification('Failed to save comment: ' + error.message, 'error');
            });
        }

        function updateRiskIndicator(feedbackItems) {
            const indicator = document.getElementById('riskIndicator');
            
            if (!feedbackItems || feedbackItems.length === 0) {
                indicator.className = 'risk-indicator risk-low';
                indicator.textContent = ' No Issues';
                return;
            }
            
            const highRisk = feedbackItems.filter(item => item.risk_level === 'High').length;
            const mediumRisk = feedbackItems.filter(item => item.risk_level === 'Medium').length;
            
            if (highRisk > 0) {
                indicator.className = 'risk-indicator risk-high';
                indicator.textContent = ` High Risk (${highRisk} issues)`;
            } else if (mediumRisk > 0) {
                indicator.className = 'risk-indicator risk-medium';
                indicator.textContent = ` Medium Risk (${mediumRisk} issues)`;
            } else {
                indicator.className = 'risk-indicator risk-low';
                indicator.textContent = ' Low Risk';
            }
        }

        function updateStatistics() {
            if (!currentSession) return;
            
            fetch(`/get_statistics?session_id=${currentSession}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayStatistics(data.statistics);
                }
            })
            .catch(error => {
                console.error('Failed to update statistics:', error);
            });
        }

        function displayStatistics(stats) {
            const container = document.getElementById('statsGrid');
            
            // Calculate percentages
            const total = stats.total_feedback || 1; // Avoid division by zero
            const acceptedPercent = ((stats.accepted || 0) / total * 100).toFixed(1);
            const highRiskPercent = ((stats.high_risk || 0) / total * 100).toFixed(1);
            const mediumRiskPercent = ((stats.medium_risk || 0) / total * 100).toFixed(1);
            const userAddedPercent = ((stats.user_added || 0) / total * 100).toFixed(1);
            
            container.innerHTML = `
                <div class="stat-item" onclick="showStatisticBreakdown('total_feedback')">
                    <div class="stat-number" style="color: #667eea;">${stats.total_feedback}</div>
                    <div class="stat-label">Total Feedback</div>
                    <div style="font-size: 0.8em; color: #95a5a6; margin-top: 5px;">100%</div>
                </div>
                <div class="stat-item" onclick="showStatisticBreakdown('high_risk')">
                    <div class="stat-number" style="color: #e74c3c;">${stats.high_risk}</div>
                    <div class="stat-label">High Risk</div>
                    <div style="font-size: 0.8em; color: #e74c3c; margin-top: 5px;">${highRiskPercent}%</div>
                </div>
                <div class="stat-item" onclick="showStatisticBreakdown('medium_risk')">
                    <div class="stat-number" style="color: #f39c12;">${stats.medium_risk}</div>
                    <div class="stat-label">Medium Risk</div>
                    <div style="font-size: 0.8em; color: #f39c12; margin-top: 5px;">${mediumRiskPercent}%</div>
                </div>
                <div class="stat-item" onclick="showStatisticBreakdown('accepted')">
                    <div class="stat-number" style="color: #2ecc71;">${stats.accepted}</div>
                    <div class="stat-label">Accepted</div>
                    <div style="font-size: 0.8em; color: #2ecc71; margin-top: 5px;">${acceptedPercent}%</div>
                </div>
                <div class="stat-item" onclick="showStatisticBreakdown('user_added')">
                    <div class="stat-number" style="color: #3498db;">${stats.user_added}</div>
                    <div class="stat-label">User Added</div>
                    <div style="font-size: 0.8em; color: #3498db; margin-top: 5px;">${userAddedPercent}%</div>
                </div>
            `;
        }

        function showStatisticBreakdown(statType) {
            if (!currentSession) {
                showNotification('No active session. Please upload a document first.', 'error');
                return;
            }
            
            fetch(`/get_statistics_breakdown?session_id=${currentSession}&stat_type=${statType}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const enhancedBreakdown = generateEnhancedBreakdown(data.breakdown, statType);
                    showModal('genericModal', `${statType.replace('_', ' ').toUpperCase()} - Detailed Analysis`, enhancedBreakdown);
                } else {
                    // Show fallback content when no data is available
                    const fallbackContent = generateEnhancedBreakdown(null, statType);
                    showModal('genericModal', `${statType.replace('_', ' ').toUpperCase()} - Detailed Analysis`, fallbackContent);
                }
            })
            .catch(error => {
                console.error('Statistics breakdown error:', error);
                const fallbackContent = generateEnhancedBreakdown(null, statType);
                showModal('genericModal', `${statType.replace('_', ' ').toUpperCase()} - Detailed Analysis`, fallbackContent);
            });
        }
        
        function generateEnhancedBreakdown(breakdown, statType) {
            // Handle undefined or null breakdown
            if (!breakdown) {
                return `
                    <div class="dashboard-card">
                        <h3 style="color: #667eea; margin-bottom: 20px;"> ${statType.replace('_', ' ').toUpperCase()} Analysis</h3>
                        <div style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 10px; color: #666;">
                            <h4>No Data Available</h4>
                            <p>No breakdown data found for ${statType.replace('_', ' ')}.</p>
                            <p>Upload and analyze a document to see detailed statistics.</p>
                        </div>
                    </div>
                `;
            }
            
            let html = `
                <div class="dashboard-card">
                    <h3 style="color: #667eea; margin-bottom: 20px;"> ${statType.replace('_', ' ').toUpperCase()} Analysis</h3>
                    
                    <div class="dashboard-grid">
                        <div class="dashboard-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                            <h4>Summary</h4>
                            <p>Total Items: <strong>${breakdown.total || 0}</strong></p>
                            <p>Sections Affected: <strong>${Object.keys(breakdown.by_section || {}).length}</strong></p>
                            <p>Categories: <strong>${Object.keys(breakdown.by_category || {}).length}</strong></p>
                        </div>
                        
                        <div class="dashboard-card">
                            <h4>By Section</h4>
                            <div style="max-height: 200px; overflow-y: auto;">
            `;
            
            if (breakdown.by_section) {
                Object.entries(breakdown.by_section).forEach(([section, count]) => {
                    const percentage = breakdown.total ? ((count / breakdown.total) * 100).toFixed(1) : 0;
                    html += `
                        <div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #eee;">
                            <span>${section}</span>
                            <span><strong>${count}</strong> (${percentage}%)</span>
                        </div>
                    `;
                });
            }
            
            html += `
                            </div>
                        </div>
                        
                        <div class="dashboard-card">
                            <h4>By Type/Category</h4>
                            <div style="max-height: 200px; overflow-y: auto;">
            `;
            
            if (breakdown.by_type) {
                Object.entries(breakdown.by_type).forEach(([type, count]) => {
                    const color = type === 'critical' ? '#e74c3c' : type === 'important' ? '#f39c12' : '#3498db';
                    html += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 5px 0;">
                            <span style="color: ${color}; font-weight: bold;">${type.toUpperCase()}</span>
                            <span><strong>${count}</strong></span>
                        </div>
                    `;
                });
            }
            
            html += `
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <h4>Recent Items</h4>
                        <div style="max-height: 300px; overflow-y: auto; background: #f8f9fa; padding: 15px; border-radius: 8px;">
            `;
            
            if (breakdown.items && breakdown.items.length > 0) {
                breakdown.items.slice(0, 10).forEach((item, index) => {
                    html += `
                        <div style="margin-bottom: 15px; padding: 10px; background: white; border-radius: 5px; border-left: 4px solid #667eea;">
                            <div style="font-weight: bold; color: #667eea;">${item.section || 'Unknown Section'}</div>
                            <div style="margin: 5px 0; color: #666;">${item.description || 'No description available'}</div>
                            <div style="font-size: 0.8em; color: #999;">
                                Type: ${item.type || 'Unknown'} | 
                                Risk: ${item.risk_level || 'Unknown'}
                            </div>
                        </div>
                    `;
                });
            } else {
                html += '<p style="text-align: center; color: #666;">No items available for display</p>';
            }
            
            html += `
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn btn-primary" onclick="exportStatistics('${statType}')">
                             Export ${statType.replace('_', ' ')} Data
                        </button>
                    </div>
                </div>
            `;
            
            return html;
        }

        function previousSection() {
            if (currentSectionIndex > 0) {
                loadSection(currentSectionIndex - 1);
            }
        }

        function nextSection() {
            if (currentSectionIndex < sections.length - 1) {
                loadSection(currentSectionIndex + 1);
            }
        }

        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`.tab:nth-child(${tabName === 'feedback' ? '1' : '2'})`).classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`${tabName}Tab`).classList.add('active');
        }
        
        function toggleAIPrismChat() {
            const chatContent = document.getElementById('aiPrismChatContent');
            if (chatContent.style.display === 'none') {
                chatContent.style.display = 'flex';
                chatContent.style.flexDirection = 'column';
            } else {
                chatContent.style.display = 'none';
            }
        }

        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                sendChatMessage();
            }
        }
        
        function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message to chat
            addChatMessage(message, 'user');
            input.value = '';
            
            // Add thinking message
            addChatMessage(' Thinking...', 'assistant', true);
            
            sendChatWithFallback(message, 0);
        }
        
        function sendChatWithFallback(message, modelIndex) {
            const modelToUse = modelFallbackOrder[modelIndex] || currentAIModel;
            
            fetch('/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    session_id: currentSession,
                    message: message,
                    current_section: sections[currentSectionIndex],
                    ai_model: modelToUse
                })
            })
            .then(response => response.json())
            .then(data => {
                // Remove thinking message
                const thinkingMessage = document.querySelector('.chat-message.thinking');
                if (thinkingMessage) {
                    thinkingMessage.remove();
                }
                
                if (data.success) {
                    addChatMessage(data.response, 'assistant', false, modelToUse);
                } else if (modelIndex < modelFallbackOrder.length - 1) {
                    // Try next model in fallback order
                    showNotification(`${availableModels[modelToUse]} failed, trying ${availableModels[modelFallbackOrder[modelIndex + 1]]}...`, 'info');
                    addChatMessage(' Switching to backup AI model...', 'assistant', true);
                    setTimeout(() => sendChatWithFallback(message, modelIndex + 1), 1000);
                } else {
                    addChatMessage('Sorry, all AI models are currently unavailable. Please try again later.', 'assistant');
                }
            })
            .catch(error => {
                if (modelIndex < modelFallbackOrder.length - 1) {
                    // Try next model in fallback order
                    showNotification(`Connection failed, trying backup AI model...`, 'info');
                    const thinkingMessage = document.querySelector('.chat-message.thinking');
                    if (thinkingMessage) {
                        thinkingMessage.innerHTML = '<strong> AI-Prism:</strong><br> Switching to backup AI model...';
                    }
                    setTimeout(() => sendChatWithFallback(message, modelIndex + 1), 1000);
                } else {
                    const thinkingMessage = document.querySelector('.chat-message.thinking');
                    if (thinkingMessage) {
                        thinkingMessage.remove();
                    }
                    addChatMessage('Sorry, all AI models are currently unavailable. Please try again later.', 'assistant');
                }
            });
        }
        
        function changeAIModel() {
            const select = document.getElementById('aiModelSelect');
            currentAIModel = select.value;
            currentModelIndex = modelFallbackOrder.indexOf(currentAIModel);
            
            showNotification(`Switched to ${availableModels[currentAIModel]}`, 'success');
            
            // Update chat header
            const lastMessage = document.querySelector('.chat-message.assistant:last-of-type');
            if (lastMessage) {
                const modelName = availableModels[currentAIModel].split(' (')[0];
                addChatMessage(`I'm now using ${modelName}. How can I help you?`, 'assistant', false, currentAIModel);
            }
        }
        
        function testAIModel() {
            const testMessage = 'Hello, please confirm you are working properly.';
            addChatMessage('Testing AI model...', 'user');
            addChatMessage(' Testing connection...', 'assistant', true);
            
            fetch('/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    session_id: currentSession,
                    message: testMessage,
                    current_section: sections[currentSectionIndex],
                    ai_model: currentAIModel
                })
            })
            .then(response => response.json())
            .then(data => {
                const thinkingMessage = document.querySelector('.chat-message.thinking');
                if (thinkingMessage) {
                    thinkingMessage.remove();
                }
                
                if (data.success) {
                    addChatMessage(` ${availableModels[currentAIModel]} is working properly!`, 'assistant', false, currentAIModel);
                } else {
                    addChatMessage(` ${availableModels[currentAIModel]} test failed. Please try a different model.`, 'assistant');
                }
            })
            .catch(error => {
                const thinkingMessage = document.querySelector('.chat-message.thinking');
                if (thinkingMessage) {
                    thinkingMessage.remove();
                }
                addChatMessage(` ${availableModels[currentAIModel]} connection failed.`, 'assistant');
            });
        }
        
        function regenerateResponse() {
            const chatMessages = document.querySelectorAll('.chat-message.user');
            if (chatMessages.length === 0) {
                showNotification('No previous message to regenerate', 'info');
                return;
            }
            
            const lastUserMessage = chatMessages[chatMessages.length - 1];
            const messageText = lastUserMessage.textContent.replace('You:', '').trim();
            
            // Remove last assistant response
            const assistantMessages = document.querySelectorAll('.chat-message.assistant');
            if (assistantMessages.length > 1) { // Keep the welcome message
                assistantMessages[assistantMessages.length - 1].remove();
            }
            
            // Regenerate with current model
            addChatMessage(' Regenerating response...', 'assistant', true);
            sendChatWithFallback(messageText, currentModelIndex);
        }

        function addChatMessage(message, sender, isThinking = false, aiModel = null) {
            const container = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}${isThinking ? ' thinking' : ''}`;
            
            const timestamp = new Date().toLocaleTimeString();
            
            if (sender === 'user') {
                messageDiv.innerHTML = `<strong> You:</strong> <small style="opacity: 0.7;">${timestamp}</small><br>${message}`;
                messageDiv.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                messageDiv.style.color = 'white';
                messageDiv.style.borderRadius = '12px';
                messageDiv.style.padding = '15px';
                messageDiv.style.margin = '10px';
                messageDiv.style.boxShadow = '0 3px 10px rgba(16, 185, 129, 0.3)';
                // Store in chat history
                if (!isThinking) {
                    chatHistory.push({ role: 'user', content: message, timestamp: timestamp });
                }
            } else {
                const modelName = aiModel ? availableModels[aiModel].split(' (')[0] : 'AI-Prism';
                messageDiv.innerHTML = `<strong>AI-Prism:</strong> <small style="opacity: 0.7;">${timestamp}</small><br>${message}`;
                messageDiv.style.background = 'linear-gradient(135deg, #6b7280, #4b5563)';
                messageDiv.style.color = 'white';
                messageDiv.style.borderRadius = '12px';
                messageDiv.style.padding = '15px';
                messageDiv.style.margin = '10px';
                messageDiv.style.boxShadow = '0 3px 10px rgba(107, 114, 128, 0.3)';
                if (!isThinking) {
                    // Store in chat history
                    chatHistory.push({ role: 'assistant', content: message, timestamp: timestamp, model: aiModel });
                }
            }
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        }



        function downloadDocument() {
            const filename = document.getElementById('downloadBtn').getAttribute('data-filename');
            if (filename) {
                window.location.href = `/download/${filename}`;
            } else {
                showNotification('No document available for download', 'error');
            }
        }
        
        function downloadStatistics() {
            if (!currentSession) {
                showNotification('No active session', 'error');
                return;
            }
            
            // Show format selection modal
            const modalContent = `
                <div style="text-align: center; padding: 20px;">
                    <h3 style="color: #667eea; margin-bottom: 20px;"> Download Statistics</h3>
                    <p style="margin-bottom: 30px;">Choose the format for your statistics export:</p>
                    
                    <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="downloadStatsFormat('json')" style="padding: 15px 25px;">
                             JSON Format
                        </button>
                        <button class="btn btn-success" onclick="downloadStatsFormat('csv')" style="padding: 15px 25px;">
                             CSV Format
                        </button>
                        <button class="btn btn-info" onclick="downloadStatsFormat('txt')" style="padding: 15px 25px;">
                             Text Format
                        </button>
                    </div>
                    
                    <p style="margin-top: 20px; font-size: 0.9em; color: #666;">
                        Statistics include feedback counts, risk levels, and section analysis.
                    </p>
                </div>
            `;
            
            showModal('genericModal', 'Download Statistics', modalContent);
        }
        
        function downloadStatsFormat(format) {
            closeModal('genericModal');
            window.location.href = `/download_statistics?session_id=${currentSession}&format=${format}`;
            showNotification(`Downloading statistics as ${format.toUpperCase()}...`, 'info');
        }

        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('dark-mode', isDarkMode);
            
            const button = document.getElementById('darkModeToggle');
            if (button) {
                button.textContent = isDarkMode ? ' Light Mode' : ' Dark Mode';
                button.className = isDarkMode ? 'btn btn-warning' : 'btn btn-secondary';
            }
            
            // Save preference
            localStorage.setItem('darkMode', isDarkMode.toString());
        }

        function showShortcuts() {
            document.getElementById('shortcutsModal').style.display = 'block';
        }

        function showTutorial() {
            showModal('genericModal', ' Interactive Tutorial', `
                <div>
                    <h4>Welcome to the Document Analysis Tool!</h4>
                    <p>This tool helps you review documents using the Hawkeye framework. Here's how to get started:</p>
                    
                    <ol>
                        <li><strong>Upload Document:</strong> Drag and drop or click to upload a .docx file</li>
                        <li><strong>Review Sections:</strong> Navigate through sections using the dropdown or arrow buttons</li>
                        <li><strong>Analyze Feedback:</strong> Review AI-generated feedback and accept/reject items</li>
                        <li><strong>Add Custom Feedback:</strong> Use the form to add your own insights</li>
                        <li><strong>Use Chat:</strong> Ask questions about feedback or guidelines</li>
                        <li><strong>Complete Review:</strong> Generate final document with comments</li>
                    </ol>
                    
                    <p><strong>Pro Tips:</strong></p>
                    <ul>
                        <li>Use keyboard shortcuts for faster navigation (press ? to see all shortcuts)</li>
                        <li>Click on statistics numbers to see detailed breakdowns</li>
                        <li>The AI learns from your feedback patterns over time</li>
                        <li>Toggle dark mode for comfortable viewing</li>
                    </ul>
                </div>
            `);
        }

        function showFAQ() {
            document.getElementById('faqModal').style.display = 'block';
        }

        function showPatterns() {
            if (!currentSession) {
                showNotification('No active session', 'error');
                return;
            }
            
            fetch(`/get_patterns?session_id=${currentSession}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    let html = `
                        <div style="max-height: 70vh; overflow-y: auto;">
                            <h3 style="color: #667eea; margin-bottom: 20px;"> Pattern Analysis Dashboard</h3>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 10px; text-align: center;">
                                    <div style="font-size: 2em; font-weight: bold;">${data.patterns.recurring_patterns.length}</div>
                                    <div>Recurring Patterns</div>
                                </div>
                                <div style="background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); color: white; padding: 15px; border-radius: 10px; text-align: center;">
                                    <div style="font-size: 2em; font-weight: bold;">${Object.keys(data.patterns.section_analysis || {}).length}</div>
                                    <div>Sections Analyzed</div>
                                </div>
                                <div style="background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); color: white; padding: 15px; border-radius: 10px; text-align: center;">
                                    <div style="font-size: 2em; font-weight: bold;">${Object.keys(data.patterns.category_trends || {}).length}</div>
                                    <div>Categories Found</div>
                                </div>
                            </div>
                    `;
                    
                    if (data.patterns.recurring_patterns.length === 0) {
                        html += '<div style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 10px; color: #666;"><h4>No Recurring Patterns Found</h4><p>Continue analyzing more sections to identify patterns across your document.</p></div>';
                    } else {
                        html += '<h4> Recurring Patterns Identified:</h4>';
                        
                        data.patterns.recurring_patterns.forEach((pattern, index) => {
                            html += `
                                <div style="margin: 15px 0; padding: 20px; border-left: 4px solid #667eea; background: #f8f9ff; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                                    <h5 style="color: #667eea; margin-bottom: 10px;">Pattern #${index + 1}: ${pattern.category}</h5>
                                    <p><strong>Description:</strong> ${pattern.pattern}</p>
                                    <p><strong>Sections Affected:</strong> ${pattern.occurrence_count} sections</p>
                                    <p><strong>Affected Sections:</strong> ${pattern.sections_affected ? pattern.sections_affected.join(', ') : 'Multiple sections'}</p>
                                    <details style="margin-top: 10px;">
                                        <summary style="cursor: pointer; font-weight: bold; color: #667eea;">View Examples</summary>
                                        <div style="margin-top: 10px; padding: 10px; background: white; border-radius: 5px;">
                                            ${pattern.examples.map(ex => `
                                                <div style="margin: 8px 0; padding: 8px; border-left: 3px solid ${ex.risk_level === 'High' ? '#e74c3c' : ex.risk_level === 'Medium' ? '#f39c12' : '#2ecc71'}; background: #fafafa;">
                                                    <strong>${ex.section || ex.document}:</strong> 
                                                    <span style="color: ${ex.risk_level === 'High' ? '#e74c3c' : ex.risk_level === 'Medium' ? '#f39c12' : '#2ecc71'}; font-weight: bold;">
                                                        ${ex.risk_level} Risk
                                                    </span><br>
                                                    <em>${ex.description}</em>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </details>
                                </div>
                            `;
                        });
                    }
                    
                    // Add risk distribution if available
                    if (data.patterns.risk_distribution) {
                        html += `
                            <h4> Risk Distribution:</h4>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 15px 0;">
                                <div style="text-align: center; padding: 15px; background: #ffeaea; border-radius: 8px;">
                                    <div style="font-size: 1.5em; font-weight: bold; color: #e74c3c;">${data.patterns.risk_distribution.High || 0}</div>
                                    <div>High Risk</div>
                                </div>
                                <div style="text-align: center; padding: 15px; background: #fff3cd; border-radius: 8px;">
                                    <div style="font-size: 1.5em; font-weight: bold; color: #f39c12;">${data.patterns.risk_distribution.Medium || 0}</div>
                                    <div>Medium Risk</div>
                                </div>
                                <div style="text-align: center; padding: 15px; background: #e8f5e8; border-radius: 8px;">
                                    <div style="font-size: 1.5em; font-weight: bold; color: #2ecc71;">${data.patterns.risk_distribution.Low || 0}</div>
                                    <div>Low Risk</div>
                                </div>
                            </div>
                        `;
                    }
                    
                    html += `
                            <div style="text-align: center; margin-top: 20px; padding-top: 20px; border-top: 2px solid #ecf0f1;">
                                <button class="btn btn-primary" onclick="exportPatterns()" style="margin: 5px;">
                                     Export Pattern Analysis
                                </button>
                                <button class="btn btn-info" onclick="refreshPatterns()" style="margin: 5px;">
                                     Refresh Analysis
                                </button>
                            </div>
                        </div>
                    `;
                    
                    showModal('genericModal', ' Pattern Analysis', html);
                } else {
                    showNotification(data.error || 'Failed to load patterns', 'error');
                }
            })
            .catch(error => {
                showNotification('Failed to load patterns: ' + error.message, 'error');
            });
        }
        
        function exportPatterns() {
            if (!currentSession) {
                showNotification('No active session', 'error');
                return;
            }
            
            fetch(`/get_patterns?session_id=${currentSession}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const exportData = {
                        export_timestamp: new Date().toISOString(),
                        session_id: currentSession,
                        patterns: data.patterns
                    };
                    
                    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `patterns_analysis_${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    showNotification('Pattern analysis exported successfully!', 'success');
                } else {
                    showNotification('Export failed: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                showNotification('Export failed: ' + error.message, 'error');
            });
        }
        
        function refreshPatterns() {
            closeModal('genericModal');
            setTimeout(() => showPatterns(), 100);
        }

        function showLogs() {
            if (!currentSession) {
                showNotification('No active session', 'error');
                return;
            }
            
            fetch(`/get_logs?session_id=${currentSession}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    let html = '<h4> Activity Logs</h4>';
                    html += '<div style="max-height: 400px; overflow-y: auto;">';
                    
                    if (data.logs.length === 0) {
                        html += '<p>No activity logs available.</p>';
                    } else {
                        html += '<table style="width: 100%; border-collapse: collapse;">';
                        html += '<tr><th style="text-align: left; padding: 8px; border-bottom: 1px solid #eee;">Time</th><th style="text-align: left; padding: 8px; border-bottom: 1px solid #eee;">Action</th><th style="text-align: left; padding: 8px; border-bottom: 1px solid #eee;">Details</th></tr>';
                        
                        data.logs.forEach(log => {
                            const time = new Date(log.timestamp).toLocaleTimeString();
                            html += `
                                <tr>
                                    <td style="padding: 8px; border-bottom: 1px solid #eee;">${time}</td>
                                    <td style="padding: 8px; border-bottom: 1px solid #eee;">${log.action}</td>
                                    <td style="padding: 8px; border-bottom: 1px solid #eee;">${log.details}</td>
                                </tr>
                            `;
                        });
                        
                        html += '</table>';
                    }
                    
                    html += '</div>';
                    showModal('genericModal', ' Activity Logs', html);
                } else {
                    showNotification(data.error || 'Failed to load logs', 'error');
                }
            })
            .catch(error => {
                showNotification('Failed to load logs: ' + error.message, 'error');
            });
        }

        function showLearning() {
            if (!currentSession) {
                showNotification('No active session', 'error');
                return;
            }
            
            fetch(`/get_learning_status?session_id=${currentSession}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const status = data.learning_status;
                    
                    let html = `
                        <div style="max-height: 70vh; overflow-y: auto;">
                            <h3 style="color: #667eea; margin-bottom: 20px;"> AI Learning System Dashboard</h3>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 10px; text-align: center;">
                                    <div style="font-size: 2em; font-weight: bold;">${status.total_ai_feedback || 0}</div>
                                    <div style="font-size: 0.9em;">AI Feedback Items</div>
                                </div>
                                <div style="background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); color: white; padding: 15px; border-radius: 10px; text-align: center;">
                                    <div style="font-size: 2em; font-weight: bold;">${status.accepted_feedback_count || 0}</div>
                                    <div style="font-size: 0.9em;">Accepted</div>
                                </div>
                                <div style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; padding: 15px; border-radius: 10px; text-align: center;">
                                    <div style="font-size: 2em; font-weight: bold;">${status.rejected_feedback_count || 0}</div>
                                    <div style="font-size: 0.9em;">Rejected</div>
                                </div>
                                <div style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); color: white; padding: 15px; border-radius: 10px; text-align: center;">
                                    <div style="font-size: 2em; font-weight: bold;">${status.custom_feedback_count || 0}</div>
                                    <div style="font-size: 0.9em;">User Added</div>
                                </div>
                            </div>
                            
                            <div style="background: linear-gradient(135deg, #f8f9ff 0%, #e3f2fd 100%); padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 2px solid #667eea;">
                                <h4 style="color: #667eea; margin-bottom: 15px;"> Learning Performance</h4>
                                <div style="margin-bottom: 15px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                        <span>Acceptance Rate</span>
                                        <span style="font-weight: bold; color: ${status.acceptance_rate > 70 ? '#2ecc71' : status.acceptance_rate > 40 ? '#f39c12' : '#e74c3c'};">${status.acceptance_rate || 0}%</span>
                                    </div>
                                    <div style="background: #ecf0f1; height: 10px; border-radius: 5px; overflow: hidden;">
                                        <div style="background: ${status.acceptance_rate > 70 ? '#2ecc71' : status.acceptance_rate > 40 ? '#f39c12' : '#e74c3c'}; height: 100%; width: ${status.acceptance_rate || 0}%; transition: width 0.3s ease;"></div>
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 15px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                        <span>User Engagement Score</span>
                                        <span style="font-weight: bold; color: ${status.user_engagement_score > 30 ? '#2ecc71' : status.user_engagement_score > 15 ? '#f39c12' : '#e74c3c'};">${status.user_engagement_score || 0}%</span>
                                    </div>
                                    <div style="background: #ecf0f1; height: 10px; border-radius: 5px; overflow: hidden;">
                                        <div style="background: ${status.user_engagement_score > 30 ? '#2ecc71' : status.user_engagement_score > 15 ? '#f39c12' : '#e74c3c'}; height: 100%; width: ${status.user_engagement_score || 0}%; transition: width 0.3s ease;"></div>
                                    </div>
                                </div>
                                
                                <div style="text-align: center; padding: 10px; background: ${status.learning_active ? '#e8f5e8' : '#ffeaea'}; border-radius: 8px;">
                                    <span style="color: ${status.learning_active ? '#2ecc71' : '#e74c3c'}; font-weight: bold;">
                                        AI Learning: ${status.learning_active ? ' Active' : ' Inactive'}
                                    </span>
                                </div>
                            </div>
                    `;
                    
                    if (status.learning_insights && status.learning_insights.length > 0) {
                        html += `
                            <div style="background: white; padding: 20px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                                <h4 style="color: #667eea; margin-bottom: 15px;"> Learning Insights</h4>
                                <ul style="margin: 0; padding-left: 20px;">
                                    ${status.learning_insights.map(insight => `<li style="margin-bottom: 8px; color: #2c3e50;">${insight}</li>`).join('')}
                                </ul>
                            </div>
                        `;
                    }
                    
                    if (status.improvement_suggestions && status.improvement_suggestions.length > 0) {
                        html += `
                            <div style="background: #fff3cd; padding: 20px; border-radius: 15px; border-left: 5px solid #f39c12; margin-bottom: 20px;">
                                <h4 style="color: #f39c12; margin-bottom: 15px;"> Improvement Suggestions</h4>
                                <ul style="margin: 0; padding-left: 20px;">
                                    ${status.improvement_suggestions.map(suggestion => `<li style="margin-bottom: 8px; color: #856404;">${suggestion}</li>`).join('')}
                                </ul>
                            </div>
                        `;
                    }
                    
                    html += `
                            <div style="background: #f0fff4; padding: 20px; border-radius: 15px; border-left: 5px solid #2ecc71;">
                                <h4 style="color: #2ecc71; margin-bottom: 10px;"> How AI Learning Works</h4>
                                <p style="margin: 0; color: #27ae60; line-height: 1.6;">
                                    AI-Prism continuously learns from your feedback patterns. When you accept, reject, or add custom feedback, 
                                    the AI adapts to provide more relevant suggestions that match your preferences and standards.
                                </p>
                            </div>
                            
                            <div style="text-align: center; margin-top: 20px; padding-top: 20px; border-top: 2px solid #ecf0f1;">
                                <button class="btn btn-primary" onclick="exportLearningData()" style="margin: 5px;">
                                     Export Learning Data
                                </button>
                                <button class="btn btn-info" onclick="refreshLearning()" style="margin: 5px;">
                                     Refresh Status
                                </button>
                            </div>
                        </div>
                    `;
                    
                    showModal('genericModal', ' AI Learning System', html);
                } else {
                    showNotification(data.error || 'Failed to load learning status', 'error');
                }
            })
            .catch(error => {
                showNotification('Failed to load learning status: ' + error.message, 'error');
            });
        }
        
        function exportLearningData() {
            if (!currentSession) {
                showNotification('No active session', 'error');
                return;
            }
            
            fetch(`/get_learning_status?session_id=${currentSession}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const exportData = {
                        export_timestamp: new Date().toISOString(),
                        session_id: currentSession,
                        learning_status: data.learning_status
                    };
                    
                    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `learning_data_${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    showNotification('Learning data exported successfully!', 'success');
                } else {
                    showNotification('Export failed: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                showNotification('Export failed: ' + error.message, 'error');
            });
        }
        
        function refreshLearning() {
            closeModal('genericModal');
            setTimeout(() => showLearning(), 100);
        }

        function resetSession() {
            if (confirm('Are you sure you want to reset the session? All progress and document data will be permanently erased.')) {
                fetch('/reset_session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Reset all variables
                        analysisFile = null;
                        guidelinesFile = null;
                        chatHistory = [];
                        finalDocumentData = null;
                        currentSession = null;
                        sections = [];
                        currentSectionIndex = 0;
                        
                        // Reset UI elements
                        document.getElementById('analysisFileName').textContent = '';
                        document.getElementById('guidelinesFileName').textContent = '';
                        document.getElementById('startAnalysisBtn').disabled = true;
                        document.getElementById('chatContainer').innerHTML = `
                            <div class="chat-message assistant" style="background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); color: white; border-radius: 12px; padding: 20px; margin: 10px; box-shadow: 0 5px 15px rgba(79, 70, 229, 0.3);">
                                <strong>AI-Prism - Document Analysis Assistant:</strong><br><br>
                                I'm AI-Prism, your AI assistant for document analysis using the Hawkeye framework. I provide:<br><br>
                                 <strong>Document analysis</strong> based on Hawkeye 20-point checklist<br>
                                 <strong>Risk assessment</strong> and compliance guidance<br>
                                 <strong>Quality standards</strong> verification<br>
                                 <strong>Process improvement</strong> recommendations<br>
                                 <strong>Guidelines clarification</strong> and interpretation<br><br>
                                How can I assist with your document analysis today?<br><br>
                                <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 8px; margin-top: 15px; font-size: 0.9em;">
                                    <strong>Ask me about:</strong><br>
                                     "What does this feedback mean?"<br>
                                     "How can I improve this section?"<br>
                                     "Explain the Hawkeye framework"<br>
                                     "What are the risk levels?"<br>
                                </div>
                            </div>
                        `;
                        
                        // Hide main content
                        document.getElementById('mainContent').style.display = 'none';
                        document.getElementById('statisticsPanel').style.display = 'none';
                        document.getElementById('actionButtons').style.display = 'none';
                        
                        showNotification('Session reset successfully - All data erased', 'success');
                    } else {
                        showNotification(data.error || 'Reset failed', 'error');
                    }
                })
                .catch(error => {
                    showNotification('Reset failed: ' + error.message, 'error');
                });
            }
        }

        function showModal(modalId, title, content) {
            document.getElementById('genericModalTitle').textContent = title;
            document.getElementById('genericModalContent').innerHTML = content;
            document.getElementById(modalId).style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function showProgress(text) {
            // Show document processing progress
            const docProgress = document.getElementById('documentProgress');
            const progressGif = document.getElementById('progressGif');
            const progressTitle = document.getElementById('progressTitle');
            const progressDesc = document.getElementById('progressDesc');
            
            if (docProgress && progressGif && progressTitle && progressDesc) {
                // Start with random media from new collection
                usedMediaIndices = [];
                currentMediaIndex = Math.floor(Math.random() * loadingMediaWithContent.length);
                const initialMedia = loadingMediaWithContent[currentMediaIndex];
                
                progressGif.src = showGraphics ? initialMedia.gif : 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="150" height="150" viewBox="0 0 150 150"><rect width="150" height="150" fill="%23f0f0f0"/><text x="75" y="75" text-anchor="middle" dy=".3em" font-family="Arial" font-size="14" fill="%23666">Processing...</text></svg>';
                
                usedMediaIndices.push(currentMediaIndex);
                currentContentType = 'gif';
                
                // Start enhanced media rotation every 5 seconds
                if (showGraphics && !isMediaRotating) {
                    startMediaRotation(progressGif);
                }
                
                // Expanded funny messages with categories
                const funnyMessages = [
                    ' AI-Prism is analyzing your document like a pro...',
                    ' AI-Prism is reading every word with eagle eyes...',
                    ' AI-Prism is applying Hawkeye framework magic...',
                    ' AI-Prism is thinking deeper than Sherlock Holmes...',
                    ' AI-Prism is cross-referencing like a detective...',
                    ' AI-Prism is channeling inner movie critic...',
                    ' AI-Prism is as focused as a cat hunting...',
                    ' AI-Prism is painting a masterpiece of analysis...',
                    ' AI-Prism is launching into analytical orbit...',
                    ' AI-Prism is performing document analysis circus...',
                    ' AI-Prism is calculating like Einstein...',
                    ' AI-Prism is dramatically reviewing your content...'
                ];
                
                const funnySubtexts = [
                    'Please wait while I channel my inner genius',
                    'This might take a moment, but magic is happening!',
                    'Analyzing with 20-point investigation framework',
                    'Quality analysis requires deep thinking time',
                    'Almost done with the analytical deep dive',
                    'Crunching numbers like a mathematical wizard',
                    'Processing with the power of a thousand calculators',
                    'Reviewing with the precision of a Swiss watch',
                    'Analyzing faster than a speeding bullet',
                    'Working harder than a busy bee in spring',
                    'Thinking more intensely than a chess grandmaster',
                    'Investigating with detective-level thoroughness'
                ];
                
                progressTitle.textContent = funnyMessages[Math.floor(Math.random() * funnyMessages.length)];
                progressDesc.textContent = funnySubtexts[Math.floor(Math.random() * funnySubtexts.length)];
                
                docProgress.style.display = 'block';
            }
            
            // Also show regular progress
            const progressContainer = document.getElementById('progressContainer');
            const progressText = document.getElementById('progressText');
            const progressFill = document.getElementById('progressFill');
            
            if (progressContainer) progressContainer.style.display = 'block';
            if (progressText) progressText.textContent = text;
            if (progressFill) progressFill.style.width = '100%';
        }

        function hideProgress() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');
            const analysisProgressPanel = document.getElementById('analysisProgressPanel');
            const docProgress = document.getElementById('documentProgress');
            
            if (loadingOverlay) loadingOverlay.style.display = 'none';
            if (progressContainer) progressContainer.style.display = 'none';
            if (progressFill) progressFill.style.width = '0%';
            if (analysisProgressPanel) analysisProgressPanel.style.display = 'none';
            if (docProgress) docProgress.style.display = 'none';
            
            // Stop media rotation
            stopMediaRotation();
        }
        
        function startMediaRotation(gifElement) {
            if (isMediaRotating) return;
            
            isMediaRotating = true;
            usedMediaIndices = []; // Reset used indices
            
            mediaRotationInterval = setInterval(() => {
                if (showGraphics && gifElement && gifElement.style.display !== 'none') {
                    rotateMediaContent(gifElement);
                } else {
                    stopMediaRotation();
                }
            }, 5000); // Change every 5 seconds
        }
        
        function rotateMediaContent(gifElement) {
            // Get next unused media index
            let nextIndex = getNextUnusedMediaIndex();
            currentMediaIndex = nextIndex;
            
            const mediaItem = loadingMediaWithContent[currentMediaIndex];
            const progressTitle = document.getElementById('progressTitle');
            const progressDesc = document.getElementById('progressDesc');
            
            // Cycle through content types: gif -> joke -> math -> gif...
            if (currentContentType === 'gif') {
                // Show GIF with transition
                gifElement.style.opacity = '0.3';
                setTimeout(() => {
                    gifElement.src = mediaItem.gif;
                    gifElement.style.opacity = '1';
                }, 300);
                
                if (progressTitle) progressTitle.textContent = ' Enjoying some visual entertainment...';
                if (progressDesc) progressDesc.textContent = 'AI-Prism is working hard while you watch funny memes!';
                currentContentType = 'joke';
                
            } else if (currentContentType === 'joke') {
                // Show joke
                if (progressTitle) progressTitle.textContent = ' Here\'s a joke while you wait...';
                if (progressDesc) progressDesc.textContent = mediaItem.joke;
                currentContentType = 'math';
                
            } else if (currentContentType === 'math') {
                // Show math problem
                if (progressTitle) progressTitle.textContent = ' Brain Exercise Time!';
                if (progressDesc) progressDesc.textContent = mediaItem.math;
                currentContentType = 'gif';
            }
        }
        
        function getNextUnusedMediaIndex() {
            // If all media has been used, reset the used list
            if (usedMediaIndices.length >= loadingMediaWithContent.length) {
                usedMediaIndices = [];
            }
            
            let availableIndices = [];
            for (let i = 0; i < loadingMediaWithContent.length; i++) {
                if (!usedMediaIndices.includes(i)) {
                    availableIndices.push(i);
                }
            }
            
            // Pick random from available
            const randomIndex = Math.floor(Math.random() * availableIndices.length);
            const selectedIndex = availableIndices[randomIndex];
            
            // Mark as used
            usedMediaIndices.push(selectedIndex);
            
            return selectedIndex;
        }
        
        function stopMediaRotation() {
            if (mediaRotationInterval) {
                clearInterval(mediaRotationInterval);
                mediaRotationInterval = null;
            }
            isMediaRotating = false;
        }
        
        function toggleGraphics() {
            showGraphics = !showGraphics;
            const btn = document.getElementById('toggleGraphicsBtn');
            const gif = document.getElementById('loadingGif');
            const analysisGif = document.getElementById('analysisGif');
            
            btn.textContent = showGraphics ? ' Hide' : ' Show';
            
            if (gif) {
                gif.style.display = showGraphics ? 'block' : 'none';
            }
            if (analysisGif) {
                analysisGif.style.display = showGraphics ? 'block' : 'none';
            }
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        function exportChatHistory() {
            if (chatHistory.length === 0) {
                showNotification('No conversation history to export', 'info');
                return;
            }
            
            let exportContent = `AI-Prism Conversation Export\n`;
            exportContent += `Generated on: ${new Date().toLocaleString()}\n`;
            exportContent += `Total Messages: ${chatHistory.length}\n`;
            exportContent += `Session ID: ${currentSession || 'N/A'}\n\n`;
            exportContent += '='.repeat(50) + '\n\n';
            
            chatHistory.forEach((msg, index) => {
                const speaker = msg.role === 'user' ? 'You' : 'AI-Prism';
                exportContent += `[${msg.timestamp}] ${speaker}:\n${msg.content}\n\n`;
            });
            
            // Create and download file
            const blob = new Blob([exportContent], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `AI-Prism_Conversation_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showNotification('AI-Prism conversation exported successfully!', 'success');
        }
        
        function completeReview() {
            if (!currentSession) {
                showNotification('No active session', 'error');
                return;
            }
            
            showProgress('Preparing final review...');
            
            fetch('/complete_review', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    session_id: currentSession
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    finalDocumentData = data;
                    showFinalReviewModal(data);
                } else {
                    showNotification(data.error || 'Review completion failed', 'error');
                }
                hideProgress();
            })
            .catch(error => {
                showNotification('Review completion failed: ' + error.message, 'error');
                hideProgress();
            });
        }
        
        function showFinalReviewModal(data) {
            const content = document.getElementById('finalReviewContent');
            
            content.innerHTML = `
                <div style="text-align: center; margin-bottom: 30px;">
                    <h2 style="color: #667eea;"> Review Complete!</h2>
                    <p style="font-size: 1.2em; color: #555;">AI-Prism has finished analyzing your document</p>
                </div>
                
                <div style="background: linear-gradient(135deg, #f8f9ff 0%, #e3f2fd 100%); padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                    <h3 style="color: #667eea; margin-bottom: 15px;"> Review Summary</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div style="text-align: center; padding: 15px; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                            <div style="font-size: 2em; font-weight: bold; color: #667eea;">${data.comments_count || 0}</div>
                            <div style="color: #666;">Total Comments Added</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                            <div style="font-size: 2em; font-weight: bold; color: #2ecc71;">${sections.length || 0}</div>
                            <div style="color: #666;">Sections Analyzed</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                            <div style="font-size: 2em; font-weight: bold; color: #f39c12;">${chatHistory.length || 0}</div>
                            <div style="color: #666;">AI-Prism Interactions</div>
                        </div>
                    </div>
                </div>
                
                <div style="background: #f0fff4; padding: 20px; border-radius: 15px; border-left: 5px solid #2ecc71;">
                    <h4 style="color: #2ecc71; margin-bottom: 10px;"> What's Included in Your Document:</h4>
                    <ul style="margin: 0; padding-left: 20px;">
                        <li>All accepted AI feedback as Word comments</li>
                        <li>Your custom feedback and insights</li>
                        <li>Risk level classifications</li>
                        <li>Hawkeye framework references</li>
                        <li>Detailed suggestions and examples</li>
                    </ul>
                </div>
                
                <div style="background: #fff3cd; padding: 20px; border-radius: 15px; border-left: 5px solid #f39c12; margin-top: 20px;">
                    <h4 style="color: #f39c12; margin-bottom: 10px;"> Important Note:</h4>
                    <p style="margin: 0;">Once you approve and download, this session will be cleared. Make sure you're satisfied with all feedback before proceeding.</p>
                </div>
            `;
            
            document.getElementById('finalReviewModal').style.display = 'block';
        }
        
        function confirmFinalDownload() {
            if (!finalDocumentData) {
                showNotification('No document data available', 'error');
                return;
            }
            
            // Download the document
            window.location.href = `/download/${finalDocumentData.output_file}`;
            
            // Close modal and show success
            closeModal('finalReviewModal');
            showNotification(`Document downloaded successfully! ${finalDocumentData.comments_count} comments added.`, 'success');
            
            // Enable download button for future downloads
            document.getElementById('downloadBtn').disabled = false;
            document.getElementById('downloadBtn').setAttribute('data-filename', finalDocumentData.output_file);
        }

        // Close modals when clicking outside
        window.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        });
        
        
        function revertAllFeedback() {
            if (confirm('Are you sure you want to revert ALL feedback? This will undo all accept/reject actions.')) {
                fetch('/revert_all_feedback', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: currentSession })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification('All feedback reverted successfully!', 'success');
                        loadSection(currentSectionIndex); // Reload current section
                        updateStatistics();
                    } else {
                        showNotification(data.error || 'Revert failed', 'error');
                    }
                });
            }
        }
        
        function updateFeedback() {
            showModal('genericModal', 'Update Feedback', `
                <div style="text-align: center; padding: 20px;">
                    <h3>Update Feedback Options</h3>
                    <div style="margin: 20px 0;">
                        <button class="btn btn-primary" onclick="updateSpecificFeedback()" style="margin: 10px;">
                             Update Specific Feedback
                        </button>
                        <button class="btn btn-warning" onclick="reanalyzeAllSections()" style="margin: 10px;">
                             Re-analyze All Sections
                        </button>
                        <button class="btn btn-info" onclick="updateGuidelines()" style="margin: 10px;">
                             Update Guidelines
                        </button>
                    </div>
                </div>
            `);
        }
        
        function showDashboard() {
            fetch(`/get_dashboard_data?session_id=${currentSession}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const dashboardHtml = generateDashboardHtml(data.dashboard);
                    showModal('genericModal', ' Analytics Dashboard', dashboardHtml);
                    
                    setTimeout(() => {
                        createDashboardCharts(data.dashboard);
                    }, 100);
                } else {
                    showNotification('Failed to load dashboard data', 'error');
                }
            })
            .catch(error => {
                showNotification('Dashboard error: ' + error.message, 'error');
            });
        }
        
        function createDashboardCharts(data) {
            const pieCanvas = document.getElementById('feedbackPieChart');
            if (pieCanvas) {
                const pieCtx = pieCanvas.getContext('2d');
                const total = (data.acceptedFeedback || 0) + (data.rejectedFeedback || 0) + (data.userFeedback || 0);
                
                if (total > 0) {
                    drawPieChart(pieCtx, [
                        { label: 'Accepted', value: data.acceptedFeedback || 0, color: '#2ecc71' },
                        { label: 'Rejected', value: data.rejectedFeedback || 0, color: '#e74c3c' },
                        { label: 'User Added', value: data.userFeedback || 0, color: '#3498db' }
                    ]);
                } else {
                    pieCtx.fillStyle = '#666';
                    pieCtx.font = '16px Arial';
                    pieCtx.textAlign = 'center';
                    pieCtx.fillText('No data available', 150, 100);
                }
            }
            
            const barCanvas = document.getElementById('riskBarChart');
            if (barCanvas) {
                const barCtx = barCanvas.getContext('2d');
                drawBarChart(barCtx, [
                    { label: 'High', value: Math.floor(Math.random() * 10) + 1, color: '#e74c3c' },
                    { label: 'Medium', value: Math.floor(Math.random() * 15) + 5, color: '#f39c12' },
                    { label: 'Low', value: Math.floor(Math.random() * 20) + 10, color: '#2ecc71' }
                ]);
            }
        }
        
        function drawPieChart(ctx, data) {
            const centerX = 150;
            const centerY = 100;
            const radius = 80;
            let currentAngle = 0;
            const total = data.reduce((sum, item) => sum + item.value, 0);
            
            data.forEach(item => {
                const sliceAngle = (item.value / total) * 2 * Math.PI;
                
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
                ctx.closePath();
                ctx.fillStyle = item.color;
                ctx.fill();
                
                const labelAngle = currentAngle + sliceAngle / 2;
                const labelX = centerX + Math.cos(labelAngle) * (radius + 20);
                const labelY = centerY + Math.sin(labelAngle) * (radius + 20);
                
                ctx.fillStyle = '#333';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(`${item.label}: ${item.value}`, labelX, labelY);
                
                currentAngle += sliceAngle;
            });
        }
        
        function drawBarChart(ctx, data) {
            const maxValue = Math.max(...data.map(item => item.value));
            const barWidth = 80;
            const barSpacing = 20;
            const chartHeight = 150;
            const startX = 30;
            const startY = 180;
            
            data.forEach((item, index) => {
                const barHeight = (item.value / maxValue) * chartHeight;
                const x = startX + index * (barWidth + barSpacing);
                const y = startY - barHeight;
                
                ctx.fillStyle = item.color;
                ctx.fillRect(x, y, barWidth, barHeight);
                
                ctx.fillStyle = '#333';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(item.value.toString(), x + barWidth/2, y - 5);
                ctx.fillText(item.label, x + barWidth/2, startY + 15);
            });
        }
        
        function generateDashboardHtml(data) {
            // Calculate percentages
            const totalFeedback = (data.acceptedFeedback || 0) + (data.rejectedFeedback || 0) + (data.userFeedback || 0) || 1;
            const acceptedPercent = ((data.acceptedFeedback || 0) / totalFeedback * 100).toFixed(1);
            const rejectedPercent = ((data.rejectedFeedback || 0) / totalFeedback * 100).toFixed(1);
            const userPercent = ((data.userFeedback || 0) / totalFeedback * 100).toFixed(1);
            
            return `
                <div class="dashboard-container" style="max-height: 80vh; overflow-y: auto;">
                    <div class="dashboard-grid">
                        <div class="dashboard-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                            <h3> Documents Reviewed</h3>
                            <div style="font-size: 2.5em; font-weight: bold;">${data.totalDocuments || 0}</div>
                            <p>Total sessions completed</p>
                            <div style="font-size: 0.9em; opacity: 0.8; margin-top: 5px;">100% Coverage</div>
                        </div>
                        
                        <div class="dashboard-card" style="background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); color: white;">
                            <h3> Accepted Feedback</h3>
                            <div style="font-size: 2.5em; font-weight: bold;">${data.acceptedFeedback || 0}</div>
                            <p>Items accepted by user</p>
                            <div style="font-size: 0.9em; opacity: 0.8; margin-top: 5px;">${acceptedPercent}% of total</div>
                        </div>
                        
                        <div class="dashboard-card" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white;">
                            <h3> Rejected Feedback</h3>
                            <div style="font-size: 2.5em; font-weight: bold;">${data.rejectedFeedback || 0}</div>
                            <p>Items rejected by user</p>
                            <div style="font-size: 0.9em; opacity: 0.8; margin-top: 5px;">${rejectedPercent}% of total</div>
                        </div>
                        
                        <div class="dashboard-card" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); color: white;">
                            <h3> User Feedback</h3>
                            <div style="font-size: 2.5em; font-weight: bold;">${data.userFeedback || 0}</div>
                            <p>Custom feedback added</p>
                            <div style="font-size: 0.9em; opacity: 0.8; margin-top: 5px;">${userPercent}% of total</div>
                        </div>
                    </div>
                    
                    <div class="dashboard-grid" style="grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="dashboard-card">
                            <h3> Feedback Distribution</h3>
                            <div class="chart-container" style="height: 250px; position: relative;">
                                <canvas id="feedbackPieChart" width="300" height="200"></canvas>
                            </div>
                        </div>
                        
                        <div class="dashboard-card">
                            <h3> Risk Level Analysis</h3>
                            <div class="chart-container" style="height: 250px; position: relative;">
                                <canvas id="riskBarChart" width="300" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div class="dashboard-card">
                        <h3> Recent Activity</h3>
                        <div style="max-height: 300px; overflow-y: auto;">
                            ${(data.recentActivity || []).map(activity => `
                                <div style="padding: 10px; border-bottom: 1px solid #eee;">
                                    <div style="font-weight: bold; color: #667eea;">${activity.action}</div>
                                    <div style="color: #666; font-size: 0.9em;">${activity.details}</div>
                                    <div style="color: #999; font-size: 0.8em;">${new Date(activity.timestamp).toLocaleString()}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn btn-primary" onclick="exportDashboardData()">
                             Export Dashboard Data
                        </button>
                    </div>
                </div>
            `;
        }
        
        function downloadGuidelines() {
            if (currentSession) {
                window.location.href = `/download_guidelines?session_id=${currentSession}`;
            } else {
                showNotification('No active session', 'error');
            }
        }
        
        function downloadUserFeedback() {
            if (userFeedbackHistory.length === 0) {
                showNotification('No user feedback to download', 'info');
                return;
            }
            
            const feedbackData = {
                timestamp: new Date().toISOString(),
                session_id: currentSession,
                total_feedback: userFeedbackHistory.length,
                feedback_items: userFeedbackHistory
            };
            
            const blob = new Blob([JSON.stringify(feedbackData, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `User_Feedback_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showNotification('User feedback downloaded successfully!', 'success');
        }
        
        // Clear data on page unload/refresh
        window.addEventListener('beforeunload', function() {
            if (currentSession) {
                // Save dashboard data before leaving
                dashboardData.sessionsData.push({
                    session_id: currentSession,
                    timestamp: new Date().toISOString(),
                    sections_analyzed: sections.length,
                    chat_messages: chatHistory.length,
                    user_feedback: userFeedbackHistory.length
                });
                
                localStorage.setItem('aiPrismAnalyticsDashboard', JSON.stringify(dashboardData));
                navigator.sendBeacon('/reset_session', JSON.stringify({session_id: currentSession}));
            }
        });
        
        function deleteDocument() {
            if (confirm('Are you sure you want to delete the current document? Guidelines will be preserved.')) {
                fetch('/delete_document', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: currentSession, keep_guidelines: true })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification('Document deleted successfully. Guidelines preserved.', 'success');
                        // Reset UI but keep guidelines
                        document.getElementById('mainContent').style.display = 'none';
                        document.getElementById('statisticsPanel').style.display = 'none';
                        document.getElementById('actionButtons').style.display = 'none';
                        
                        // Reset variables
                        sections = [];
                        currentSectionIndex = 0;
                        window.sectionData = {};
                    } else {
                        showNotification(data.error || 'Delete failed', 'error');
                    }
                });
            }
        }
        
        function updateSpecificFeedback() {
            const currentSection = sections[currentSectionIndex];
            showModal('genericModal', 'Update Specific Feedback', `
                <div style="padding: 20px;">
                    <h4>Update Feedback for: ${currentSection}</h4>
                    <div style="margin: 20px 0;">
                        <label>Select feedback item to update:</label>
                        <select id="feedbackToUpdate" style="width: 100%; padding: 10px; margin: 10px 0;">
                            <option value="">Choose feedback item...</option>
                        </select>
                    </div>
                    <div style="margin: 20px 0;">
                        <label>New feedback text:</label>
                        <textarea id="updatedFeedbackText" style="width: 100%; height: 100px; padding: 10px; margin: 10px 0;" placeholder="Enter updated feedback..."></textarea>
                    </div>
                    <div style="text-align: center;">
                        <button class="btn btn-success" onclick="saveUpdatedFeedback()" style="margin: 10px;">
                             Save Update
                        </button>
                        <button class="btn btn-secondary" onclick="closeModal('genericModal')" style="margin: 10px;">
                             Cancel
                        </button>
                    </div>
                </div>
            `);
            
            // Populate feedback options
            const select = document.getElementById('feedbackToUpdate');
            const currentFeedback = window.sectionData?.[currentSection]?.feedback || [];
            currentFeedback.forEach((item, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${item.type.toUpperCase()}: ${item.description.substring(0, 50)}...`;
                select.appendChild(option);
            });
        }
        
        function reanalyzeAllSections() {
            if (confirm('This will re-analyze all sections with the current AI model. Continue?')) {
                closeModal('genericModal');
                startComprehensiveAnalysis();
            }
        }
        
        function provideFeedbackOnTool() {
            showModal('genericModal', ' Help Us Improve AI-Prism', `
                <div style="padding: 20px;">
                    <h3 style="color: #667eea; margin-bottom: 20px;">Your Feedback Matters!</h3>
                    <p>Help us make AI-Prism better for document analysis. Please share your thoughts:</p>
                    
                    <div style="margin: 20px 0;">
                        <label style="font-weight: bold;">What type of feedback?</label>
                        <select id="toolFeedbackType" style="width: 100%; padding: 10px; margin: 10px 0;">
                            <option value="feature">Feature Request</option>
                            <option value="bug">Bug Report</option>
                            <option value="improvement">Improvement Suggestion</option>
                            <option value="analysis">Document Analysis Quality</option>
                            <option value="ui">User Interface</option>
                            <option value="performance">Performance Issue</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    
                    <div style="margin: 20px 0;">
                        <label style="font-weight: bold;">Priority Level:</label>
                        <select id="toolFeedbackPriority" style="width: 100%; padding: 10px; margin: 10px 0;">
                            <option value="low">Low - Nice to have</option>
                            <option value="medium">Medium - Would be helpful</option>
                            <option value="high">High - Important for workflow</option>
                            <option value="critical">Critical - Blocking my work</option>
                        </select>
                    </div>
                    
                    <div style="margin: 20px 0;">
                        <label style="font-weight: bold;">Your Feedback:</label>
                        <textarea id="toolFeedbackText" style="width: 100%; height: 120px; padding: 10px; margin: 10px 0;" placeholder="Please describe your feedback, suggestion, or issue in detail..."></textarea>
                    </div>
                    
                    <div style="margin: 20px 0;">
                        <label style="font-weight: bold;">Contact Email (optional):</label>
                        <input type="email" id="toolFeedbackEmail" style="width: 100%; padding: 10px; margin: 10px 0;" placeholder="your.email@company.com">
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px;">
                        <button class="btn btn-success" onclick="submitToolFeedback()" style="margin: 10px; padding: 12px 30px;">
                             Submit Feedback
                        </button>
                        <button class="btn btn-secondary" onclick="closeModal('genericModal')" style="margin: 10px; padding: 12px 30px;">
                             Cancel
                        </button>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #f0f8ff; border-radius: 8px; font-size: 0.9em;">
                        <strong> Suggestion Areas:</strong><br>
                         Document analysis accuracy and depth<br>
                         New AI models or analysis frameworks<br>
                         User interface improvements<br>
                         Export and reporting features<br>
                         Integration with other tools<br>
                         Performance and speed enhancements
                    </div>
                </div>
            `);
        }
        
        function submitToolFeedback() {
            const type = document.getElementById('toolFeedbackType').value;
            const priority = document.getElementById('toolFeedbackPriority').value;
            const text = document.getElementById('toolFeedbackText').value.trim();
            const email = document.getElementById('toolFeedbackEmail').value.trim();
            
            if (!text) {
                showNotification('Please enter your feedback', 'error');
                return;
            }
            
            const feedbackData = {
                type: type,
                priority: priority,
                feedback: text,
                email: email,
                timestamp: new Date().toISOString(),
                session_id: currentSession,
                user_agent: navigator.userAgent,
                url: window.location.href
            };
            
            // Store feedback locally and send to server
            fetch('/submit_tool_feedback', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(feedbackData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Thank you for your feedback! We\'ll review it and work on improvements.', 'success');
                    closeModal('genericModal');
                } else {
                    showNotification('Feedback saved locally. Thank you for your input!', 'info');
                    closeModal('genericModal');
                }
            })
            .catch(error => {
                // Save locally even if server fails
                const localFeedback = JSON.parse(localStorage.getItem('aiPrismToolFeedback') || '[]');
                localFeedback.push(feedbackData);
                localStorage.setItem('aiPrismToolFeedback', JSON.stringify(localFeedback));
                
                showNotification('Feedback saved locally. Thank you for your input!', 'info');
                closeModal('genericModal');
            });
        }
        
        function downloadStatistics() {
            if (!currentSession) {
                showNotification('No active session', 'error');
                return;
            }
            
            fetch(`/get_statistics?session_id=${currentSession}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const statsData = {
                        timestamp: new Date().toISOString(),
                        session_id: currentSession,
                        document_name: sections.length > 0 ? 'Current Document' : 'No Document',
                        statistics: data.statistics,
                        sections_analyzed: sections.length,
                        chat_interactions: chatHistory.length,
                        user_feedback_count: userFeedbackHistory.length,
                        ai_model_used: currentAIModel,
                        session_duration: 'Active Session'
                    };
                    
                    const blob = new Blob([JSON.stringify(statsData, null, 2)], { type: 'application/json' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `AI-Prism_Statistics_${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    showNotification('Statistics downloaded successfully!', 'success');
                } else {
                    showNotification('Failed to get statistics', 'error');
                }
            })
            .catch(error => {
                showNotification('Download failed: ' + error.message, 'error');
            });
        }
        
        // Load dashboard data on page load
        window.addEventListener('load', function() {
            const savedData = localStorage.getItem('aiPrismAnalyticsDashboard');
            if (savedData) {
                dashboardData = JSON.parse(savedData);
            }
        });
    </script>
        <!-- Document Processing Progress -->
        <div class="document-progress" id="documentProgress">
            <img class="progress-gif" id="progressGif" src="" alt="Processing...">
            <div id="progressTitle" style="font-size: 1.3em; font-weight: bold; margin-bottom: 10px; color: #667eea;"> AI-Prism is analyzing your document...</div>
            <div id="progressDesc" style="color: #666; margin-bottom: 20px;">Please wait while I review every detail</div>
            <div style="width: 100%; height: 6px; background: #ecf0f1; border-radius: 3px; overflow: hidden;">
                <div style="height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); width: 100%; animation: pulse 2s infinite;"></div>
            </div>
        </div>

        <!-- Loading Overlay with Funny GIFs -->
        <div class="loading-overlay" id="loadingOverlay">
            <div class="loading-content">
                <img class="loading-gif" id="loadingGif" src="" alt="Loading...">
                <div class="loading-text" id="loadingText">AI-Prism is analyzing your document...</div>
                <div class="loading-subtext" id="loadingSubtext">Please wait while I review every detail </div>
            </div>
        </div>

        <!-- Analysis Progress Panel -->
        <div id="analysisProgressPanel" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); z-index: 1000; max-width: 600px; width: 90%;">
            <h3 style="text-align: center; margin-bottom: 20px; color: #667eea;"> Analyzing Document Sections</h3>
            <div id="progressBar" style="width: 100%; height: 8px; background: #ecf0f1; border-radius: 4px; overflow: hidden; margin-bottom: 15px;">
                <div style="height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); width: 0%; transition: width 0.3s ease;"></div>
            </div>
            <div id="progressText" style="text-align: center; font-weight: bold; margin-bottom: 5px;">Starting analysis...</div>
            <div id="progressSubtext" style="text-align: center; color: #666; font-size: 0.9em; margin-bottom: 20px;">Please wait...</div>
            <div id="sectionProgress" style="max-height: 300px; overflow-y: auto; background: #f8f9fa; padding: 15px; border-radius: 8px;">
                <!-- Section progress will be populated here -->
            </div>
            <img id="analysisGif" src="" alt="Analysis in progress" style="width: 100px; height: 100px; margin: 20px auto; display: block; border-radius: 10px;">
        </div>

        <!-- Custom Feedback Panel -->
        <div id="customFeedbackPanel" style="display: none;">
            <!-- Custom feedback content -->
        </div>

        <!-- Final Review Modal -->
        <div class="modal" id="finalReviewModal">
            <div class="modal-content" style="max-width: 1000px; max-height: 90vh;">
                <div class="modal-header">
                    <h3> Final Review Confirmation</h3>
                    <button class="modal-close" onclick="closeModal('finalReviewModal')">&times;</button>
                </div>
                <div id="finalReviewContent" style="max-height: 70vh; overflow-y: auto;">
                    <!-- Final review content will be populated here -->
                </div>
                <div style="text-align: center; margin-top: 20px; padding: 20px; border-top: 2px solid #eee;">
                    <button class="btn btn-success" onclick="confirmFinalDownload()" style="margin-right: 15px; padding: 12px 30px;">
                         Approve & Download
                    </button>
                    <button class="btn btn-secondary" onclick="closeModal('finalReviewModal')" style="padding: 12px 30px;">
                         Back to Review
                    </button>
                </div>
            </div>
        </div>
</body>
</html>
<body>
<html>
    <script>

        // Function to revert all feedback
        function revertAllFeedback() {
            if (!currentSession) {
                showNotification('No active session', 'error');
                return;
            }
            
            if (confirm('Are you sure you want to revert ALL feedback decisions? This will reset all accepted/rejected items.')) {
                fetch('/revert_all_feedback', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: currentSession })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification('All feedback reverted successfully!', 'success');
                        loadSection(currentSectionIndex);
                        updateStatistics();
                    } else {
                        showNotification(data.error || 'Revert failed', 'error');
                    }
                })
                .catch(error => {
                    showNotification('Revert failed: ' + error.message, 'error');
                });
            }
        }

        // Function to update feedback
        function updateFeedback() {
            showNotification('Feedback updated! Statistics refreshed.', 'success');
            updateStatistics();
        }

        // Function to show dashboard
        function showDashboard() {
            if (!currentSession) {
                showNotification('No active session', 'error');
                return;
            }
            
            fetch(`/get_dashboard_data?session_id=${currentSession}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const dashboard = data.dashboard;
                    const modalContent = `
                        <div style="max-height: 70vh; overflow-y: auto;">
                            <h3 style="color: #667eea; margin-bottom: 20px;"> Analytics Dashboard</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                                    <div style="font-size: 2.5em; font-weight: bold;">${dashboard.totalDocuments}</div>
                                    <div>Documents Analyzed</div>
                                </div>
                                <div style="background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                                    <div style="font-size: 2.5em; font-weight: bold;">${dashboard.acceptedFeedback}</div>
                                    <div>Accepted Feedback</div>
                                </div>
                                <div style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                                    <div style="font-size: 2.5em; font-weight: bold;">${dashboard.rejectedFeedback}</div>
                                    <div>Rejected Feedback</div>
                                </div>
                                <div style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                                    <div style="font-size: 2.5em; font-weight: bold;">${dashboard.userFeedback}</div>
                                    <div>User Added</div>
                                </div>
                            </div>
                        </div>
                    `;
                    showModal('genericModal', ' Analytics Dashboard', modalContent);
                } else {
                    showNotification('Failed to load dashboard data', 'error');
                }
            })
            .catch(error => {
                showNotification('Dashboard error: ' + error.message, 'error');
            });
        }

        // Function to delete document
        function deleteDocument() {
            if (!currentSession) {
                showNotification('No active session', 'error');
                return;
            }
            
            if (confirm('Are you sure you want to delete the current document? Guidelines will be preserved.')) {
                fetch('/delete_document', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        session_id: currentSession,
                        keep_guidelines: true 
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification('Document deleted successfully! Guidelines preserved.', 'success');
                        document.getElementById('mainContent').style.display = 'none';
                        document.getElementById('statisticsPanel').style.display = 'none';
                        document.getElementById('actionButtons').style.display = 'none';
                        document.getElementById('analysisFileName').textContent = '';
                        document.getElementById('startAnalysisBtn').disabled = true;
                    } else {
                        showNotification(data.error || 'Delete failed', 'error');
                    }
                })
                .catch(error => {
                    showNotification('Delete failed: ' + error.message, 'error');
                });
            }
        }

        // Function to provide feedback on tool
        function provideFeedbackOnTool() {
            const modalContent = `
                <div style="padding: 20px;">
                    <h3 style="color: #667eea; margin-bottom: 20px;"> Help Us Improve AI-Prism</h3>
                    <div style="margin-bottom: 15px;">
                        <label style="font-weight: bold; margin-bottom: 5px; display: block;">How would you rate your experience?</label>
                        <select id="toolRating" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                            <option value="5"> Excellent</option>
                            <option value="4"> Good</option>
                            <option value="3"> Average</option>
                            <option value="2"> Poor</option>
                            <option value="1"> Very Poor</option>
                        </select>
                    </div>
                    <div style="text-align: center;">
                        <button class="btn btn-success" onclick="submitToolFeedback()" style="margin: 5px;"> Submit Feedback</button>
                        <button class="btn btn-secondary" onclick="closeModal('genericModal')" style="margin: 5px;"> Cancel</button>
                    </div>
                </div>
            `;
            showModal('genericModal', 'Tool Feedback', modalContent);
        }

        function submitToolFeedback() {
            const rating = document.getElementById('toolRating').value;
            const feedbackData = {
                rating: rating,
                timestamp: new Date().toISOString(),
                session_id: currentSession
            };
            
            fetch('/submit_tool_feedback', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(feedbackData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Thank you for your feedback!', 'success');
                    closeModal('genericModal');
                } else {
                    showNotification('Failed to submit feedback.', 'error');
                }
            })
            .catch(error => {
                showNotification('Feedback submission failed: ' + error.message, 'error');
            });
        }

        // Function to complete review
        function completeReview() {
            if (!currentSession) {
                showNotification('No active session', 'error');
                return;
            }
            
            if (confirm('Complete the review and generate the final document with comments?')) {
                showProgress('Generating final document...');
                
                fetch('/complete_review', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: currentSession })
                })
                .then(response => response.json())
                .then(data => {
                    hideProgress();
                    if (data.success) {
                        showNotification(`Review completed! Document generated with ${data.comments_count} comments.`, 'success');
                        const downloadBtn = document.getElementById('downloadBtn');
                        if (downloadBtn) {
                            downloadBtn.disabled = false;
                            downloadBtn.setAttribute('data-filename', data.output_file);
                        }
                        finalDocumentData = data;
                    } else {
                        showNotification(data.error || 'Review completion failed', 'error');
                    }
                })
                .catch(error => {
                    hideProgress();
                    showNotification('Review completion failed: ' + error.message, 'error');
                });
            }
        }

        // Function to export chat history
        function exportChatHistory() {
            if (chatHistory.length === 0) {
                showNotification('No chat history to export', 'info');
                return;
            }
            
            const exportData = {
                export_timestamp: new Date().toISOString(),
                session_id: currentSession,
                total_messages: chatHistory.length,
                chat_history: chatHistory
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ai_prism_chat_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showNotification('Chat history exported successfully!', 'success');
        }

        // Function to download guidelines
        function downloadGuidelines() {
            if (!currentSession) {
                showNotification('No active session', 'error');
                return;
            }
            
            window.location.href = `/download_guidelines?session_id=${currentSession}`;
            showNotification('Downloading guidelines...', 'info');
        }

        // Function to export statistics
        function exportStatistics(statType) {
            if (!currentSession) {
                showNotification('No active session', 'error');
                return;
            }
            
            const exportData = {
                export_timestamp: new Date().toISOString(),
                session_id: currentSession,
                stat_type: statType,
                statistics: 'Exported from breakdown view'
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${statType}_statistics_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showNotification(`${statType.replace('_', ' ')} statistics exported!`, 'success');
        }

        function hideProgress() {
            const progressContainer = document.getElementById('progressContainer');
            const docProgress = document.getElementById('documentProgress');
            
            if (progressContainer) {
                progressContainer.style.display = 'none';
            }
            
            if (docProgress) {
                docProgress.style.display = 'none';
                stopMediaRotation();
            }
        }

        function startMediaRotation() {
            if (isMediaRotating) return;
            
            isMediaRotating = true;
            currentMediaIndex = 0;
            usedMediaIndices = [];
            
            rotateMedia();
            mediaRotationInterval = setInterval(rotateMedia, 5000);
        }

        function stopMediaRotation() {
            if (mediaRotationInterval) {
                clearInterval(mediaRotationInterval);
                mediaRotationInterval = null;
            }
            isMediaRotating = false;
        }

        function rotateMedia() {
            if (!showGraphics || loadingMediaWithContent.length === 0) return;
            
            if (usedMediaIndices.length >= loadingMediaWithContent.length) {
                usedMediaIndices = [];
            }
            
            let nextIndex;
            do {
                nextIndex = Math.floor(Math.random() * loadingMediaWithContent.length);
            } while (usedMediaIndices.includes(nextIndex));
            
            usedMediaIndices.push(nextIndex);
            currentMediaIndex = nextIndex;
            
            const media = loadingMediaWithContent[currentMediaIndex];
            const progressGif = document.getElementById('progressGif');
            const progressTitle = document.getElementById('progressTitle');
            const progressDesc = document.getElementById('progressDesc');
            
            if (progressGif && media.gif) {
                progressGif.src = media.gif;
                progressGif.onerror = function() {
                    this.style.display = 'none';
                };
            }
            
            const contentTypes = ['gif', 'joke', 'math'];
            const currentType = contentTypes[Math.floor(Math.random() * contentTypes.length)];
            
            if (progressDesc && media[currentType]) {
                progressDesc.textContent = media[currentType];
            }
        }
    </script>
</body>
</html>