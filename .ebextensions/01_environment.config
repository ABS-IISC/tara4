# Elastic Beanstalk Environment Configuration
# AI-Prism Flask Application with Claude Multi-Model Fallback

option_settings:
  # ============================================
  # INSTANCE CONFIGURATION - OPTIMIZED FOR 100+ USERS
  # ============================================
  aws:autoscaling:launchconfiguration:
    InstanceType: t3.large  # 2 vCPU, 8 GB RAM (upgraded for more concurrent requests)
    IamInstanceProfile: aws-elasticbeanstalk-ec2-role
    RootVolumeType: gp3
    RootVolumeSize: 30  # Increased for more logs
    RootVolumeIOPS: 3000

  # ============================================
  # AUTO SCALING - OPTIMIZED FOR HIGH TRAFFIC
  # ============================================
  aws:autoscaling:asg:
    MinSize: 3  # Minimum 3 instances for 100+ users
    MaxSize: 15  # Scale up to 15 instances for peak traffic
    Cooldown: 180  # 3 minutes cooldown (faster scaling)

  aws:autoscaling:trigger:
    MeasureName: CPUUtilization
    Statistic: Average
    Unit: Percent
    UpperThreshold: 70  # Scale up at 70% CPU (more aggressive)
    UpperBreachScaleIncrement: 2  # Add 2 instances at once
    LowerThreshold: 30  # Scale down at 30% CPU
    LowerBreachScaleIncrement: -1  # Remove 1 instance at a time
    Period: 3  # Check every 3 minutes
    BreachDuration: 3  # Trigger after 3 minutes
    EvaluationPeriods: 1

  # ============================================
  # ENVIRONMENT TYPE
  # ============================================
  aws:elasticbeanstalk:environment:
    EnvironmentType: LoadBalanced
    LoadBalancerType: application
    ServiceRole: aws-elasticbeanstalk-service-role

  # ============================================
  # LOAD BALANCER - OPTIMIZED FOR CONCURRENT CLAUDE API CALLS
  # ============================================
  aws:elbv2:loadbalancer:
    IdleTimeout: 600  # 10 minutes for long Claude API calls (increased from 5min)

  aws:elbv2:listener:default:
    ListenerEnabled: true
    Protocol: HTTP

  # Target group settings for handling concurrent requests
  aws:elbv2:listener:443:
    Protocol: HTTP
    Rules: ""

  # ============================================
  # HEALTH REPORTING
  # ============================================
  aws:elasticbeanstalk:healthreporting:system:
    SystemType: enhanced
    EnhancedHealthAuthEnabled: true

  # ============================================
  # APPLICATION HEALTH CHECK
  # ============================================
  aws:elasticbeanstalk:application:
    Application Healthcheck URL: /health

  aws:elasticbeanstalk:environment:process:default:
    HealthCheckPath: /health
    HealthCheckInterval: 30
    HealthCheckTimeout: 5
    UnhealthyThresholdCount: 3
    HealthyThresholdCount: 2
    Port: 80
    Protocol: HTTP
    DeregistrationDelay: 20
    StickinessEnabled: true
    StickinessLBCookieDuration: 86400  # 24 hours

  # ============================================
  # DEPLOYMENT POLICY
  # ============================================
  aws:elasticbeanstalk:command:
    DeploymentPolicy: RollingWithAdditionalBatch
    BatchSizeType: Fixed
    BatchSize: 1  # Deploy to 1 instance at a time
    Timeout: 600  # 10 minutes timeout
    IgnoreHealthCheck: false

  # ============================================
  # ROLLING UPDATES
  # ============================================
  aws:autoscaling:updatepolicy:rollingupdate:
    RollingUpdateEnabled: true
    RollingUpdateType: Health
    MinInstancesInService: 1
    MaxBatchSize: 1
    PauseTime: PT5M  # 5 minutes pause between batches

  # ============================================
  # CLOUDWATCH LOGS
  # ============================================
  aws:elasticbeanstalk:cloudwatch:logs:
    StreamLogs: true
    DeleteOnTerminate: false
    RetentionInDays: 7

  aws:elasticbeanstalk:cloudwatch:logs:health:
    HealthStreamingEnabled: true
    DeleteOnTerminate: false
    RetentionInDays: 7

  # ============================================
  # ENVIRONMENT VARIABLES
  # ============================================
  aws:elasticbeanstalk:application:environment:
    # Flask Configuration
    FLASK_ENV: production
    FLASK_APP: app.py
    PORT: "8000"

    # ============================================
    # AWS REGION CONFIGURATION (REGION-AGNOSTIC)
    # ============================================
    # The application automatically detects the deployment region.
    # You can override by setting these variables, or leave them unset for auto-detection.
    #
    # IMPORTANT: Update these values when deploying to a different region:
    # - AWS_REGION: Your deployment region (e.g., us-east-1, eu-west-1, ap-southeast-1)
    # - S3_REGION: Region where your S3 bucket is located
    # - S3_BUCKET_NAME: Your S3 bucket name (must be globally unique)
    #
    # The application supports ALL AWS regions with Bedrock:
    # US: us-east-1, us-west-2
    # Europe: eu-central-1, eu-west-1, eu-west-2, eu-west-3
    # Asia Pacific: ap-south-1, ap-northeast-1, ap-southeast-1, ap-southeast-2
    # Other: ca-central-1, sa-east-1
    #
    # Model IDs are automatically selected based on region.
    # ============================================

    # AWS Configuration (update for your region)
    AWS_REGION: eu-north-1
    AWS_DEFAULT_REGION: eu-north-1

    # Bedrock Configuration
    # Note: Model ID is auto-selected based on region by config/aws_regions.py
    # Override only if you need a specific model
    BEDROCK_MODEL_ID: anthropic.claude-sonnet-4-5-20250929-v1:0
    BEDROCK_MAX_TOKENS: "4096"
    BEDROCK_TEMPERATURE: "0.7"
    REASONING_ENABLED: "false"

    # Redis/RQ Configuration
    # ElastiCache Redis for session storage and task queue
    # CRITICAL: Required for multi-worker session sharing
    REDIS_URL: "redis://ai-prism-redis.5ubcga.0001.eun1.cache.amazonaws.com:6379/0"

    # S3 Configuration (update for your bucket and region)
    # IMPORTANT: S3 bucket and its region MUST match
    # S3 Path: s3://ai.prism/Logs and data/
    S3_BUCKET_NAME: ai.prism
    S3_BASE_PATH: Logs and data/
    S3_REGION: eu-north-1

    # Application Configuration
    MAX_CONTENT_LENGTH: "16777216"  # 16 MB
    SESSION_TIMEOUT: "3600"  # 1 hour

    # Multi-Model Configuration
    ENABLE_MODEL_FALLBACK: "true"
    CHAT_ENABLE_MULTI_MODEL: "true"

  # ============================================
  # MANAGED UPDATES
  # ============================================
  aws:elasticbeanstalk:managedactions:
    ManagedActionsEnabled: true
    PreferredStartTime: "Sun:03:00"  # Sunday 3 AM UTC
    ServiceRoleForManagedUpdates: aws-elasticbeanstalk-service-role

  aws:elasticbeanstalk:managedactions:platformupdate:
    UpdateLevel: minor  # Automatic minor version updates
    InstanceRefreshEnabled: true
