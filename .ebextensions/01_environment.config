# Elastic Beanstalk Environment Configuration
# AI-Prism Flask Application with Claude Multi-Model Fallback

option_settings:
  # ============================================
  # INSTANCE CONFIGURATION - OPTIMIZED FOR 100+ USERS
  # ============================================
  aws:autoscaling:launchconfiguration:
    InstanceType: t3.large  # 2 vCPU, 8 GB RAM (upgraded for more concurrent requests)
    IamInstanceProfile: aws-elasticbeanstalk-ec2-role
    RootVolumeType: gp3
    RootVolumeSize: 30  # Increased for more logs
    RootVolumeIOPS: 3000

  # ============================================
  # AUTO SCALING - OPTIMIZED FOR HIGH TRAFFIC
  # ============================================
  aws:autoscaling:asg:
    MinSize: 3  # Minimum 3 instances for 100+ users
    MaxSize: 15  # Scale up to 15 instances for peak traffic
    Cooldown: 180  # 3 minutes cooldown (faster scaling)

  aws:autoscaling:trigger:
    MeasureName: CPUUtilization
    Statistic: Average
    Unit: Percent
    UpperThreshold: 70  # Scale up at 70% CPU (more aggressive)
    UpperBreachScaleIncrement: 2  # Add 2 instances at once
    LowerThreshold: 30  # Scale down at 30% CPU
    LowerBreachScaleIncrement: -1  # Remove 1 instance at a time
    Period: 3  # Check every 3 minutes
    BreachDuration: 3  # Trigger after 3 minutes
    EvaluationPeriods: 1

  # ============================================
  # ENVIRONMENT TYPE
  # ============================================
  aws:elasticbeanstalk:environment:
    EnvironmentType: LoadBalanced
    LoadBalancerType: application
    ServiceRole: aws-elasticbeanstalk-service-role

  # ============================================
  # LOAD BALANCER - OPTIMIZED FOR CONCURRENT CLAUDE API CALLS
  # ============================================
  aws:elbv2:loadbalancer:
    IdleTimeout: 600  # 10 minutes for long Claude API calls (increased from 5min)

  aws:elbv2:listener:default:
    ListenerEnabled: true
    Protocol: HTTP

  # Target group settings for handling concurrent requests
  aws:elbv2:listener:443:
    Protocol: HTTP
    Rules: ""

  # ============================================
  # HEALTH REPORTING
  # ============================================
  aws:elasticbeanstalk:healthreporting:system:
    SystemType: enhanced
    EnhancedHealthAuthEnabled: true

  # ============================================
  # APPLICATION HEALTH CHECK
  # ============================================
  aws:elasticbeanstalk:application:
    Application Healthcheck URL: /health

  aws:elasticbeanstalk:environment:process:default:
    HealthCheckPath: /health
    HealthCheckInterval: 30
    HealthCheckTimeout: 5
    UnhealthyThresholdCount: 3
    HealthyThresholdCount: 2
    Port: 80
    Protocol: HTTP
    DeregistrationDelay: 20
    StickinessEnabled: true
    StickinessLBCookieDuration: 86400  # 24 hours

  # ============================================
  # DEPLOYMENT POLICY
  # ============================================
  aws:elasticbeanstalk:command:
    DeploymentPolicy: RollingWithAdditionalBatch
    BatchSizeType: Fixed
    BatchSize: 1  # Deploy to 1 instance at a time
    Timeout: 600  # 10 minutes timeout
    IgnoreHealthCheck: false

  # ============================================
  # ROLLING UPDATES
  # ============================================
  aws:autoscaling:updatepolicy:rollingupdate:
    RollingUpdateEnabled: true
    RollingUpdateType: Health
    MinInstancesInService: 1
    MaxBatchSize: 1
    PauseTime: PT5M  # 5 minutes pause between batches

  # ============================================
  # CLOUDWATCH LOGS
  # ============================================
  aws:elasticbeanstalk:cloudwatch:logs:
    StreamLogs: true
    DeleteOnTerminate: false
    RetentionInDays: 7

  aws:elasticbeanstalk:cloudwatch:logs:health:
    HealthStreamingEnabled: true
    DeleteOnTerminate: false
    RetentionInDays: 7

  # ============================================
  # ENVIRONMENT VARIABLES
  # ============================================
  aws:elasticbeanstalk:application:environment:
    # Flask Configuration
    FLASK_ENV: production
    FLASK_APP: app.py
    PORT: "8000"

    # AWS Configuration
    AWS_REGION: eu-north-1
    AWS_DEFAULT_REGION: eu-north-1

    # Bedrock Configuration
    BEDROCK_MODEL_ID: anthropic.claude-sonnet-4-5-20250929-v1:0
    BEDROCK_MAX_TOKENS: "4096"
    BEDROCK_TEMPERATURE: "0.7"
    REASONING_ENABLED: "false"

    # Redis/RQ Configuration
    # Set to "disabled" if not using Redis/ElastiCache
    # Or set to redis://host:port/0 if using ElastiCache
    REDIS_URL: "disabled"

    # S3 Configuration
    S3_BUCKET_NAME: ai-prism-logs-600222957378-eu
    S3_BASE_PATH: Logs and data/
    S3_REGION: eu-north-1

    # Application Configuration
    MAX_CONTENT_LENGTH: "16777216"  # 16 MB
    SESSION_TIMEOUT: "3600"  # 1 hour

    # Multi-Model Configuration
    ENABLE_MODEL_FALLBACK: "true"
    CHAT_ENABLE_MULTI_MODEL: "true"

  # ============================================
  # MANAGED UPDATES
  # ============================================
  aws:elasticbeanstalk:managedactions:
    ManagedActionsEnabled: true
    PreferredStartTime: "Sun:03:00"  # Sunday 3 AM UTC
    ServiceRoleForManagedUpdates: aws-elasticbeanstalk-service-role

  aws:elasticbeanstalk:managedactions:platformupdate:
    UpdateLevel: minor  # Automatic minor version updates
    InstanceRefreshEnabled: true
