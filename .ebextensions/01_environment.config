# Elastic Beanstalk Environment Configuration
# AI-Prism Flask Application with Claude Multi-Model Fallback

option_settings:
  # ============================================
  # INSTANCE CONFIGURATION
  # ============================================
  aws:autoscaling:launchconfiguration:
    InstanceType: t3.medium  # 2 vCPU, 4 GB RAM
    IamInstanceProfile: aws-elasticbeanstalk-ec2-role
    RootVolumeType: gp3
    RootVolumeSize: 20
    RootVolumeIOPS: 3000

  # ============================================
  # AUTO SCALING
  # ============================================
  aws:autoscaling:asg:
    MinSize: 2  # Minimum 2 instances for HA
    MaxSize: 10  # Scale up to 10 instances
    Cooldown: 360  # 6 minutes cooldown

  aws:autoscaling:trigger:
    MeasureName: CPUUtilization
    Statistic: Average
    Unit: Percent
    UpperThreshold: 75  # Scale up at 75% CPU
    UpperBreachScaleIncrement: 1
    LowerThreshold: 25  # Scale down at 25% CPU
    LowerBreachScaleIncrement: -1
    Period: 5
    BreachDuration: 5
    EvaluationPeriods: 1

  # ============================================
  # ENVIRONMENT TYPE
  # ============================================
  aws:elasticbeanstalk:environment:
    EnvironmentType: LoadBalanced
    LoadBalancerType: application
    ServiceRole: aws-elasticbeanstalk-service-role

  # ============================================
  # LOAD BALANCER
  # ============================================
  aws:elbv2:loadbalancer:
    IdleTimeout: 300  # 5 minutes for long Claude API calls

  aws:elbv2:listener:default:
    ListenerEnabled: true
    Protocol: HTTP

  # ============================================
  # HEALTH REPORTING
  # ============================================
  aws:elasticbeanstalk:healthreporting:system:
    SystemType: enhanced
    EnhancedHealthAuthEnabled: true

  # ============================================
  # APPLICATION HEALTH CHECK
  # ============================================
  aws:elasticbeanstalk:application:
    Application Healthcheck URL: /health

  aws:elasticbeanstalk:environment:process:default:
    HealthCheckPath: /health
    HealthCheckInterval: 30
    HealthCheckTimeout: 5
    UnhealthyThresholdCount: 3
    HealthyThresholdCount: 2
    Port: 80
    Protocol: HTTP
    DeregistrationDelay: 20
    StickinessEnabled: true
    StickinessLBCookieDuration: 86400  # 24 hours

  # ============================================
  # DEPLOYMENT POLICY
  # ============================================
  aws:elasticbeanstalk:command:
    DeploymentPolicy: RollingWithAdditionalBatch
    BatchSizeType: Fixed
    BatchSize: 1  # Deploy to 1 instance at a time
    Timeout: 600  # 10 minutes timeout
    IgnoreHealthCheck: false

  # ============================================
  # ROLLING UPDATES
  # ============================================
  aws:autoscaling:updatepolicy:rollingupdate:
    RollingUpdateEnabled: true
    RollingUpdateType: Health
    MinInstancesInService: 1
    MaxBatchSize: 1
    PauseTime: PT5M  # 5 minutes pause between batches

  # ============================================
  # CLOUDWATCH LOGS
  # ============================================
  aws:elasticbeanstalk:cloudwatch:logs:
    StreamLogs: true
    DeleteOnTerminate: false
    RetentionInDays: 7

  aws:elasticbeanstalk:cloudwatch:logs:health:
    HealthStreamingEnabled: true
    DeleteOnTerminate: false
    RetentionInDays: 7

  # ============================================
  # ENVIRONMENT VARIABLES
  # ============================================
  aws:elasticbeanstalk:application:environment:
    # Flask Configuration
    FLASK_ENV: production
    FLASK_APP: app.py
    PORT: "8000"

    # AWS Configuration
    AWS_REGION: us-east-1
    AWS_DEFAULT_REGION: us-east-1

    # Bedrock Configuration
    BEDROCK_MODEL_ID: us.anthropic.claude-sonnet-4-5-20250929-v1:0
    BEDROCK_MAX_TOKENS: "4096"
    BEDROCK_TEMPERATURE: "0.7"
    REASONING_ENABLED: "false"

    # Redis/RQ Configuration
    # Set to "disabled" if not using Redis/ElastiCache
    # Or set to redis://host:port/0 if using ElastiCache
    REDIS_URL: "disabled"

    # S3 Configuration
    S3_BUCKET_NAME: felix-s3-bucket
    S3_BASE_PATH: tara/
    S3_REGION: us-east-1

    # Application Configuration
    MAX_CONTENT_LENGTH: "16777216"  # 16 MB
    SESSION_TIMEOUT: "3600"  # 1 hour

    # Multi-Model Configuration
    ENABLE_MODEL_FALLBACK: "true"
    CHAT_ENABLE_MULTI_MODEL: "true"

  # ============================================
  # MANAGED UPDATES
  # ============================================
  aws:elasticbeanstalk:managedactions:
    ManagedActionsEnabled: true
    PreferredStartTime: "Sun:03:00"  # Sunday 3 AM UTC
    ServiceRoleForManagedUpdates: aws-elasticbeanstalk-service-role

  aws:elasticbeanstalk:managedactions:platformupdate:
    UpdateLevel: minor  # Automatic minor version updates
    InstanceRefreshEnabled: true
